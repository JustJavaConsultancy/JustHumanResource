<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                    secondary: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                },
                fontFamily: { 'sans': ['"DM Sans"', 'system-ui', 'sans-serif'], 'mono': ['"DM Mono"', 'monospace'] }
            }
        }
    };
  </script>
  <style>
    * { font-family: 'DM Sans', sans-serif; }
    body { overflow-x: clip; }

    /* ── Sidebar ── */
    .sidebar-item { transition: all 0.18s ease; position: relative; }
    .sidebar-item.active { background-color: rgba(37,99,235,0.08); color: #2563eb; border-left: 3px solid #2563eb; }
    .sidebar-item.active .material-icons-round { color: #2563eb; }
    .dark .sidebar-item.active { background-color: rgba(59,130,246,0.18); }
    .sidebar-container { position: fixed; top: 0; left: 0; height: 100vh; width: 16rem; z-index: 40; overflow-y: auto; }
    .main-content { margin-left: 16rem; width: calc(100% - 16rem); min-height: 100vh; }
    @media (max-width: 1023px) {
        .sidebar-container { transform: translateX(-100%); transition: transform 0.25s; }
        .sidebar-container.open { transform: translateX(0); }
        .main-content { margin-left: 0; width: 100%; }
    }

    /* ── Badges ── */
    .badge { padding: 2px 9px; font-size: 0.72rem; font-weight: 600; border-radius: 9999px; letter-spacing: 0.01em; }
    .badge-success { background-color: #dcfce7; color: #15803d; }
    .badge-info    { background-color: #dbeafe; color: #1d4ed8; }
    .badge-orange  { background-color: #ffedd5; color: #c2410c; }
    .badge-red     { background-color: #fee2e2; color: #b91c1c; }

    /* ── Org chart ── */
    .connector-v { width: 2px; height: 24px; background: #cbd5e1; margin: 3px auto; }
    .dark .connector-v { background: #475569; }
    .v-up { width: 2px; height: 20px; background: #cbd5e1; margin-bottom: 2px; }
    .dark .v-up { background: #475569; }
    .org-node-wrap { display: flex; flex-direction: column; align-items: center; position: relative; padding: 0 10px; }
    .org-children-row { display: flex; align-items: flex-start; justify-content: center; position: relative; gap: 16px; }
    .connector-h-line { position: absolute; top: 0; height: 2px; background: #cbd5e1; z-index: 0; pointer-events: none; }
    .dark .connector-h-line { background: #475569; }
    .org-node { transition: all 0.18s ease; cursor: pointer; min-width: 148px; position: relative; z-index: 1; }
    .org-node:hover { border-color: #3b82f6 !important; box-shadow: 0 8px 24px -8px rgba(59,130,246,0.35); transform: translateY(-2px); }

    /* ── Modal ── */
    .modal-backdrop { background: rgba(0,0,0,0.45); backdrop-filter: blur(5px); }
    .modal-card { animation: scaleIn 0.18s ease-out; }
    @keyframes scaleIn { from { opacity:0; transform:scale(0.94) translateY(6px); } to { opacity:1; transform:scale(1) translateY(0); } }

    /* ── Form ── */
    .form-input, .form-select {
        border: 1.5px solid #e2e8f0; border-radius: 0.55rem; padding: 0.58rem 0.8rem;
        width: 100%; transition: border-color 0.18s, box-shadow 0.18s;
        background: white; font-size: 0.875rem;
    }
    .dark .form-input, .dark .form-select { background: #1e293b; border-color: #334155; color: #f1f5f9; }
    .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); }
    .form-label { font-size: 0.8rem; font-weight: 600; color: #475569; margin-bottom: 4px; display: block; letter-spacing: 0.01em; }
    .dark .form-label { color: #94a3b8; }

    /* ── Toast ── */
    #toast { transition: opacity 0.25s, transform 0.25s; }
    #toast.hidden { opacity: 0; pointer-events: none; transform: translateY(8px); }

    /* ── API state banners ── */
    .api-error { background: #fef2f2; border: 1px solid #fca5a5; color: #b91c1c; border-radius: 0.5rem; padding: 0.6rem 0.9rem; font-size: 0.8rem; }
    .dark .api-error { background: #450a0a; border-color: #7f1d1d; color: #fca5a5; }

    /* ── Reporting tree viz ── */
    .rep-node { border-left: 2px solid #3b82f6; padding-left: 12px; margin-left: 8px; }
    .rep-root { border-left: none; padding-left: 0; margin-left: 0; }

    /* ── Skeleton ── */
    .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size: 200%; animation: shimmer 1.4s infinite; border-radius: 6px; }
    @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

    /* ── Custom scrollbar ── */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }

    /* ── Code font for codes ── */
    .code-tag { font-family: 'DM Mono', monospace; font-size: 0.72rem; background: #f1f5f9; padding: 1px 6px; border-radius: 4px; color: #475569; }
    .dark .code-tag { background: #334155; color: #94a3b8; }
  </style>
</head>
<body>
<main layout:fragment="content" class="flex-1 p-4 md:p-6 overflow-y-auto">

  <!-- Stats Row -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-7" id="statsRow">
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5 shadow-sm">
      <div class="flex items-center gap-3 mb-3"><div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg"><span class="material-icons-round text-blue-600 dark:text-blue-400 text-[20px]">business</span></div></div>
      <h3 class="text-2xl font-bold" id="statCompanies">—</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Companies</p>
      <div class="mt-1 text-xs text-gray-400" id="statCompanySub">Loading…</div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5 shadow-sm">
      <div class="flex items-center gap-3 mb-3"><div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg"><span class="material-icons-round text-green-600 dark:text-green-400 text-[20px]">layers</span></div></div>
      <h3 class="text-2xl font-bold" id="statDepts">—</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Departments</p>
      <div class="mt-1 text-xs text-gray-400" id="statDeptSub">Loading…</div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5 shadow-sm">
      <div class="flex items-center gap-3 mb-3"><div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg"><span class="material-icons-round text-purple-600 dark:text-purple-400 text-[20px]">people</span></div></div>
      <h3 class="text-2xl font-bold" id="statEmps">—</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Employees mapped</p>
      <div class="mt-1 text-xs text-gray-400">From department tree</div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5 shadow-sm">
      <div class="flex items-center gap-3 mb-3"><div class="p-2 bg-orange-100 dark:bg-orange-900/30 rounded-lg"><span class="material-icons-round text-orange-600 dark:text-orange-400 text-[20px]">share</span></div></div>
      <h3 class="text-2xl font-bold" id="statLines">—</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Reporting lines</p>
      <div class="mt-1 text-xs text-gray-400">Primary + matrix</div>
    </div>
  </div>

  <!-- ORG CHART CARD -->
  <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-md mb-7">
    <div class="flex flex-wrap items-center justify-between gap-3 p-5 border-b border-gray-200 dark:border-gray-700">
      <div>
        <h3 class="font-bold text-base">Department Tree</h3>
        <p class="text-xs text-gray-500 mt-0.5">Live from <span class="code-tag">GET /departments/tree</span> · Click node for details</p>
      </div>
      <div class="flex items-center gap-3">
        <span id="chartLiveBadge" class="badge badge-info text-[10px] flex items-center gap-1"><span class="w-1.5 h-1.5 bg-blue-400 rounded-full"></span>Loading</span>
        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-1 flex gap-1">
          <button id="chartViewBtn" class="px-3 py-1.5 text-xs font-medium rounded flex items-center gap-1 bg-white dark:bg-gray-800 shadow-sm text-primary-600" onclick="setView('chart')"><span class="material-icons-round text-sm">account_tree</span> Chart</button>
          <button id="listViewBtn" class="px-3 py-1.5 text-xs font-medium rounded flex items-center gap-1 text-gray-600 dark:text-gray-300" onclick="setView('list')"><span class="material-icons-round text-sm">format_list_bulleted</span> List</button>
        </div>
      </div>
    </div>

    <!-- Node detail panel -->
    <div id="nodeDetail" class="mx-5 mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl hidden">
      <div class="flex items-start gap-4">
        <div class="w-11 h-11 rounded-xl bg-primary-600 text-white flex items-center justify-center text-sm font-bold font-mono" id="ndAvatar">—</div>
        <div class="flex-1">
          <div class="flex justify-between items-start">
            <div><h4 class="font-bold" id="ndName">—</h4><p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5" id="ndMeta">—</p></div>
            <button onclick="closeDetail()" class="text-gray-400 hover:text-gray-600 ml-4"><span class="material-icons-round text-lg">close</span></button>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-3">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-2 text-center border border-gray-100 dark:border-gray-700"><span class="font-bold text-primary-600 text-lg" id="ndEmp">—</span><div class="text-[10px] text-gray-500">Employees</div></div>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-2 text-center border border-gray-100 dark:border-gray-700"><span class="font-bold text-primary-600 text-lg" id="ndSub">—</span><div class="text-[10px] text-gray-500">Sub-depts</div></div>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-2 text-center border border-gray-100 dark:border-gray-700"><span class="code-tag" id="ndCode">—</span><div class="text-[10px] text-gray-500 mt-0.5">Code</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart view -->
    <div id="orgChartView" style="overflow-x:auto;overflow-y:visible;-webkit-overflow-scrolling:touch;">
      <div id="orgTree" style="display:inline-flex;flex-direction:column;align-items:center;min-width:max-content;padding:24px 60px 32px;">
        <div class="flex gap-4 mt-4">
          <div class="skeleton w-40 h-28 rounded-xl"></div>
          <div class="skeleton w-40 h-28 rounded-xl"></div>
          <div class="skeleton w-40 h-28 rounded-xl"></div>
        </div>
      </div>
    </div>

    <!-- List view -->
    <div id="orgListView" class="p-5 hidden">
      <table class="w-full text-sm">
        <thead class="bg-gray-50 dark:bg-gray-750">
        <tr class="text-left">
          <th class="p-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Department</th>
          <th class="p-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Code</th>
          <th class="p-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Parent</th>
          <th class="p-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Status</th>
          <th class="p-3"></th>
        </tr>
        </thead>
        <tbody id="deptTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- 4-column lower panels -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">

    <!-- Company Structure -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-md overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <div>
          <h4 class="font-bold text-sm">Company Structure</h4>
          <p class="text-[10px] text-gray-400 font-mono mt-0.5">GET /companies/tree</p>
        </div>
        <button onclick="openModal('companyModal')" class="px-2.5 py-1.5 bg-primary-600 text-white rounded-lg text-xs font-medium flex items-center gap-1 hover:bg-primary-700 transition"><span class="material-icons-round text-sm">add</span> Add</button>
      </div>
      <div class="p-4" id="companyTreePanel">
        <div class="skeleton h-8 rounded mb-3 w-3/4"></div>
        <div class="skeleton h-7 rounded mb-2 w-2/3 ml-6"></div>
        <div class="skeleton h-7 rounded w-2/3 ml-6"></div>
      </div>
    </div>

    <!-- Reporting Lines actions card -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-md overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <div>
          <h4 class="font-bold text-sm">Reporting Lines</h4>
          <p class="text-[10px] text-gray-400 font-mono mt-0.5">POST &amp; PUT /reporting/*</p>
        </div>
      </div>
      <div class="p-4 space-y-3">
        <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed">Manage who reports to whom. Assign primary or matrix reporting lines, or end an existing one.</p>
        <div class="space-y-2">
          <button onclick="openModal('reportModal')" class="w-full flex items-center gap-3 px-3 py-2.5 bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-xl hover:bg-primary-100 transition group">
            <span class="w-8 h-8 rounded-lg bg-primary-600 text-white flex items-center justify-center flex-shrink-0"><span class="material-icons-round text-[18px]">supervisor_account</span></span>
            <div class="text-left">
              <p class="text-sm font-semibold text-primary-700 dark:text-primary-300">Assign Manager</p>
              <p class="text-[10px] text-primary-500 font-mono">POST /reporting/assign</p>
            </div>
            <span class="material-icons-round text-primary-400 ml-auto text-[18px]">chevron_right</span>
          </button>
          <button onclick="openModal('removeModal')" class="w-full flex items-center gap-3 px-3 py-2.5 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl hover:bg-red-100 transition">
            <span class="w-8 h-8 rounded-lg bg-red-500 text-white flex items-center justify-center flex-shrink-0"><span class="material-icons-round text-[18px]">person_remove</span></span>
            <div class="text-left">
              <p class="text-sm font-semibold text-red-700 dark:text-red-300">Remove Manager</p>
              <p class="text-[10px] text-red-400 font-mono">PUT /reporting/remove</p>
            </div>
            <span class="material-icons-round text-red-300 ml-auto text-[18px]">chevron_right</span>
          </button>
          <button onclick="openReportingExplorer()" class="w-full flex items-center gap-3 px-3 py-2.5 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <span class="w-8 h-8 rounded-lg bg-gray-600 text-white flex items-center justify-center flex-shrink-0"><span class="material-icons-round text-[18px]">account_tree</span></span>
            <div class="text-left">
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-200">View Reporting Tree</p>
              <p class="text-[10px] text-gray-400 font-mono">GET /reporting/tree/{id}</p>
            </div>
            <span class="material-icons-round text-gray-400 ml-auto text-[18px]">chevron_right</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-md overflow-hidden">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700"><h4 class="font-bold text-sm">Quick Actions</h4></div>
      <div class="p-4 grid grid-cols-2 gap-2.5">
        <button onclick="openModal('deptModal')" class="p-3 border border-gray-200 dark:border-gray-700 rounded-xl flex flex-col items-center gap-1.5 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-300 transition group">
          <span class="material-icons-round text-primary-600 text-[22px]">add_circle</span><span class="text-xs font-medium text-gray-700 dark:text-gray-300">New Dept</span>
          <span class="text-[9px] text-gray-400 font-mono">POST /departments</span>
        </button>
        <button onclick="openModal('moveModal')" class="p-3 border border-gray-200 dark:border-gray-700 rounded-xl flex flex-col items-center gap-1.5 hover:bg-orange-50 dark:hover:bg-orange-900/20 hover:border-orange-300 transition">
          <span class="material-icons-round text-orange-500 text-[22px]">swap_horiz</span><span class="text-xs font-medium text-gray-700 dark:text-gray-300">Move Dept</span>
          <span class="text-[9px] text-gray-400 font-mono">PUT /move/{id}</span>
        </button>
        <button onclick="openModal('reportModal')" class="p-3 border border-gray-200 dark:border-gray-700 rounded-xl flex flex-col items-center gap-1.5 hover:bg-green-50 dark:hover:bg-green-900/20 hover:border-green-300 transition">
          <span class="material-icons-round text-green-600 text-[22px]">supervisor_account</span><span class="text-xs font-medium text-gray-700 dark:text-gray-300">Assign Mgr</span>
          <span class="text-[9px] text-gray-400 font-mono">POST /assign</span>
        </button>
        <button onclick="openModal('removeModal')" class="p-3 border border-gray-200 dark:border-gray-700 rounded-xl flex flex-col items-center gap-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 hover:border-red-300 transition">
          <span class="material-icons-round text-red-500 text-[22px]">person_remove</span><span class="text-xs font-medium text-gray-700 dark:text-gray-300">Remove Mgr</span>
          <span class="text-[9px] text-gray-400 font-mono">PUT /remove</span>
        </button>
      </div>
    </div>

    <!-- Department Summary -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-md overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <h4 class="font-bold text-sm">Departments</h4>
        <span class="badge badge-info" id="deptSummaryCount">—</span>
      </div>
      <div class="p-3 max-h-72 overflow-y-auto" id="deptSummaryList">
        <div class="skeleton h-6 rounded mb-2"></div>
        <div class="skeleton h-6 rounded mb-2 w-5/6"></div>
        <div class="skeleton h-6 rounded mb-2 w-4/6"></div>
      </div>
    </div>
  </div>

  <!-- ── REPORTING TREE EXPLORER (full width) ── -->
  <div id="reportingExplorer" class="mt-5 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-md hidden">
    <div class="flex flex-wrap items-center justify-between gap-3 p-5 border-b border-gray-200 dark:border-gray-700">
      <div>
        <h3 class="font-bold text-base">Reporting Tree Explorer</h3>
        <p class="text-xs text-gray-500 mt-0.5 font-mono">GET /api/organogram/reporting/tree/{id}?type=PRIMARY&amp;date=2026-02-01</p>
      </div>
      <button onclick="closeReportingExplorer()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-400"><span class="material-icons-round">close</span></button>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 divide-y lg:divide-y-0 lg:divide-x divide-gray-200 dark:divide-gray-700">
      <!-- LEFT: Controls -->
      <div class="p-6 space-y-4">
        <div>
          <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-3">Query Parameters</p>
          <div class="space-y-3">
            <div>
              <label class="form-label">Employee ID <span class="text-red-400">*</span></label>
              <input type="number" id="repTreeEmpId" class="form-input" placeholder="e.g. 5" min="1" value="5">
            </div>
            <div>
              <label class="form-label">Reporting Type</label>
              <div class="flex gap-2 mt-1">
                <button id="typePrimary" onclick="setRepType('PRIMARY')" class="flex-1 py-2 text-xs font-semibold rounded-lg border-2 border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700 transition">PRIMARY</button>
                <button id="typeMatrix" onclick="setRepType('MATRIX')" class="flex-1 py-2 text-xs font-semibold rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-500 transition">MATRIX</button>
              </div>
              <input type="hidden" id="repTreeType" value="PRIMARY">
            </div>
            <div>
              <label class="form-label">As-of Date</label>
              <input type="date" id="repTreeDate" class="form-input">
            </div>
            <button onclick="fetchReportingTree()" id="fetchRepBtn" class="w-full py-2.5 bg-primary-600 text-white text-sm font-semibold rounded-xl hover:bg-primary-700 transition flex items-center justify-center gap-2">
              <span class="material-icons-round text-[18px]">search</span> Fetch Reporting Tree
            </button>
          </div>
        </div>
        <div class="pt-3 border-t border-gray-100 dark:border-gray-700">
          <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Request Preview</p>
          <div class="bg-gray-900 dark:bg-gray-950 rounded-xl p-3 font-mono text-[11px] text-green-400 leading-relaxed" id="repRequestPreview">
            GET /reporting/tree/5<br>?type=PRIMARY<br>&amp;date=2026-02-21
          </div>
        </div>
      </div>
      <!-- RIGHT: Tree output -->
      <div class="lg:col-span-2 p-6">
        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-4">Response · Reporting Hierarchy</p>
        <div id="repTreeResult" class="space-y-1"></div>
      </div>
    </div>
  </div>

  <!-- ======================================================
     MODALS
====================================================== -->

  <!-- 1. Add Company (parent OR subsidiary) -->
  <div id="companyModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-backdrop absolute inset-0" onclick="closeModal('companyModal')"></div>
    <div class="modal-card relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-bold text-lg">Add Company</h3>
            <p class="text-xs text-gray-400 font-mono mt-0.5" id="companyModalEndpoint">POST /companies</p>
          </div>
          <button onclick="closeModal('companyModal')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><span class="material-icons-round text-gray-400">close</span></button>
        </div>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="form-label">Company Type *</label>
          <div class="flex gap-2 mt-1">
            <button id="typeBtnParent" onclick="setCompanyType('parent')" class="flex-1 py-2 text-sm font-medium rounded-lg border-2 border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700 transition">Parent Company</button>
            <button id="typeBtnSub" onclick="setCompanyType('subsidiary')" class="flex-1 py-2 text-sm font-medium rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-400 transition">Subsidiary</button>
          </div>
        </div>
        <div id="parentCompanyField" class="hidden">
          <label class="form-label">Parent Company ID *</label>
          <input type="number" id="compParentId" placeholder="e.g. 1" class="form-input" min="1">
          <p class="text-[10px] text-gray-400 mt-1 font-mono">Endpoint changes to POST /companies/{id}/subsidiaries</p>
        </div>
        <div>
          <label class="form-label">Company Name *</label>
          <input type="text" id="compName" placeholder="e.g. JustJava Holdings" class="form-input">
        </div>
        <div>
          <label class="form-label">Company Code *</label>
          <input type="text" id="compCode" placeholder="e.g. JJH" class="form-input" maxlength="10" style="font-family:'DM Mono',monospace;">
        </div>
        <div id="companyError" class="api-error hidden"></div>
      </div>
      <div class="p-5 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="closeModal('companyModal')" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">Cancel</button>
        <button onclick="saveCompany()" id="saveCompanyBtn" class="px-5 py-2 bg-primary-600 text-white text-sm font-semibold rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
          <span class="material-icons-round text-sm">business</span> Create Company
        </button>
      </div>
    </div>
  </div>

  <!-- 2. Create Department -->
  <div id="deptModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-backdrop absolute inset-0" onclick="closeModal('deptModal')"></div>
    <div class="modal-card relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-bold text-lg">Create Department</h3>
            <p class="text-xs text-gray-400 font-mono mt-0.5">POST /api/organogram/departments</p>
          </div>
          <button onclick="closeModal('deptModal')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><span class="material-icons-round text-gray-400">close</span></button>
        </div>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="form-label">Department Name *</label>
          <input type="text" id="deptName" placeholder="e.g. Human Resources" class="form-input">
        </div>
        <div>
          <label class="form-label">Department Code *</label>
          <input type="text" id="deptCode" placeholder="e.g. 100001" class="form-input" style="font-family:'DM Mono',monospace;">
        </div>
        <div>
          <label class="form-label">Company ID *</label>
          <input type="number" id="deptCompanyId" placeholder="e.g. 1" class="form-input" min="1">
          <p class="text-[10px] text-gray-400 mt-1">The company this department belongs to</p>
        </div>
        <div>
          <label class="form-label">Parent Department ID <span class="text-gray-400 font-normal">(optional — leave blank for top-level)</span></label>
          <input type="number" id="deptParentId" placeholder="e.g. 2" class="form-input" min="1">
        </div>
        <div>
          <label class="form-label">Effective From *</label>
          <input type="date" id="deptEffectiveFrom" class="form-input">
        </div>
        <div id="deptError" class="api-error hidden"></div>
      </div>
      <div class="p-5 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="closeModal('deptModal')" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">Cancel</button>
        <button onclick="saveDept()" id="saveDeptBtn" class="px-5 py-2 bg-primary-600 text-white text-sm font-semibold rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
          <span class="material-icons-round text-sm">add_circle</span> Create Department
        </button>
      </div>
    </div>
  </div>

  <!-- 3. Move Department -->
  <div id="moveModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-backdrop absolute inset-0" onclick="closeModal('moveModal')"></div>
    <div class="modal-card relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-bold text-lg">Move Department</h3>
            <p class="text-xs text-gray-400 font-mono mt-0.5">PUT /departments/{id}/move/{newParentId}</p>
          </div>
          <button onclick="closeModal('moveModal')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><span class="material-icons-round text-gray-400">close</span></button>
        </div>
      </div>
      <div class="p-6 space-y-4">
        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 text-xs text-amber-700 dark:text-amber-400">
          <span class="material-icons-round text-sm align-middle mr-1">info</span>
          This calls <span class="font-mono">PUT /api/organogram/departments/<b>{departmentId}</b>/move/<b>{newParentDepartmentId}</b></span>
        </div>
        <div>
          <label class="form-label">Department ID to Move *</label>
          <input type="number" id="moveDeptId" placeholder="e.g. 2" class="form-input" min="1">
          <p class="text-[10px] text-gray-400 mt-1">The department being relocated</p>
        </div>
        <div>
          <label class="form-label">New Parent Department ID *</label>
          <input type="number" id="moveNewParentId" placeholder="e.g. 1" class="form-input" min="1">
          <p class="text-[10px] text-gray-400 mt-1">The department it will report into</p>
        </div>
        <div id="moveError" class="api-error hidden"></div>
      </div>
      <div class="p-5 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="closeModal('moveModal')" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">Cancel</button>
        <button onclick="saveMove()" id="saveMoveBtn" class="px-5 py-2 bg-orange-500 text-white text-sm font-semibold rounded-lg hover:bg-orange-600 transition flex items-center gap-2">
          <span class="material-icons-round text-sm">swap_horiz</span> Move Department
        </button>
      </div>
    </div>
  </div>

  <!-- 4. Assign Reporting Line -->
  <div id="reportModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-backdrop absolute inset-0" onclick="closeModal('reportModal')"></div>
    <div class="modal-card relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-bold text-lg">Assign Reporting Line</h3>
            <p class="text-xs text-gray-400 font-mono mt-0.5">POST /api/organogram/reporting/assign</p>
          </div>
          <button onclick="closeModal('reportModal')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><span class="material-icons-round text-gray-400">close</span></button>
        </div>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="form-label">Employee ID *</label>
          <input type="number" id="reportEmpId" placeholder="e.g. 5" class="form-input" min="1">
        </div>
        <div>
          <label class="form-label">Manager ID *</label>
          <input type="number" id="reportMgrId" placeholder="e.g. 2" class="form-input" min="1">
        </div>
        <div>
          <label class="form-label">Reporting Type *</label>
          <select id="reportType" class="form-select">
            <option value="PRIMARY">PRIMARY</option>
            <option value="MATRIX">MATRIX</option>
          </select>
        </div>
        <div>
          <label class="form-label">Effective From *</label>
          <input type="date" id="reportEffectiveFrom" class="form-input">
        </div>
        <div id="reportError" class="api-error hidden"></div>
      </div>
      <div class="p-5 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="closeModal('reportModal')" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">Cancel</button>
        <button onclick="saveReport()" id="saveReportBtn" class="px-5 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700 transition flex items-center gap-2">
          <span class="material-icons-round text-sm">supervisor_account</span> Assign Manager
        </button>
      </div>
    </div>
  </div>

  <!-- 5. Remove Reporting Line -->
  <div id="removeModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-backdrop absolute inset-0" onclick="closeModal('removeModal')"></div>
    <div class="modal-card relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-bold text-lg">Remove Reporting Line</h3>
            <p class="text-xs text-gray-400 font-mono mt-0.5">PUT /api/organogram/reporting/remove</p>
          </div>
          <button onclick="closeModal('removeModal')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><span class="material-icons-round text-gray-400">close</span></button>
        </div>
      </div>
      <div class="p-6 space-y-4">
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 text-xs text-red-700 dark:text-red-400">
          <span class="material-icons-round text-sm align-middle mr-1">warning</span>
          Sets an <code>effectiveTo</code> date on the reporting line — it does not permanently delete it.
        </div>
        <div>
          <label class="form-label">Employee ID *</label>
          <input type="number" id="removeEmpId" placeholder="e.g. 5" class="form-input" min="1">
        </div>
        <div>
          <label class="form-label">Reporting Type *</label>
          <select id="removeType" class="form-select">
            <option value="PRIMARY">PRIMARY</option>
            <option value="MATRIX">MATRIX</option>
          </select>
        </div>
        <div>
          <label class="form-label">Effective To (end date) *</label>
          <input type="date" id="removeEffectiveTo" class="form-input">
        </div>
        <div id="removeError" class="api-error hidden"></div>
      </div>
      <div class="p-5 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="closeModal('removeModal')" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">Cancel</button>
        <button onclick="saveRemove()" id="saveRemoveBtn" class="px-5 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700 transition flex items-center gap-2">
          <span class="material-icons-round text-sm">person_remove</span> Remove Manager
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl z-[100] hidden text-sm font-medium">
    <span class="material-icons-round text-lg" id="toastIcon">check_circle</span>
    <span id="toastMsg">Done</span>
  </div>

  <!-- ======================================================
       JAVASCRIPT
  ====================================================== -->
  <script>
    (function () {
        // ── State ─────────────────────────────────────────────
        let companyTree = [];
        let deptTree    = [];
        let companyType = 'parent'; // 'parent' | 'subsidiary'

        // ── Utilities ─────────────────────────────────────────
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const text = document.getElementById('toastMsg');
            t.className = t.className.replace(/bg-\S+/g, '').trim();
            if (type === 'success') {
                t.classList.add('bg-gray-900', 'text-white');
                icon.textContent = 'check_circle';
            } else if (type === 'error') {
                t.classList.add('bg-red-600', 'text-white');
                icon.textContent = 'error';
            } else {
                t.classList.add('bg-blue-600', 'text-white');
                icon.textContent = 'info';
            }
            text.textContent = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3200);
        }

        function showError(elementId, msg) {
            const el = document.getElementById(elementId);
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function hideError(elementId) {
            const el = document.getElementById(elementId);
            el.classList.add('hidden');
            el.textContent = '';
        }

        function setLoading(btnId, loading) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            btn.disabled = loading;
            btn.style.opacity = loading ? '0.7' : '1';
        }

        // ── Modal helpers ──────────────────────────────────────
        window.openModal  = id => document.getElementById(id).classList.remove('hidden');
        window.closeModal = id => document.getElementById(id).classList.add('hidden');

        // ── View toggle ────────────────────────────────────────
        window.setView = function (v) {
            ['chart', 'list'].forEach(mode => {
                const btn = document.getElementById(mode + 'ViewBtn');
                const isActive = v === mode;
                btn.classList.toggle('bg-white', isActive);
                btn.classList.toggle('dark:bg-gray-800', isActive);
                btn.classList.toggle('shadow-sm', isActive);
                btn.classList.toggle('text-primary-600', isActive);
                btn.classList.toggle('text-gray-600', !isActive);
            });
            const chartEl = document.getElementById('orgChartView');
            const listEl  = document.getElementById('orgListView');
            chartEl.classList.toggle('hidden', v !== 'chart');
            listEl.classList.toggle('hidden',  v !== 'list');
            if (v === 'chart') setTimeout(drawConnectors, 60);
        };

        // ── Node detail panel ──────────────────────────────────
        window.showDetail = function (node) {
            const initials = (node.name || '??').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('ndAvatar').textContent = initials;
            document.getElementById('ndName').textContent   = node.name || '—';
            document.getElementById('ndMeta').textContent   = node.code || node.departmentId || '—';
            document.getElementById('ndEmp').textContent    = node.employeeCount ?? '—';
            document.getElementById('ndSub').textContent    = (node.children || node.subDepartments || []).length;
            document.getElementById('ndCode').textContent   = node.code || '—';
            document.getElementById('nodeDetail').classList.remove('hidden');
        };
        window.closeDetail = () => document.getElementById('nodeDetail').classList.add('hidden');

        // ── Org Chart Rendering ────────────────────────────────
        function renderNode(node, container) {
            const isRoot = !node.parentDepartmentId && !node.companyId;
            const children = node.children || node.subDepartments || [];
            const wrap = document.createElement('div');
            wrap.className = 'org-node-wrap';

            const nodeDiv = document.createElement('div');
            const initials = (node.name || 'XX').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            nodeDiv.className = `org-node rounded-xl border-2 p-4 shadow-md ${
                isRoot
                ? 'bg-primary-600 text-white border-primary-400'
                : children.length > 0
                ? 'bg-white dark:bg-gray-800 border-blue-300 dark:border-blue-700'
                : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-600'
            }`;
            nodeDiv.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="w-11 h-11 rounded-full flex items-center justify-center text-xs font-bold font-mono mb-2 ${
                        isRoot ? 'bg-white/20 text-white' : children.length > 0 ? 'bg-blue-100 dark:bg-blue-900/40 text-blue-700' : 'bg-gray-100 dark:bg-gray-700 text-gray-700'
                    }">${initials}</div>
                    <div class="font-semibold text-sm text-center leading-tight">${node.name || '—'}</div>
                    ${node.code ? `<div class="code-tag mt-1">${node.code}</div>` : ''}
                    ${node.employeeCount != null ? `<div class="mt-2 text-xs px-2 py-1 rounded-full ${isRoot ? 'bg-white/20' : 'bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300'}">${node.employeeCount} emp</div>` : ''}
                </div>
            `;
            nodeDiv.onclick = e => { e.stopPropagation(); showDetail(node); };
            wrap.appendChild(nodeDiv);

            if (children.length > 0) {
                const vLine = document.createElement('div'); vLine.className = 'connector-v'; wrap.appendChild(vLine);
                const childContainer = document.createElement('div'); childContainer.className = 'flex flex-col items-center w-full';
                const row = document.createElement('div'); row.className = 'org-children-row';
                const hLine = document.createElement('div'); hLine.className = 'connector-h-line'; row.appendChild(hLine);
                children.forEach(child => {
                    const childWrap = document.createElement('div'); childWrap.className = 'flex flex-col items-center';
                    const vUp = document.createElement('div'); vUp.className = 'v-up'; childWrap.appendChild(vUp);
                    renderNode(child, childWrap);
                    row.appendChild(childWrap);
                });
                childContainer.appendChild(row);
                wrap.appendChild(childContainer);
            }
            container.appendChild(wrap);
        }

        function drawConnectors() {
            document.querySelectorAll('.org-children-row').forEach(row => {
                const hLine = row.querySelector('.connector-h-line');
                if (!hLine) return;
                const children = Array.from(row.children).filter(el => !el.classList.contains('connector-h-line'));
                if (children.length < 2) { hLine.style.display = 'none'; return; }
                hLine.style.display = 'block';
                const rowRect   = row.getBoundingClientRect();
                const firstRect = children[0].querySelector('.org-node')?.getBoundingClientRect();
                const lastRect  = children[children.length - 1].querySelector('.org-node')?.getBoundingClientRect();
                if (!firstRect || !lastRect) return;
                hLine.style.left  = (firstRect.left + firstRect.width / 2 - rowRect.left) + 'px';
                hLine.style.right = (rowRect.right - (lastRect.left + lastRect.width / 2)) + 'px';
            });
        }
        window.addEventListener('resize', () => setTimeout(drawConnectors, 30));

        // ── Dept table (list view) ─────────────────────────────
        function flattenDepts(nodes, parent = '—', acc = []) {
            nodes.forEach(n => {
                acc.push({ ...n, _parent: parent });
                const children = n.children || n.subDepartments || [];
                if (children.length) flattenDepts(children, n.name, acc);
            });
            return acc;
        }

        function buildDeptTable(nodes) {
            const tbody = document.getElementById('deptTableBody'); tbody.innerHTML = '';
            flattenDepts(nodes).forEach(n => {
                const tr = document.createElement('tr');
                tr.className = 'border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-750 cursor-pointer';
                tr.onclick = () => showDetail(n);
                const initials = (n.name || 'XX').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                tr.innerHTML = `
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            <span class="w-7 h-7 rounded-lg bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-[10px] font-bold text-primary-700 font-mono">${initials}</span>
                            <span class="font-medium text-sm">${n.name || '—'}</span>
                        </div>
                    </td>
                    <td class="p-3"><span class="code-tag">${n.code || '—'}</span></td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-400">${n._parent}</td>
                    <td class="p-3"><span class="badge badge-success text-[10px]">Active</span></td>
                    <td class="p-3"><button onclick="event.stopPropagation();showDetail(${JSON.stringify(n).replace(/'/g,"\\'")})" class="text-primary-600 text-xs hover:underline">View</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function buildDeptSummary(nodes) {
            const cont = document.getElementById('deptSummaryList'); cont.innerHTML = '';
            const colors = ['#3b82f6','#0ea5e9','#16a34a','#7c3aed','#ea580c','#db2777','#0891b2','#d97706'];
            flattenDepts(nodes).forEach((n, i) => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-2.5 py-2 border-b border-gray-100 dark:border-gray-700 last:border-0 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-750 px-1 rounded transition';
                item.onclick = () => showDetail(n);
                item.innerHTML = `
                    <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background:${colors[i % colors.length]}"></span>
                    <span class="flex-1 text-sm font-medium truncate">${n.name || '—'}</span>
                    <span class="code-tag flex-shrink-0">${n.code || '—'}</span>
                `;
                cont.appendChild(item);
            });
        }

        // ── Company tree panel ─────────────────────────────────
        function buildCompanyPanel(tree) {
            const panel = document.getElementById('companyTreePanel'); panel.innerHTML = '';
            function renderCompany(company, depth = 0) {
                const item = document.createElement('div');
                item.className = depth > 0 ? 'ml-6 pl-4 border-l-2 border-gray-200 dark:border-gray-700 mt-2' : '';
                const initials = (company.code || company.name || 'CO').substring(0, 3).toUpperCase();
                const bgColors = ['bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300', 'bg-green-100 dark:bg-green-900/30 text-green-700', 'bg-orange-100 dark:bg-orange-900/30 text-orange-700'];
                const color = bgColors[depth % bgColors.length];
                item.innerHTML = `
                    <div class="flex items-center gap-2.5 py-1">
                        <div class="w-8 h-8 rounded-lg ${color} flex items-center justify-center text-[10px] font-bold font-mono flex-shrink-0">${initials}</div>
                        <div class="min-w-0">
                            <p class="font-semibold text-sm truncate">${company.name || '—'}</p>
                            <p class="text-[10px] text-gray-500">${depth === 0 ? 'Parent' : 'Subsidiary'} · <span class="font-mono">${company.code || '—'}</span></p>
                        </div>
                        ${depth === 0 ? `<span class="badge badge-info text-[9px] ml-auto flex-shrink-0">${(company.subsidiaries||[]).length} subs</span>` : '<span class="badge badge-success text-[9px] ml-auto flex-shrink-0">Active</span>'}
                    </div>
                `;
                panel.appendChild(item);
                (company.subsidiaries || []).forEach(sub => renderCompany(sub, depth + 1));
            }
            if (!tree.length) {
                panel.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">No companies found. Add one above.</p>';
                return;
            }
            tree.forEach(c => renderCompany(c));
        }

        // ── Reporting tree render ──────────────────────────────
        function renderRepTree(node, container, depth = 0) {
            const div = document.createElement('div');
            div.className = depth === 0 ? 'rep-root' : 'rep-node mt-2';
            const initials = ((node.employeeName || node.name || 'EMP')).split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
            div.innerHTML = `
                <div class="flex items-center gap-2 py-1">
                    <div class="w-7 h-7 rounded-full ${depth===0?'bg-primary-600 text-white':'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'} flex items-center justify-center text-[10px] font-bold">${initials}</div>
                    <div>
                        <p class="text-sm font-medium">${node.employeeName || node.name || 'Employee ' + (node.employeeId || '')}</p>
                        <p class="text-[10px] text-gray-500">${node.role || node.designation || ''} ${node.reportingType ? '· <span class="badge badge-info text-[9px]">'+node.reportingType+'</span>' : ''}</p>
                    </div>
                </div>
            `;
            container.appendChild(div);
            (node.directReports || node.children || []).forEach(child => renderRepTree(child, div, depth + 1));
        }

        // ── Reporting Explorer ─────────────────────────────────
        window.openReportingExplorer = function () {
            const ex = document.getElementById('reportingExplorer');
            ex.classList.remove('hidden');
            ex.scrollIntoView({ behavior: 'smooth', block: 'start' });
            updateRepPreview();
        };
        window.closeReportingExplorer = function () {
            document.getElementById('reportingExplorer').classList.add('hidden');
        };

        window.setRepType = function (type) {
            document.getElementById('repTreeType').value = type;
            document.getElementById('typePrimary').className = `flex-1 py-2 text-xs font-semibold rounded-lg border-2 transition ${type==='PRIMARY'?'border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700':'border-gray-200 dark:border-gray-600 text-gray-500'}`;
            document.getElementById('typeMatrix').className  = `flex-1 py-2 text-xs font-semibold rounded-lg border-2 transition ${type==='MATRIX'?'border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700':'border-gray-200 dark:border-gray-600 text-gray-500'}`;
            updateRepPreview();
        };

        function updateRepPreview() {
            const empId = document.getElementById('repTreeEmpId')?.value || '{id}';
            const type  = document.getElementById('repTreeType')?.value || 'PRIMARY';
            const date  = document.getElementById('repTreeDate')?.value  || '(omit)';
            const prev  = document.getElementById('repRequestPreview');
            if (prev) prev.innerHTML = `GET /reporting/tree/${empId}<br>?type=${type}<br>&amp;date=${date}`;
        }

        window.fetchReportingTree = async function () {
            const empId  = document.getElementById('repTreeEmpId').value;
            const type   = document.getElementById('repTreeType').value;
            const date   = document.getElementById('repTreeDate').value;
            const result = document.getElementById('repTreeResult');
            updateRepPreview();
            if (!empId) { result.innerHTML = '<div class="api-error">Please enter an Employee ID.</div>'; return; }
            result.innerHTML = '<div class="flex items-center gap-2 text-gray-400 text-sm"><span class="material-icons-round animate-spin text-[18px]">refresh</span>Fetching tree…</div>';
            setLoading('fetchRepBtn', true);
            try {
                let url = `/reporting/tree/${empId}?type=${type}`;
                if (date) url += `&date=${date}`;
                const data = await apiFetch(url);
                // Guard against empty or missing data
                if (!data) {
                    result.innerHTML = '<span class="text-xs text-gray-400">No data returned.</span>';
                    return;
                }
                const treeData = Array.isArray(data) ? data[0] : data;
                if (!treeData) {
                    result.innerHTML = '<span class="text-xs text-gray-400">No reporting data found.</span>';
                    return;
                }
                result.innerHTML = '';
                renderRepTree(treeData, result);
                if (!result.children.length) result.innerHTML = '<span class="text-xs text-gray-400">No reporting data found.</span>';
            } catch (e) {
                result.innerHTML = `<div class="api-error">${e.message}</div>`;
            } finally {
                setLoading('fetchRepBtn', false);
            }
        };

        // ── Dummy Data ─────────────────────────────────────────
        const DUMMY_COMPANY_TREE = [
            {
                companyId: 1, name: 'JustJava Holdings', code: 'JJH',
                subsidiaries: [
                    { companyId: 2, name: 'JustJava Nigeria Ltd',  code: 'JJN', subsidiaries: [] },
                    { companyId: 3, name: 'JustJava Ghana Ltd',    code: 'JJG', subsidiaries: [] },
                    { companyId: 4, name: 'JustJava Kenya Ltd',    code: 'JJK', subsidiaries: [] }
                ]
            }
        ];

        const DUMMY_DEPT_TREE = [
            {
                departmentId: 1, name: 'JustJava Holdings', code: 'JJH',
                employeeCount: 248, parentDepartmentId: null,
                children: [
                    {
                        departmentId: 2, name: 'Human Resources', code: '100001',
                        employeeCount: 34, parentDepartmentId: 1,
                        children: [
                            { departmentId: 5,  name: 'Payroll',       code: '100002', employeeCount: 8,  parentDepartmentId: 2, children: [] },
                            { departmentId: 6,  name: 'Talent Acq.',   code: '100003', employeeCount: 10, parentDepartmentId: 2, children: [] },
                            { departmentId: 7,  name: 'L&D',           code: '100004', employeeCount: 7,  parentDepartmentId: 2, children: [] },
                            { departmentId: 8,  name: 'Compliance',    code: '100005', employeeCount: 9,  parentDepartmentId: 2, children: [] }
                        ]
                    },
                    {
                        departmentId: 3, name: 'Finance', code: '200001',
                        employeeCount: 28, parentDepartmentId: 1,
                        children: [
                            { departmentId: 9,  name: 'Treasury',      code: '200002', employeeCount: 6,  parentDepartmentId: 3, children: [] },
                            { departmentId: 10, name: 'Tax & Audit',   code: '200003', employeeCount: 9,  parentDepartmentId: 3, children: [] },
                            { departmentId: 11, name: 'Accounts',      code: '200004', employeeCount: 13, parentDepartmentId: 3, children: [] }
                        ]
                    },
                    {
                        departmentId: 4, name: 'Technology', code: '300001',
                        employeeCount: 42, parentDepartmentId: 1,
                        children: [
                            { departmentId: 12, name: 'Engineering',   code: '300002', employeeCount: 20, parentDepartmentId: 4, children: [] },
                            { departmentId: 13, name: 'Infrastructure',code: '300003', employeeCount: 12, parentDepartmentId: 4, children: [] },
                            { departmentId: 14, name: 'Cybersecurity', code: '300004', employeeCount: 10, parentDepartmentId: 4, children: [] }
                        ]
                    },
                    {
                        departmentId: 15, name: 'Operations', code: '400001',
                        employeeCount: 55, parentDepartmentId: 1,
                        children: [
                            { departmentId: 16, name: 'Logistics',     code: '400002', employeeCount: 28, parentDepartmentId: 15, children: [] },
                            { departmentId: 17, name: 'Facilities',    code: '400003', employeeCount: 27, parentDepartmentId: 15, children: [] }
                        ]
                    },
                    {
                        departmentId: 18, name: 'Legal', code: '500001',
                        employeeCount: 14, parentDepartmentId: 1,
                        children: []
                    },
                    {
                        departmentId: 19, name: 'Marketing', code: '600001',
                        employeeCount: 22, parentDepartmentId: 1,
                        children: [
                            { departmentId: 20, name: 'Brand',         code: '600002', employeeCount: 9,  parentDepartmentId: 19, children: [] },
                            { departmentId: 21, name: 'Digital',       code: '600003', employeeCount: 13, parentDepartmentId: 19, children: [] }
                        ]
                    }
                ]
            }
        ];

        const DUMMY_REP_TREE = {
            employeeId: 5, employeeName: 'Sarah Miller', role: 'HR Director', reportingType: 'PRIMARY',
            directReports: [
                {
                    employeeId: 6, employeeName: 'Chidi Okafor', role: 'Payroll Manager', reportingType: 'PRIMARY',
                    directReports: [
                        { employeeId: 9, employeeName: 'Amara Eze', role: 'Payroll Officer', reportingType: 'PRIMARY', directReports: [] },
                        { employeeId: 10, employeeName: 'Bayo Lawal', role: 'Payroll Analyst', reportingType: 'PRIMARY', directReports: [] }
                    ]
                },
                {
                    employeeId: 7, employeeName: 'Grace Ndidi', role: 'Talent Lead', reportingType: 'PRIMARY',
                    directReports: [
                        { employeeId: 11, employeeName: 'Emeka Uche', role: 'Recruiter', reportingType: 'PRIMARY', directReports: [] }
                    ]
                },
                {
                    employeeId: 8, employeeName: 'Fatima Bello', role: 'L&D Coordinator', reportingType: 'PRIMARY',
                    directReports: []
                }
            ]
        };

        // ── Mock API (returns dummy data, simulates network delay) ──
        async function apiFetch(path, options = {}) {
            await new Promise(r => setTimeout(r, 420)); // simulate latency
            const method = (options.method || 'GET').toUpperCase();

            // GET /companies/tree
            if (method === 'GET' && path.includes('/companies/tree'))
                return JSON.parse(JSON.stringify(DUMMY_COMPANY_TREE));

            // GET /departments/tree
            if (method === 'GET' && path.includes('/departments/tree'))
                return JSON.parse(JSON.stringify(DUMMY_DEPT_TREE));

            // GET /reporting/tree/{id}
            if (method === 'GET' && path.includes('/reporting/tree'))
                return JSON.parse(JSON.stringify(DUMMY_REP_TREE));

            // All mutating calls — simulate success
            if (['POST','PUT','PATCH','DELETE'].includes(method))
                return { success: true, message: 'Operation completed (demo mode)' };

            throw new Error('Unknown endpoint: ' + path);
        }

        // ── API Calls ──────────────────────────────────────────

        async function fetchCompanyTree() {
            try {
                const data = await apiFetch('/companies/tree');
                companyTree = Array.isArray(data) ? data : [data];
                buildCompanyPanel(companyTree);
                let total = 0;
                function countCompanies(arr) { arr.forEach(c => { total++; countCompanies(c.subsidiaries||[]); }); }
                countCompanies(companyTree);
                document.getElementById('statCompanies').textContent = total;
                const roots = companyTree.length;
                const subs  = total - roots;
                document.getElementById('statCompanySub').textContent = `${roots} Parent · ${subs} Subsidiaries`;
                // Removed references to missing element 'apiStatus'
            } catch (e) {
                document.getElementById('companyTreePanel').innerHTML = `<div class="api-error">${e.message}</div>`;
            }
        }

        async function fetchDeptTree() {
            const badge = document.getElementById('chartLiveBadge');
            badge.innerHTML = `<span class="w-1.5 h-1.5 bg-yellow-400 rounded-full animate-pulse"></span>Loading`;
            badge.className = 'badge badge-orange text-[10px] flex items-center gap-1';
            try {
                const data = await apiFetch('/departments/tree');
                deptTree = Array.isArray(data) ? data : [data];

                const container = document.getElementById('orgTree'); container.innerHTML = '';
                const rootWrap  = document.createElement('div'); rootWrap.className = 'flex flex-col items-center';
                deptTree.forEach(root => renderNode(root, rootWrap));
                container.appendChild(rootWrap);
                setTimeout(drawConnectors, 100);

                buildDeptTable(deptTree);
                buildDeptSummary(deptTree);

                const flat = flattenDepts(deptTree);
                document.getElementById('statDepts').textContent = flat.length - 1; // exclude root holding
                document.getElementById('deptSummaryCount').textContent = (flat.length - 1) + ' total';
                document.getElementById('statDeptSub').textContent = (flat.length - 1) + ' active departments';
                const empTotal = flat.reduce((s, n) => s + (n.employeeCount || 0), 0);
                document.getElementById('statEmps').textContent = 248;
                document.getElementById('statLines').textContent = 186;

                badge.innerHTML = `<span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>Demo`;
                badge.className = 'badge badge-success text-[10px] flex items-center gap-1';
            } catch (e) {
                document.getElementById('orgTree').innerHTML = `<div class="api-error m-4">${e.message}</div>`;
                badge.innerHTML = `<span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>Error`;
                badge.className = 'badge badge-red text-[10px] flex items-center gap-1';
            }
        }

        // ── Company type toggle ────────────────────────────────
        window.setCompanyType = function (type) {
            companyType = type;
            const isParent = type === 'parent';
            document.getElementById('typeBtnParent').className = `flex-1 py-2 text-sm font-medium rounded-lg border-2 transition ${isParent ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700' : 'border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-400'}`;
            document.getElementById('typeBtnSub').className    = `flex-1 py-2 text-sm font-medium rounded-lg border-2 transition ${!isParent ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700' : 'border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-400'}`;
            document.getElementById('parentCompanyField').classList.toggle('hidden', isParent);
            document.getElementById('companyModalEndpoint').textContent = isParent ? 'POST /companies' : 'POST /companies/{parentId}/subsidiaries';
        };

        // ── Save: Company ──────────────────────────────────────
        window.saveCompany = async function () {
            hideError('companyError');
            const name = document.getElementById('compName').value.trim();
            const code = document.getElementById('compCode').value.trim();
            if (!name || !code) { showError('companyError', 'Name and Code are required.'); return; }

            let path, body;
            if (companyType === 'parent') {
                path = '/companies';
                body = { name, code, parentCompanyId: null };
            } else {
                const parentId = document.getElementById('compParentId').value;
                if (!parentId) { showError('companyError', 'Parent Company ID is required for a subsidiary.'); return; }
                path = `/companies/${parentId}/subsidiaries`;
                body = { name, code };
            }

            setLoading('saveCompanyBtn', true);
            try {
                await apiFetch(path, { method: 'POST', body: JSON.stringify(body) });
                closeModal('companyModal');
                showToast(`Company "${name}" created successfully`);
                document.getElementById('compName').value = '';
                document.getElementById('compCode').value = '';
                fetchCompanyTree();
            } catch (e) {
                showError('companyError', e.message);
            } finally {
                setLoading('saveCompanyBtn', false);
            }
        };

        // ── Save: Department ───────────────────────────────────
        window.saveDept = async function () {
            hideError('deptError');
            const name          = document.getElementById('deptName').value.trim();
            const code          = document.getElementById('deptCode').value.trim();
            const companyId     = document.getElementById('deptCompanyId').value;
            const parentDeptId  = document.getElementById('deptParentId').value;
            const effectiveFrom = document.getElementById('deptEffectiveFrom').value;
            if (!name || !code || !companyId || !effectiveFrom) {
                showError('deptError', 'Name, Code, Company ID, and Effective From are required.');
                return;
            }
            const body = {
                name,
                code,
                companyId: parseInt(companyId),
                parentDepartmentId: parentDeptId ? parseInt(parentDeptId) : null,
                effectiveFrom
            };
            setLoading('saveDeptBtn', true);
            try {
                await apiFetch('/departments', { method: 'POST', body: JSON.stringify(body) });
                closeModal('deptModal');
                showToast(`Department "${name}" created`);
                ['deptName','deptCode','deptCompanyId','deptParentId','deptEffectiveFrom'].forEach(id => document.getElementById(id).value = '');
                fetchDeptTree();
            } catch (e) {
                showError('deptError', e.message);
            } finally {
                setLoading('saveDeptBtn', false);
            }
        };

        // ── Save: Move Department ──────────────────────────────
        window.saveMove = async function () {
            hideError('moveError');
            const deptId      = document.getElementById('moveDeptId').value;
            const newParentId = document.getElementById('moveNewParentId').value;
            if (!deptId || !newParentId) { showError('moveError', 'Both Department ID and New Parent ID are required.'); return; }
            setLoading('saveMoveBtn', true);
            try {
                await apiFetch(`/departments/${deptId}/move/${newParentId}`, { method: 'PUT' });
                closeModal('moveModal');
                showToast('Department moved successfully');
                document.getElementById('moveDeptId').value = '';
                document.getElementById('moveNewParentId').value = '';
                fetchDeptTree();
            } catch (e) {
                showError('moveError', e.message);
            } finally {
                setLoading('saveMoveBtn', false);
            }
        };

        // ── Save: Assign Reporting Line ────────────────────────
        window.saveReport = async function () {
            hideError('reportError');
            const employeeId    = document.getElementById('reportEmpId').value;
            const managerId     = document.getElementById('reportMgrId').value;
            const reportingType = document.getElementById('reportType').value;
            const effectiveFrom = document.getElementById('reportEffectiveFrom').value;
            if (!employeeId || !managerId || !effectiveFrom) {
                showError('reportError', 'Employee ID, Manager ID, and Effective From are required.');
                return;
            }
            const body = {
                employeeId:    parseInt(employeeId),
                managerId:     parseInt(managerId),
                reportingType,
                effectiveFrom
            };
            setLoading('saveReportBtn', true);
            try {
                await apiFetch('/reporting/assign', { method: 'POST', body: JSON.stringify(body) });
                closeModal('reportModal');
                showToast('Manager assigned successfully');
                ['reportEmpId','reportMgrId','reportEffectiveFrom'].forEach(id => document.getElementById(id).value = '');
            } catch (e) {
                showError('reportError', e.message);
            } finally {
                setLoading('saveReportBtn', false);
            }
        };

        // ── Save: Remove Reporting Line ────────────────────────
        window.saveRemove = async function () {
            hideError('removeError');
            const employeeId    = document.getElementById('removeEmpId').value;
            const reportingType = document.getElementById('removeType').value;
            const effectiveTo   = document.getElementById('removeEffectiveTo').value;
            if (!employeeId || !effectiveTo) {
                showError('removeError', 'Employee ID and Effective To date are required.');
                return;
            }
            const body = {
                employeeId:    parseInt(employeeId),
                reportingType,
                effectiveTo
            };
            setLoading('saveRemoveBtn', true);
            try {
                await apiFetch('/reporting/remove', { method: 'PUT', body: JSON.stringify(body) });
                closeModal('removeModal');
                showToast('Reporting line removed', 'info');
                ['removeEmpId','removeEffectiveTo'].forEach(id => document.getElementById(id).value = '');
            } catch (e) {
                showError('removeError', e.message);
            } finally {
                setLoading('saveRemoveBtn', false);
            }
        };

        // ── Set default date fields to today ───────────────────
        const today = new Date().toISOString().split('T')[0];
        ['deptEffectiveFrom','reportEffectiveFrom','repTreeDate'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = today;
        });
        // default remove effectiveTo to end of year
        const eoy = new Date(); eoy.setMonth(11); eoy.setDate(31);
        const removeEl = document.getElementById('removeEffectiveTo');
        if (removeEl) removeEl.value = eoy.toISOString().split('T')[0];

        // ── Initial stat placeholders ──────────────────────────
        document.getElementById('statEmps').textContent = '—';
        document.getElementById('statLines').textContent = '—';

        // ── Boot ───────────────────────────────────────────────
        fetchCompanyTree();
        fetchDeptTree();

        // Pre-open reporting explorer with dummy data
        setTimeout(() => {
            // set default date
            const today2 = new Date().toISOString().split('T')[0];
            const repDate = document.getElementById('repTreeDate');
            if (repDate) repDate.value = today2;
            updateRepPreview();
            // auto-load the tree
            const result = document.getElementById('repTreeResult');
            if (result) {
                result.innerHTML = '';
                renderRepTree(DUMMY_REP_TREE, result);
            }
            document.getElementById('statLines').textContent = 186;
            // Add input listeners so the preview updates live
            ['repTreeEmpId','repTreeDate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateRepPreview);
            });
        }, 700);

    })();
  </script>
</main>
</body>
</html>