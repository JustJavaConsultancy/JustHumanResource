<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>My KPIs - Employee Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        secondary: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: { 'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'] },
                    borderRadius: { 'xl': '1rem', '2xl': '1.5rem' }
                }
            }
        };
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { overflow-x: hidden; }
        .sidebar-item { transition: all 0.2s ease; position: relative; }
        .sidebar-item.active { background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; border-left: 3px solid #3b82f6; }
        .sidebar-item.active .material-icons-round { color: #3b82f6; }
        .sidebar-item:hover:not(.active) { background-color: rgba(59, 130, 246, 0.05); }
        .dark .sidebar-item.active { background-color: rgba(59, 130, 246, 0.2); }
        .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease; height: 100%; display: flex; flex-direction: column; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .badge { padding: 2px 8px; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; }
        .badge-success { background-color: #dcfce7; color: #16a34a; }
        .badge-warning { background-color: #fef3c7; color: #d97706; }
        .badge-error { background-color: #fee2e2; color: #dc2626; }
        .badge-info { background-color: #dbeafe; color: #2563eb; }
        .progress-bar { height: 8px; border-radius: 4px; overflow: hidden; background-color: #e5e7eb; }
        .dark .progress-bar { background-color: #374151; }
        .progress-fill { height: 100%; border-radius: 4px; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .sidebar-scroll::-webkit-scrollbar-thumb { background: #4b5563; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
        .sidebar-container { position: fixed; top: 0; left: 0; height: 100vh; width: 16rem; z-index: 40; overflow-y: auto; }
        .main-content { margin-left: 16rem; width: calc(100% - 16rem); min-height: 100vh; display: flex; flex-direction: column; }
        @media (max-width: 1023px) {
            .sidebar-container { transform: translateX(-100%); }
            .sidebar-container.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
        }
        .kpi-tab { padding: 12px 20px; font-weight: 500; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .kpi-tab:hover { color: #4b5563; }
        .kpi-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .dark .kpi-tab { color: #9ca3af; }
        .dark .kpi-tab:hover { color: #d1d5db; }
        .dark .kpi-tab.active { color: #3b82f6; }
        .kpi-score-excellent { background-color: #10b981; }
        .kpi-score-good { background-color: #3b82f6; }
        .kpi-score-average { background-color: #f59e0b; }
        .kpi-score-poor { background-color: #ef4444; }
        .appraisal-outcome-exceeds { background-color: #10b981; color: white; }
        .appraisal-outcome-meets { background-color: #3b82f6; color: white; }
        .appraisal-outcome-needs { background-color: #f59e0b; color: white; }
        .appraisal-outcome-unsatisfactory { background-color: #ef4444; color: white; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator, .htmx-request.htmx-indicator { display: inline-block; }
        /* Ensure tab content fills remaining vertical space */
        .tab-content { flex: 1; display: flex; flex-direction: column; }
        .tab-content > div { flex: 1; display: flex; flex-direction: column; }
        .tab-content .overflow-x-auto { flex: 1; overflow: auto; }
    </style>
</head>
<body>
<main layout:fragment="content" class="flex-1 flex flex-col">

    <!-- Tabs -->
    <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
        <nav class="flex space-x-6">
            <button id="tab-definitions" class="kpi-tab active" onclick="switchTab('definitions')">KPI Definitions</button>
            <button id="tab-assignments" class="kpi-tab" onclick="switchTab('assignments')">My KPI Assignments</button>
            <button id="tab-measurements" class="kpi-tab" onclick="switchTab('measurements')">My Measurements</button>
            <button id="tab-appraisal" class="kpi-tab" onclick="switchTab('appraisal')">My Appraisal</button>
        </nav>
    </div>

    <!-- Stats Cards (all equal height) -->
    <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
        <!-- Assigned KPIs to me -->
        <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                    <span class="material-icons-round text-blue-600 dark:text-blue-400">assignment_ind</span>
                </div>
                <span class="badge badge-info">Active</span>
            </div>
            <h3 th:text="${assignedKpisCount}" class="text-2xl font-bold mb-1" id="assignedKpis">8</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">KPIs Assigned to Me</p>
        </div>

        <!-- My Average Performance Score -->
        <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
                    <span class="material-icons-round text-purple-600 dark:text-purple-400">trending_up</span>
                </div>
                <span class="text-sm text-gray-500">Last 3 months</span>
            </div>
            <h3 class="text-2xl font-bold mb-1" th:text="${avgPerformanceScore}">84.5</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">My Avg Performance Score</p>
            <div class="mt-3">
                <div class="progress-bar">
                    <div class="progress-fill bg-purple-500" th:style="'width: ' + ${avgPerformanceScore} + '%'"></div>
                </div>
                <p class="text-xs text-gray-500 mt-1" th:text="${performanceTrend}">+2.3% from last month</p>
            </div>
        </div>

        <!-- Recent Measurements -->
        <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
                    <span class="material-icons-round text-green-600 dark:text-green-400">rule</span>
                </div>
                <span class="badge badge-success">Latest</span>
            </div>
            <h3 class="text-2xl font-bold mb-1" th:text="${recentMeasurementsCount}">12</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Measurements this year</p>
            <div class="mt-3 flex items-center text-xs text-gray-500">
                <span class="material-icons-round text-xs mr-1">update</span>
                <span th:text="${lastMeasurementDate}">Last entry: 15 Mar 2026</span>
            </div>
        </div>

        <!-- Pending Appraisal / Next Review -->
        <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-orange-100 dark:bg-orange-900/30 rounded-lg">
                    <span class="material-icons-round text-orange-600 dark:text-orange-400">event</span>
                </div>
                <span class="badge badge-warning" th:text="${nextReviewStatus}">Upcoming</span>
            </div>
            <h3 class="text-2xl font-bold mb-1" th:text="${nextReviewDate}">Q2 2026</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Next Appraisal</p>
            <div class="mt-3">
                <div class="flex items-center text-xs text-gray-500">
                    <span class="material-icons-round text-xs mr-1">info</span>
                    <span th:text="${appraisalProgress}">3 of 5 KPIs reviewed</span>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Definitions Content (read‑only table, fills space) -->
    <div id="content-definitions" class="tab-content">
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col">
            <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold">KPI Definitions</h3>
                    <div class="relative">
                        <input type="text" placeholder="Search KPIs..."
                               class="pl-10 pr-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none w-64">
                        <span class="material-icons-round text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2">search</span>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto flex-1 p-0">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-750 sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Target Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Unit</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="kpiDefinitionsTable">
                    <tr th:each="kpi : ${kpiDefinitions}" class="bg-white dark:bg-gray-800">
                        <td class="px-6 py-4 whitespace-nowrap"><div th:text="${kpi.code}" class="font-medium">KPI001</div></td>
                        <td class="px-6 py-4">
                            <div th:text="${kpi.name}" class="font-medium">Sales Target Achievement</div>
                            <div th:text="${kpi.description}" class="text-sm text-gray-500">Percentage of monthly sales target achieved</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span th:text="${kpi.category}" class="px-2 py-1 text-xs rounded-full"
                                  th:classappend="${kpi.category == 'PRODUCTIVITY' ? ' bg-blue-100 text-blue-800' :
                                                    (kpi.category == 'ATTENDANCE' ? ' bg-green-100 text-green-800' :
                                                    (kpi.category == 'QUALITY' ? ' bg-purple-100 text-purple-800' :
                                                    ' bg-gray-100 text-gray-800'))}">Productivity</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <th:block th:switch="${kpi.unit}">
                                <span th:case="'PERCENTAGE'" th:text="${kpi.targetValue} + ' %'">100 %</span>
                                <span th:case="'HOURS'" th:text="${kpi.targetValue} + ' h'">40 h</span>
                                <span th:case="'NUMBER'" th:text="${kpi.targetValue}">4.5</span>
                                <span th:case="*" th:text="${kpi.targetValue ?: '--'}">--</span>
                            </th:block>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap"
                            th:text="${kpi.unit == 'PERCENTAGE' ? 'Percentage' :
                                      (kpi.unit == 'HOURS' ? 'Hours' :
                                      (kpi.unit == 'NUMBER' ? 'Number' : kpi.unit))}">Percentage</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span th:text="${kpi.active ? 'Active' : 'Inactive'}"
                                  class="px-2 py-1 text-xs rounded-full"
                                  th:classappend="${kpi.active ? ' bg-green-100 text-green-800' : ' bg-red-100 text-red-800'}">Active</span>
                        </td>
                    </tr>
                    <tr th:if="${kpiDefinitions == null or #lists.isEmpty(kpiDefinitions)}">
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No KPI definitions found.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- KPI Assignments Content – loaded via HTMX -->
    <div id="content-assignments" class="tab-content hidden">
        <div class="flex justify-center items-center h-full">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
            <span class="ml-3 text-gray-500">Loading your assignments...</span>
        </div>
    </div>

    <!-- KPI Measurements Content – read‑only table (fills space) -->
    <div id="content-measurements" class="tab-content hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold">My KPI Measurements</h3>
            </div>
            <div class="flex-1 overflow-auto p-6" id="measurementsTable">
                <!-- Loaded via HTMX -->
                <div class="flex justify-center items-center h-full">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                    <span class="ml-3 text-gray-500">Loading measurements...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Appraisal Content – loaded via HTMX -->
    <div id="content-appraisal" class="tab-content hidden">
        <div class="flex justify-center items-center h-full">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
            <span class="ml-3 text-gray-500">Loading your appraisal...</span>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const currentEmployeeId = [[${#authentication.principal.id}]];  // adjust as needed
        /*]]>*/
    </script>

    <script>
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.kpi-tab').forEach(t => t.classList.remove('active'));
            const contentDiv = document.getElementById(`content-${tabName}`);
            contentDiv.classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'assignments' && !contentDiv.hasAttribute('data-loaded')) {
                htmx.ajax('GET', '/my-kpi/assignments', { target: '#content-assignments', swap: 'innerHTML' })
                    .then(() => contentDiv.setAttribute('data-loaded', 'true'));
            } else if (tabName === 'measurements' && !document.getElementById('measurementsTable').hasAttribute('data-loaded')) {
                htmx.ajax('GET', '/my-kpi/measurements', { target: '#measurementsTable', swap: 'innerHTML' })
                    .then(() => document.getElementById('measurementsTable').setAttribute('data-loaded', 'true'));
            } else if (tabName === 'appraisal' && !contentDiv.hasAttribute('data-loaded')) {
                htmx.ajax('GET', '/my-kpi/appraisal', { target: '#content-appraisal', swap: 'innerHTML' })
                    .then(() => contentDiv.setAttribute('data-loaded', 'true'));
            }
        }

        function formatPeriod(period) { if (!period) return ''; const [y, m] = period.split('-'); return new Date(y, m-1).toLocaleDateString('en-US', { month:'long', year:'numeric' }); }
        function getScoreClass(score) { return score >= 80 ? 'kpi-score-excellent' : score >= 60 ? 'kpi-score-good' : score >= 40 ? 'kpi-score-average' : 'kpi-score-poor'; }
        function showNotification(message, type) {
            const n = document.createElement('div');
            n.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}`;
            n.innerHTML = `<div class="flex items-center space-x-3"><span class="material-icons-round">${type === 'success' ? 'check_circle' : 'error'}</span><span>${message}</span></div>`;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }
        function refreshStats() { htmx.ajax('GET', '/my-kpi/stats-cards', { target: '#stats-cards', swap: 'outerHTML' }); }

        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu (if present)
            const menuToggle = document.getElementById('menuToggle'), mobileOverlay = document.getElementById('mobileOverlay'), sidebar = document.querySelector('.sidebar-container');
            if (menuToggle && mobileOverlay && sidebar) {
                menuToggle.addEventListener('click', () => { sidebar.classList.toggle('open'); mobileOverlay.classList.toggle('hidden'); document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : 'auto'; });
                mobileOverlay.addEventListener('click', () => { sidebar.classList.remove('open'); mobileOverlay.classList.add('hidden'); document.body.style.overflow = 'auto'; });
            }
            // Theme toggle (if present)
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                const themeIcon = themeToggle.querySelector('.material-icons-round');
                themeToggle.addEventListener('click', () => {
                    const isDark = document.documentElement.classList.toggle('dark');
                    themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                });
                if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    if (themeIcon) themeIcon.textContent = 'light_mode';
                }
            }
            // Sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (this.getAttribute('href') === '#') e.preventDefault();
                    document.querySelectorAll('.sidebar-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    if (window.innerWidth < 1024 && sidebar) { sidebar.classList.remove('open'); if (mobileOverlay) mobileOverlay.classList.add('hidden'); document.body.style.overflow = 'auto'; }
                });
            });
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024 && sidebar) { sidebar.classList.remove('open'); if (mobileOverlay) mobileOverlay.classList.add('hidden'); document.body.style.overflow = 'auto'; }
            });
        });
    </script>
</main>
</body>
</html>