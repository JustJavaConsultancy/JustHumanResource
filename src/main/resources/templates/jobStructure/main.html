<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>Job Grades · Unified with Steps</title>
  <script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    primary: {
                        50: '#eff6ff',
                        100: '#dbeafe',
                        200: '#bfdbfe',
                        300: '#93c5fd',
                        400: '#60a5fa',
                        500: '#3b82f6',
                        600: '#2563eb',
                        700: '#1d4ed8',
                        800: '#1e40af',
                        900: '#1e3a8a',
                    },
                    secondary: {
                        50: '#f8fafc',
                        100: '#f1f5f9',
                        200: '#e2e8e0',
                        300: '#cbd5e1',
                        400: '#94a3b8',
                        500: '#64748b',
                        600: '#475569',
                        700: '#334155',
                        800: '#1e293b',
                        900: '#0f172a',
                    }
                },
                fontFamily: {
                    'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                },
            },
        },
    };
  </script>
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { overflow-x: hidden; }
    .sidebar-item { transition: all 0.2s ease; position: relative; }
    .sidebar-item.active { background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; border-left: 3px solid #3b82f6; }
    .sidebar-item.active .material-icons-round { color: #3b82f6; }
    .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .badge { padding: 2px 8px; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; }
    .progress-bar { height: 8px; border-radius: 4px; overflow: hidden; background-color: #e5e7eb; }
    .dark .progress-bar { background-color: #374151; }
    .progress-fill { height: 100%; border-radius: 4px; }
    .sidebar-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .dark .sidebar-scroll::-webkit-scrollbar-thumb { background: #4b5563; }
    .sidebar-container { position: fixed; top: 0; left: 0; height: 100vh; width: 16rem; z-index: 40; overflow-y: auto; }
    .main-content { margin-left: 16rem; width: calc(100% - 16rem); min-height: 100vh; }
    @media (max-width: 1023px) {
        .sidebar-container { transform: translateX(-100%); }
        .sidebar-container.open { transform: translateX(0); }
        .main-content { margin-left: 0; width: 100%; }
    }
    .grade-color-1 { background-color: #3b82f6; }
    .grade-color-2 { background-color: #10b981; }
    .grade-color-3 { background-color: #8b5cf6; }
    .grade-color-4 { background-color: #f59e0b; }
    .grade-color-5 { background-color: #ef4444; }
    .grade-color-6 { background-color: #06b6d4; }
    .grade-color-7 { background-color: #ec4899; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    .dark .modal-content { background: #1f2937; }
    .step-level-indicator { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; }
    .salary-progression-bar { height: 4px; background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b); border-radius: 2px; margin: 8px 0; }
    .step-row { transition: background-color 0.2s; }
    .step-row:hover { background-color: rgba(59, 130, 246, 0.03); }
    #gradeDetails .max-h-steps { max-height: 300px; overflow-y: auto; }
    .grade-card.selected { ring: 2px solid #3b82f6; }
    .column-flex { display: flex; flex-direction: column; height: 100%; }
    .card-flex { flex: 1; }
  </style>
</head>
<body>
<main layout:fragment="content">
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
          <span class="material-icons-round text-blue-600 dark:text-blue-400">layers</span>
        </div>
      </div>
      <h3 th:text="${#lists.size(grades)}" class="text-2xl font-bold mb-1" id="totalGrades">7</h3>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Job Grades</p>
      <div class="mt-3 flex items-center text-xs text-gray-500">
        <span class="material-icons-round text-xs mr-1">check_circle</span>
        <span>From Grade 1 to Grade 7</span>
      </div>
    </div>
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
          <span class="material-icons-round text-green-600 dark:text-green-400">stairs</span>
        </div>
      </div>
      <h3 th:text="${totalSteps}" class="text-2xl font-bold mb-1" id="totalSteps">35</h3>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Job Steps</p>
      <div class="mt-3 flex items-center text-xs text-gray-500">
        <span class="material-icons-round text-xs mr-1">timeline</span>
        <span>5 steps per grade average</span>
      </div>
    </div>
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
          <span class="material-icons-round text-purple-600 dark:text-purple-400">attach_money</span>
        </div>
      </div>
      <h3 class="text-2xl font-bold mb-1">₦2,500</h3>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Avg Step Increase</p>
      <div class="mt-3">
        <div class="progress-bar"><div class="progress-fill bg-purple-500" style="width: 75%"></div></div>
        <p class="text-xs text-gray-500 mt-1">Consistent progression</p>
      </div>
    </div>
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="p-3 bg-orange-100 dark:bg-orange-900/30 rounded-lg">
          <span class="material-icons-round text-orange-600 dark:text-orange-400">people</span>
        </div>
        <span class="badge badge-info">Distribution</span>
      </div>
      <h3 class="text-2xl font-bold mb-1">0</h3>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Employees Mapped</p>
      <div class="mt-3 flex items-center text-xs text-gray-500">
        <span class="material-icons-round text-xs mr-1">pie_chart</span>
        <span>All employees assigned to grades</span>
      </div>
    </div>
  </div>

  <!-- Two Column Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8">
    <!-- Left Column - Job Grades Cards -->
    <div class="lg:col-span-2 column-flex space-y-4 md:space-y-6">
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 card-flex">
        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <span class="material-icons-round text-primary-600">layers</span>
              <h3 class="text-lg font-bold">Job Grades (with steps)</h3>
            </div>
            <button onclick="openModal('addGradeModal')" class="flex items-center space-x-2 px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">
              <span class="material-icons-round text-sm">add</span>
              <span>Add Grade + Steps</span>
            </button>
          </div>
        </div>
        <div class="p-4 md:p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="gradesList">
            <!--
              Each card embeds a data-steps attribute containing the grade's steps as a JSON array.
              The Thymeleaf expression builds the JSON inline from grade.steps (each step has id, name, basicSalary).
              JS reads this attribute directly — no separate fetch or hardcoded data array needed.
            -->
            <div th:each="grade, iterStat : ${grades}"
                 th:id="'grade-card-' + ${grade.id}"
                 class="grade-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-primary-500 transition-colors cursor-pointer"
                 th:onclick="'selectGrade(' + ${grade.id} + ')'"
                 th:attr="data-grade-id=${grade.id},
                          data-grade-name=${grade.name},
                          data-grade-dept=${grade.departmentName},
                          data-grade-desc=${grade.name + ' positions'},
                          data-steps=${grade.steps != null ?
                            '[' + #strings.listJoin(
                              grade.steps.!['{&quot;id&quot;:' + id + ',&quot;name&quot;:&quot;' + name + '&quot;,&quot;basicSalary&quot;:' + basicSalary + '}'],
                            ',') + ']'
                            : '[]'}">
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center space-x-2">
                  <div th:text="${grade.id}"
                       th:classappend="'grade-color-' + ${iterStat.index + 1 <= 7 ? iterStat.index + 1 : 1}"
                       class="step-level-indicator">1</div>
                  <div>
                    <h4 th:text="${grade.name}" class="font-bold">Entry Level</h4>
                    <p th:text="${grade.departmentName}" class="text-xs text-gray-500">General</p>
                  </div>
                </div>
                <div class="flex space-x-1" onclick="event.stopPropagation()">
                  <button th:onclick="'editGrade(' + ${grade.id} + ')'" class="p-1 text-gray-400 hover:text-primary-600">
                    <span class="material-icons-round text-sm">edit</span>
                  </button>
                  <button th:onclick="'deleteGrade(' + ${grade.id} + ')'" class="p-1 text-gray-400 hover:text-red-600">
                    <span class="material-icons-round text-sm">delete</span>
                  </button>
                </div>
              </div>
              <p th:text="${grade.name + ' positions'}" class="text-xs text-gray-600 dark:text-gray-400 mb-2">Entry level positions</p>
              <div class="flex justify-end text-xs">
                <span th:text="${(grade.steps != null ? grade.steps.size() : 0) + ' steps'}" class="font-medium">0 steps</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Selected Grade Details -->
    <div class="column-flex space-y-4 md:space-y-6">
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 card-flex" id="gradeDetails">
        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-bold">Grade &amp; Steps Details</h3>
        </div>
        <div class="p-4 md:p-6">
          <div class="text-center py-8">
            <span class="material-icons-round text-gray-400 text-4xl mb-4">layers</span>
            <p class="text-gray-500 dark:text-gray-400">Select a grade to view its steps</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== MODALS ========== -->

  <!-- ADD GRADE MODAL -->
  <div id="addGradeModal" class="modal">
    <div class="modal-content">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-bold">Create Grade with Steps</h3>
        <p class="text-sm text-gray-500 mt-1">Define grade, department, and all steps at once</p>
      </div>
      <div class="p-6">
        <form th:action="@{/addJobGroup}" method="post" id="addGradeForm">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Grade Name *</label>
              <input type="text" required name="gradeName" placeholder="e.g. Senior Analyst" class="w-full px-4 py-2 border border-gray-300 rounded-lg dark:bg-gray-800">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Department *</label>
              <select required name="departmentId" class="w-full px-4 py-2 border border-gray-300 rounded-lg dark:bg-gray-800">
                <option value="">Select department</option>
                <option th:each="department : ${departments}"
                        th:value="${department.id}"
                        th:text="${department.name}">Engineering</option>
              </select>
            </div>
            <!-- Steps container -->
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
              <label class="block text-sm font-medium mb-3">Steps (minimum one) *</label>
              <div id="stepsContainer" class="space-y-3"></div>
              <button type="button" onclick="addStepRow()" class="mt-2 flex items-center justify-center space-x-2 px-3 py-2 text-sm text-primary-600 hover:text-primary-700 border border-dashed border-primary-300 rounded-lg w-full">
                <span class="material-icons-round text-sm">add_circle</span>
                <span>Add another step</span>
              </button>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeModal('addGradeModal')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">Create Grade &amp; Steps</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- EDIT GRADE MODAL -->
  <div id="editGradeModal" class="modal">
    <div class="modal-content">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-bold">Edit Job Grade</h3>
      </div>
      <div class="p-6">
        <form id="editGradeForm">
          <input type="hidden" name="id" id="editGradeId">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Grade Name</label>
              <input type="text" required id="editGradeName" class="w-full px-4 py-2 border rounded-lg" name="name">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Department</label>
              <select id="editGradeDept" class="w-full px-4 py-2 border rounded-lg" name="department">
                <option value="">Select department</option>
                <option th:each="department : ${departments}"
                        th:value="${department.id}"
                        th:text="${department.name}">Engineering</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Description</label>
              <textarea id="editGradeDescription" rows="2" class="w-full px-4 py-2 border rounded-lg" name="description"></textarea>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeModal('editGradeModal')" class="px-4 py-2 border rounded-lg">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg">Update Grade</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let selectedGradeId = null;

    // ─── Step rows (add modal) ────────────────────────────────────────────────

    function refreshStepIndices() {
      const rows = document.querySelectorAll('#stepsContainer .step-row');
      rows.forEach((row, i) => {
        const nameInput = row.querySelector('input[type="text"]');
        const salaryInput = row.querySelector('input[type="number"]');
        if (nameInput)   nameInput.name   = `steps[${i}].stepName`;
        if (salaryInput) salaryInput.name = `steps[${i}].basicSalary`;
      });
    }

    function addStepRow() {
      const container = document.getElementById('stepsContainer');
      const idx = container.children.length;
      const row = document.createElement('div');
      row.className = 'step-row flex items-center space-x-3 mb-3';
      row.innerHTML = `
        <input type="text" name="steps[${idx}].stepName" placeholder="Step name"
               class="flex-1 px-3 py-2 border rounded-lg dark:bg-gray-800" required>
        <div class="relative flex-1">
          <span class="absolute left-3 top-1/2 -translate-y-1/2">₦</span>
          <input type="number" name="steps[${idx}].basicSalary" placeholder="Salary"
                 min="0" step="0.01"
                 class="w-full pl-8 pr-4 py-2 border rounded-lg dark:bg-gray-800" required>
        </div>
        <button type="button" onclick="removeStepRow(this)"
                class="p-2 text-gray-400 hover:text-red-600">
          <span class="material-icons-round text-sm">delete</span>
        </button>`;
      container.appendChild(row);
    }

    function removeStepRow(btn) {
      const container = document.getElementById('stepsContainer');
      if (container.children.length <= 1) { alert('At least one step required.'); return; }
      btn.closest('.step-row').remove();
      refreshStepIndices();
    }

    // ─── Modals ───────────────────────────────────────────────────────────────

    function openModal(id) {
      if (id === 'addGradeModal') {
        document.getElementById('addGradeForm').reset();
        document.getElementById('stepsContainer').innerHTML = '';
        addStepRow();
      }
      document.getElementById(id).classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // ─── Grade selection ──────────────────────────────────────────────────────

    /**
     * Called when a card is clicked.
     * Reads all data directly from the card's data-* attributes — no JS arrays needed.
     */
    function selectGrade(gradeId) {
      // Clear ring from all cards
      document.querySelectorAll('.grade-card').forEach(c =>
        c.classList.remove('ring-2', 'ring-primary-500'));

      const card = document.getElementById('grade-card-' + gradeId);
      if (!card) return;

      // Highlight selected card
      card.classList.add('ring-2', 'ring-primary-500');
      selectedGradeId = gradeId;

      // Read grade metadata from data attributes
      const gradeName = card.dataset.gradeName || '—';
      const department = card.dataset.gradeDept  || '—';
      const description = card.dataset.gradeDesc  || '—';

      // Parse steps JSON embedded in the card at render time
      let steps = [];
      try {
        const raw = card.dataset.steps;
        if (raw) steps = JSON.parse(raw);
      } catch (e) {
        console.warn('Could not parse steps for grade', gradeId, e);
      }

      renderGradeDetails({ id: gradeId, name: gradeName, department, description }, steps);
    }

    // ─── Render details panel ─────────────────────────────────────────────────

    /**
     * Renders the right-hand details panel from plain objects.
     * @param {Object} grade  – { id, name, department, description }
     * @param {Array}  steps  – [{ id, name, basicSalary }, ...]
     */
    function renderGradeDetails(grade, steps) {
      const fmt = n => Number(n).toLocaleString('en-NG', { minimumFractionDigits: 2 });

      const minSal = steps.length ? Math.min(...steps.map(s => s.basicSalary)) : 0;
      const maxSal = steps.length ? Math.max(...steps.map(s => s.basicSalary)) : 0;
      const avgSal = steps.length
        ? steps.reduce((a, s) => a + Number(s.basicSalary), 0) / steps.length
        : 0;

      const stepsHtml = steps.length
        ? steps.map((s, i) => `
            <div class="flex justify-between items-center py-1.5 border-b border-gray-100 dark:border-gray-700 text-sm last:border-0">
              <span class="text-gray-700 dark:text-gray-300">${s.name || 'Step ' + (i + 1)}</span>
              <span class="font-mono font-medium">₦${fmt(s.basicSalary)}</span>
            </div>`).join('')
        : '<p class="text-gray-400 italic text-sm py-2">No steps defined</p>';

      document.getElementById('gradeDetails').innerHTML = `
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-bold">${grade.name}</h3>
            <span class="text-xs bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 px-2 py-1 rounded-full font-medium">
              ${grade.department}
            </span>
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${grade.description}</p>
        </div>

        <div class="p-4 space-y-4">

          <!-- Steps list -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-sm">Steps <span class="text-gray-400 font-normal">(${steps.length})</span></h4>
            </div>
            <div class="max-h-48 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-1">
              ${stepsHtml}
            </div>
          </div>

          <!-- Salary range -->
          ${steps.length ? `
          <div class="pt-3 border-t border-gray-200 dark:border-gray-700 grid grid-cols-3 gap-3">
            <div class="bg-gray-50 dark:bg-gray-700/40 rounded-lg p-2 text-center">
              <span class="block text-xs text-gray-500 mb-1">Min</span>
              <span class="font-semibold text-sm">₦${fmt(minSal)}</span>
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-2 text-center">
              <span class="block text-xs text-gray-500 mb-1">Avg</span>
              <span class="font-semibold text-sm text-blue-600 dark:text-blue-400">₦${fmt(avgSal)}</span>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700/40 rounded-lg p-2 text-center">
              <span class="block text-xs text-gray-500 mb-1">Max</span>
              <span class="font-semibold text-sm">₦${fmt(maxSal)}</span>
            </div>
          </div>
          <div class="salary-progression-bar"></div>
          ` : ''}

        </div>`;
    }

    // ─── Delete grade ─────────────────────────────────────────────────────────

    function deleteGrade(id) {
      if (!confirm('Delete this grade and all its steps?')) return;

      // Remove card from DOM
      const card = document.getElementById('grade-card-' + id);
      if (card) card.remove();

      // Clear details panel if it was the selected grade
      if (selectedGradeId === id) {
        selectedGradeId = null;
        document.getElementById('gradeDetails').innerHTML = `
          <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-bold">Grade &amp; Steps Details</h3>
          </div>
          <div class="p-4 md:p-6">
            <div class="text-center py-8">
              <span class="material-icons-round text-gray-400 text-4xl mb-4">layers</span>
              <p class="text-gray-500 dark:text-gray-400">Select a grade to view its steps</p>
            </div>
          </div>`;
      }

      // Update grade count badge
      const remaining = document.querySelectorAll('.grade-card').length;
      document.getElementById('totalGrades').innerText = remaining;
    }

    // ─── Edit grade ───────────────────────────────────────────────────────────

    function editGrade(id) {
      const card = document.getElementById('grade-card-' + id);
      if (!card) return;

      document.getElementById('editGradeId').value          = id;
      document.getElementById('editGradeName').value        = card.dataset.gradeName || '';
      document.getElementById('editGradeDescription').value = card.dataset.gradeDesc || '';
      // Department select: match by text content
      const deptName = card.dataset.gradeDept || '';
      const select   = document.getElementById('editGradeDept');
      for (const opt of select.options) {
        if (opt.text.trim() === deptName.trim()) { opt.selected = true; break; }
      }

      openModal('editGradeModal');
    }

    // ─── Save edit ────────────────────────────────────────────────────────────

    function updateGrade(e) {
      e.preventDefault();
      const form     = e.target;
      const formData = new FormData(form);
      const id       = formData.get('id');
      const card     = document.getElementById('grade-card-' + id);
      if (!card) { closeModal('editGradeModal'); return; }

      const newName = formData.get('name');
      const newDesc = formData.get('description');
      const select  = document.getElementById('editGradeDept');
      const newDept = select.options[select.selectedIndex]?.text || card.dataset.gradeDept;

      // Update data attributes so future reads stay in sync
      card.dataset.gradeName = newName;
      card.dataset.gradeDept = newDept;
      card.dataset.gradeDesc = newDesc;

      // Refresh visible text inside the card
      const nameEl = card.querySelector('h4.font-bold');
      const deptEl = card.querySelector('p.text-xs.text-gray-500');
      const descEl = card.querySelector('p.text-xs.text-gray-600');
      if (nameEl) nameEl.innerText = newName;
      if (deptEl) deptEl.innerText = newDept;
      if (descEl) descEl.innerText = newDesc || '—';

      closeModal('editGradeModal');

      // Re-render details panel if this grade is currently selected
      if (selectedGradeId == id) {
        let steps = [];
        try { steps = JSON.parse(card.dataset.steps || '[]'); } catch (_) {}
        renderGradeDetails({ id, name: newName, department: newDept, description: newDesc }, steps);
      }
    }

    // ─── Misc ─────────────────────────────────────────────────────────────────

    function disableSubmitButton(form) {
      const btn = form.querySelector('button[type="submit"]');
      if (btn) { btn.disabled = true; btn.innerText = 'Submitting…'; }
    }

    // ─── Init ─────────────────────────────────────────────────────────────────

    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('addGradeForm').addEventListener('submit', function () {
        disableSubmitButton(this);
      });
      document.getElementById('editGradeForm').addEventListener('submit', updateGrade);
    });

    // Expose to inline onclick handlers
    window.openModal      = openModal;
    window.closeModal     = closeModal;
    window.addStepRow     = addStepRow;
    window.removeStepRow  = removeStepRow;
    window.selectGrade    = selectGrade;
    window.editGrade      = editGrade;
    window.deleteGrade    = deleteGrade;
  </script>
</main>
</body>
</html>