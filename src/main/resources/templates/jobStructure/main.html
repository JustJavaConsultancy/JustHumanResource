<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>Job Grades · Unified with Steps</title>
  <script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    primary: {
                        50: '#eff6ff',
                        100: '#dbeafe',
                        200: '#bfdbfe',
                        300: '#93c5fd',
                        400: '#60a5fa',
                        500: '#3b82f6',
                        600: '#2563eb',
                        700: '#1d4ed8',
                        800: '#1e40af',
                        900: '#1e3a8a',
                    },
                    secondary: {
                        50: '#f8fafc',
                        100: '#f1f5f9',
                        200: '#e2e8e0',
                        300: '#cbd5e1',
                        400: '#94a3b8',
                        500: '#64748b',
                        600: '#475569',
                        700: '#334155',
                        800: '#1e293b',
                        900: '#0f172a',
                    }
                },
                fontFamily: {
                    'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                },
            },
        },
    };
  </script>
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { overflow-x: hidden; }
    .sidebar-item { transition: all 0.2s ease; position: relative; }
    .sidebar-item.active { background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; border-left: 3px solid #3b82f6; }
    .sidebar-item.active .material-icons-round { color: #3b82f6; }
    .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .badge { padding: 2px 8px; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; }
    .progress-bar { height: 8px; border-radius: 4px; overflow: hidden; background-color: #e5e7eb; }
    .dark .progress-bar { background-color: #374151; }
    .progress-fill { height: 100%; border-radius: 4px; }
    .sidebar-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .dark .sidebar-scroll::-webkit-scrollbar-thumb { background: #4b5563; }
    .sidebar-container { position: fixed; top: 0; left: 0; height: 100vh; width: 16rem; z-index: 40; overflow-y: auto; }
    .main-content { margin-left: 16rem; width: calc(100% - 16rem); min-height: 100vh; }
    @media (max-width: 1023px) {
        .sidebar-container { transform: translateX(-100%); }
        .sidebar-container.open { transform: translateX(0); }
        .main-content { margin-left: 0; width: 100%; }
    }
    .grade-color-1 { background-color: #3b82f6; }
    .grade-color-2 { background-color: #10b981; }
    .grade-color-3 { background-color: #8b5cf6; }
    .grade-color-4 { background-color: #f59e0b; }
    .grade-color-5 { background-color: #ef4444; }
    .grade-color-6 { background-color: #06b6d4; }
    .grade-color-7 { background-color: #ec4899; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    .dark .modal-content { background: #1f2937; }
    .step-level-indicator { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; }
    .salary-progression-bar { height: 4px; background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b); border-radius: 2px; margin: 8px 0; }
    .step-row { transition: background-color 0.2s; }
    .step-row:hover { background-color: rgba(59, 130, 246, 0.03); }
    #gradeDetails .max-h-steps { max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
<main layout:fragment="content">
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
          <span class="material-icons-round text-blue-600 dark:text-blue-400">layers</span>
        </div>
      </div>
      <h3 class="text-2xl font-bold mb-1" id="totalGrades">7</h3>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Job Grades</p>
      <div class="mt-3 flex items-center text-xs text-gray-500">
        <span class="material-icons-round text-xs mr-1">check_circle</span>
        <span>From Grade 1 to Grade 7</span>
      </div>
    </div>
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
          <span class="material-icons-round text-green-600 dark:text-green-400">stairs</span>
        </div>
      </div>
      <h3 class="text-2xl font-bold mb-1" id="totalSteps">35</h3>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Job Steps</p>
      <div class="mt-3 flex items-center text-xs text-gray-500">
        <span class="material-icons-round text-xs mr-1">timeline</span>
        <span>5 steps per grade average</span>
      </div>
    </div>
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
          <span class="material-icons-round text-purple-600 dark:text-purple-400">attach_money</span>
        </div>
      </div>
      <h3 class="text-2xl font-bold mb-1">$2,500</h3>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Avg Step Increase</p>
      <div class="mt-3">
        <div class="progress-bar"><div class="progress-fill bg-purple-500" style="width: 75%"></div></div>
        <p class="text-xs text-gray-500 mt-1">Consistent progression</p>
      </div>
    </div>
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="p-3 bg-orange-100 dark:bg-orange-900/30 rounded-lg">
          <span class="material-icons-round text-orange-600 dark:text-orange-400">people</span>
        </div>
        <span class="badge badge-info">Distribution</span>
      </div>
      <h3 class="text-2xl font-bold mb-1">1,248</h3>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Employees Mapped</p>
      <div class="mt-3 flex items-center text-xs text-gray-500">
        <span class="material-icons-round text-xs mr-1">pie_chart</span>
        <span>All employees assigned to grades</span>
      </div>
    </div>
  </div>

  <!-- Two Column Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8">
    <!-- Left Column - Job Grades Cards -->
    <div class="lg:col-span-2 space-y-4 md:space-y-6">
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <span class="material-icons-round text-primary-600">layers</span>
              <h3 class="text-lg font-bold">Job Grades (with steps)</h3>
            </div>
            <button onclick="openModal('addGradeModal')" class="flex items-center space-x-2 px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">
              <span class="material-icons-round text-sm">add</span>
              <span>Add Grade + Steps</span>
            </button>
          </div>
        </div>
        <div class="p-4 md:p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="gradesList">
            <!-- Grades will be loaded here dynamically -->
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Selected Grade Details + Statistics -->
    <div class="space-y-4 md:space-y-6">
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700" id="gradeDetails">
        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-bold">Grade & Steps Details</h3>
        </div>
        <div class="p-4 md:p-6">
          <div class="text-center py-8">
            <span class="material-icons-round text-gray-400 text-4xl mb-4">layers</span>
            <p class="text-gray-500 dark:text-gray-400">Select a grade to view its steps</p>
          </div>
        </div>
      </div>

      <!-- Grade Statistics Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-bold">Grade Statistics</h3>
        </div>
        <div class="p-4 md:p-6">
          <div class="space-y-4">
            <div><div class="flex justify-between mb-1"><span class="text-sm text-gray-600 dark:text-gray-400">Grade Distribution</span><span class="text-sm font-medium">100%</span></div><div class="progress-bar"><div class="progress-fill bg-blue-500" style="width:100%"></div></div></div>
            <div><div class="flex justify-between mb-1"><span class="text-sm text-gray-600 dark:text-gray-400">Average Steps per Grade</span><span class="text-sm font-medium">5.0</span></div><div class="progress-bar"><div class="progress-fill bg-green-500" style="width:100%"></div></div></div>
            <div><div class="flex justify-between mb-1"><span class="text-sm text-gray-600 dark:text-gray-400">Salary Range Coverage</span><span class="text-sm font-medium">$1,500 - $15,000</span></div><div class="progress-bar"><div class="progress-fill bg-purple-500" style="width:90%"></div></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== MODALS ========== -->

  <!-- ADD GRADE MODAL (aligned with CreateJobGradeWithStepsCommand) -->
  <div id="addGradeModal" class="modal">
    <div class="modal-content">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-bold">Create Grade with Steps</h3>
        <p class="text-sm text-gray-500 mt-1">Define grade, department, and all steps at once</p>
      </div>
      <div class="p-6">
        <form th:action="@{/addJobGroup}" method="post" id="addGradeForm">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Grade Name *</label>
              <input type="text" required name="gradeName" placeholder="e.g. Senior Analyst" class="w-full px-4 py-2 border border-gray-300 rounded-lg dark:bg-gray-800">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Department *</label>
              <select required name="departmentId" class="w-full px-4 py-2 border border-gray-300 rounded-lg dark:bg-gray-800">
                <option value="">Select department</option>
                <option th:each="department : ${departments}"
                        th:value="${department.id}"
                        th:text="${department.name}">Engineering</option>
              </select>
            </div>

            <!-- Steps container with indexed names -->
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
              <label class="block text-sm font-medium mb-3">Steps (minimum one) *</label>
              <div id="stepsContainer" class="space-y-3"></div>
              <button type="button" onclick="addStepRow()" class="mt-2 flex items-center justify-center space-x-2 px-3 py-2 text-sm text-primary-600 hover:text-primary-700 border border-dashed border-primary-300 rounded-lg w-full">
                <span class="material-icons-round text-sm">add_circle</span>
                <span>Add another step</span>
              </button>
            </div>
          </div>

          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeModal('addGradeModal')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">Create Grade & Steps</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- EDIT GRADE MODAL (department dropdown updated to numeric) -->
  <div id="editGradeModal" class="modal">
    <div class="modal-content">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-bold">Edit Job Grade</h3>
      </div>
      <div class="p-6">
        <form id="editGradeForm">
          <input type="hidden" name="id" id="editGradeId">
          <div class="space-y-4">
            <div><label class="block text-sm font-medium mb-2">Grade Name</label><input type="text" required id="editGradeName" class="w-full px-4 py-2 border rounded-lg" name="name"></div>
            <div><label class="block text-sm font-medium mb-2">Department</label>
              <select id="editGradeDept" class="w-full px-4 py-2 border rounded-lg" name="department">
                <option value="">Select department</option>
                <option value="1">Engineering</option>
                <option value="2">Sales</option>
                <option value="3">Marketing</option>
                <option value="4">Operations</option>
                <option value="5">Finance</option>
                <option value="6">HR</option>
                <option value="7">Executive</option>
              </select>
            </div>
            <div><label class="block text-sm font-medium mb-2">Code</label><input type="text" id="editGradeCode" class="w-full px-4 py-2 border rounded-lg" name="code"></div>
            <div><label class="block text-sm font-medium mb-2">Description</label><textarea id="editGradeDescription" rows="2" class="w-full px-4 py-2 border rounded-lg" name="description"></textarea></div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeModal('editGradeModal')" class="px-4 py-2 border rounded-lg">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg">Update Grade</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // --- Data structures (updated to include stepName) ---
    let jobGrades = [
        { id: 1, code: 'GRD-001', name: 'Entry Level', department: 'General', level: 1, description: 'Entry level positions', employees: 150 },
        { id: 2, code: 'GRD-002', name: 'Associate', department: 'Operations', level: 2, description: 'Junior associate roles', employees: 280 },
        { id: 3, code: 'GRD-003', name: 'Senior Associate', department: 'Operations', level: 3, description: 'Experienced individual contributors', employees: 320 },
        { id: 4, code: 'GRD-004', name: 'Team Lead', department: 'Engineering', level: 4, description: 'Team leadership positions', employees: 180 },
        { id: 5, code: 'GRD-005', name: 'Manager', department: 'Sales', level: 5, description: 'Department managers', employees: 150 },
        { id: 6, code: 'GRD-006', name: 'Senior Manager', department: 'Marketing', level: 6, description: 'Senior management roles', employees: 90 },
        { id: 7, code: 'GRD-007', name: 'Director', department: 'Executive', level: 7, description: 'Executive leadership', employees: 78 }
    ];

    // Added stepName property to each step (using "Step N" for existing data)
    let jobSteps = [
        { id: 1, gradeId: 1, stepLevel: 1, stepName: 'Step 1', baseSalary: 1500.00, employees: 50 },
        { id: 2, gradeId: 1, stepLevel: 2, stepName: 'Step 2', baseSalary: 1800.00, employees: 45 },
        { id: 3, gradeId: 1, stepLevel: 3, stepName: 'Step 3', baseSalary: 2100.00, employees: 35 },
        { id: 4, gradeId: 1, stepLevel: 4, stepName: 'Step 4', baseSalary: 2400.00, employees: 15 },
        { id: 5, gradeId: 1, stepLevel: 5, stepName: 'Step 5', baseSalary: 2700.00, employees: 5 },
        { id: 6, gradeId: 2, stepLevel: 1, stepName: 'Step 1', baseSalary: 2800.00, employees: 80 },
        { id: 7, gradeId: 2, stepLevel: 2, stepName: 'Step 2', baseSalary: 3200.00, employees: 75 },
        { id: 8, gradeId: 2, stepLevel: 3, stepName: 'Step 3', baseSalary: 3600.00, employees: 65 },
        { id: 9, gradeId: 2, stepLevel: 4, stepName: 'Step 4', baseSalary: 4000.00, employees: 40 },
        { id: 10, gradeId: 2, stepLevel: 5, stepName: 'Step 5', baseSalary: 4400.00, employees: 20 },
        { id: 11, gradeId: 3, stepLevel: 1, stepName: 'Step 1', baseSalary: 4500.00, employees: 90 },
        { id: 12, gradeId: 3, stepLevel: 2, stepName: 'Step 2', baseSalary: 5000.00, employees: 85 },
        { id: 13, gradeId: 3, stepLevel: 3, stepName: 'Step 3', baseSalary: 5500.00, employees: 75 },
        { id: 14, gradeId: 3, stepLevel: 4, stepName: 'Step 4', baseSalary: 6000.00, employees: 50 },
        { id: 15, gradeId: 3, stepLevel: 5, stepName: 'Step 5', baseSalary: 6500.00, employees: 20 },
        { id: 16, gradeId: 4, stepLevel: 1, stepName: 'Step 1', baseSalary: 7000.00, employees: 60 },
        { id: 17, gradeId: 4, stepLevel: 2, stepName: 'Step 2', baseSalary: 7500.00, employees: 50 },
        { id: 18, gradeId: 4, stepLevel: 3, stepName: 'Step 3', baseSalary: 8000.00, employees: 40 },
        { id: 19, gradeId: 4, stepLevel: 4, stepName: 'Step 4', baseSalary: 8500.00, employees: 20 },
        { id: 20, gradeId: 4, stepLevel: 5, stepName: 'Step 5', baseSalary: 9000.00, employees: 10 },
        { id: 21, gradeId: 5, stepLevel: 1, stepName: 'Step 1', baseSalary: 9500.00, employees: 50 },
        { id: 22, gradeId: 5, stepLevel: 2, stepName: 'Step 2', baseSalary: 10000.00, employees: 40 },
        { id: 23, gradeId: 5, stepLevel: 3, stepName: 'Step 3', baseSalary: 10500.00, employees: 35 },
        { id: 24, gradeId: 5, stepLevel: 4, stepName: 'Step 4', baseSalary: 11000.00, employees: 15 },
        { id: 25, gradeId: 5, stepLevel: 5, stepName: 'Step 5', baseSalary: 11500.00, employees: 10 },
        { id: 26, gradeId: 6, stepLevel: 1, stepName: 'Step 1', baseSalary: 12000.00, employees: 30 },
        { id: 27, gradeId: 6, stepLevel: 2, stepName: 'Step 2', baseSalary: 12500.00, employees: 25 },
        { id: 28, gradeId: 6, stepLevel: 3, stepName: 'Step 3', baseSalary: 13000.00, employees: 20 },
        { id: 29, gradeId: 6, stepLevel: 4, stepName: 'Step 4', baseSalary: 13500.00, employees: 10 },
        { id: 30, gradeId: 6, stepLevel: 5, stepName: 'Step 5', baseSalary: 14000.00, employees: 5 },
        { id: 31, gradeId: 7, stepLevel: 1, stepName: 'Step 1', baseSalary: 14500.00, employees: 25 },
        { id: 32, gradeId: 7, stepLevel: 2, stepName: 'Step 2', baseSalary: 15000.00, employees: 20 },
        { id: 33, gradeId: 7, stepLevel: 3, stepName: 'Step 3', baseSalary: 15500.00, employees: 18 },
        { id: 34, gradeId: 7, stepLevel: 4, stepName: 'Step 4', baseSalary: 16000.00, employees: 10 },
        { id: 35, gradeId: 7, stepLevel: 5, stepName: 'Step 5', baseSalary: 16500.00, employees: 5 }
    ];

    let selectedGradeId = null;

    // Department mapping for local display
    const departmentMap = {
        1: 'Engineering',
        2: 'Sales',
        3: 'Marketing',
        4: 'Operations',
        5: 'Finance',
        6: 'HR',
        7: 'Executive'
    };

    // --- Step rows management with indexed names (steps[0].stepName, steps[0].basicSalary) ---
    function refreshStepIndices() {
        const container = document.getElementById('stepsContainer');
        const rows = container.querySelectorAll('.step-row');
        rows.forEach((row, index) => {
            const nameInput = row.querySelector('input[name^="steps["]');
            const salaryInput = row.querySelector('input[name^="steps["][type="number"]');
            if (nameInput) {
                nameInput.name = `steps[${index}].stepName`;
            }
            if (salaryInput) {
                salaryInput.name = `steps[${index}].basicSalary`;
            }
        });
    }

    function addStepRow() {
        const container = document.getElementById('stepsContainer');
        const row = document.createElement('div');
        row.className = 'step-row flex items-center space-x-3 mb-3';
        const newIndex = container.children.length; // next index
        row.innerHTML = `
            <input type="text" name="steps[${newIndex}].stepName" placeholder="Step name (e.g. Entry, Junior)" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg dark:bg-gray-800" required>
            <div class="relative flex-1">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2">$</span>
                <input type="number" name="steps[${newIndex}].basicSalary" placeholder="Basic salary" min="0" step="0.01" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg dark:bg-gray-800" required>
            </div>
            <button type="button" onclick="removeStepRow(this)" class="p-2 text-gray-400 hover:text-red-600">
                <span class="material-icons-round text-sm">delete</span>
            </button>
        `;
        container.appendChild(row);
        // No need to refresh indices because we used the correct index at creation.
        // But if we ever reorder or remove, we need to re-index.
    }

    function removeStepRow(btn) {
        const container = document.getElementById('stepsContainer');
        if (container.children.length <= 1) {
            alert('At least one step is required.');
            return;
        }
        btn.closest('.step-row').remove();
        refreshStepIndices(); // renumber remaining rows
    }

    // --- Modal handlers ---
    function openModal(id) {
        if (id === 'addGradeModal') {
            document.getElementById('addGradeForm').reset();
            const container = document.getElementById('stepsContainer');
            container.innerHTML = '';
            addStepRow(); // one empty row with index 0
        }
        document.getElementById(id).classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // --- Load Grades cards (show department) ---
    function loadGrades() {
        const container = document.getElementById('gradesList');
        container.innerHTML = '';
        jobGrades.forEach(grade => {
            const el = document.createElement('div');
            el.className = `border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-primary-500 transition-colors cursor-pointer ${selectedGradeId === grade.id ? 'ring-2 ring-primary-500' : ''}`;
            el.onclick = () => selectGrade(grade.id);
            const steps = getStepsForGrade(grade.id);
            el.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <div class="step-level-indicator grade-color-${grade.level}">${grade.level}</div>
                        <div>
                            <h4 class="font-bold">${grade.name}</h4>
                            <p class="text-xs text-gray-500">${grade.department}</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="event.stopPropagation();editGrade(${grade.id})" class="p-1 text-gray-400 hover:text-primary-600"><span class="material-icons-round text-sm">edit</span></button>
                        <button onclick="event.stopPropagation();deleteGrade(${grade.id})" class="p-1 text-gray-400 hover:text-red-600"><span class="material-icons-round text-sm">delete</span></button>
                    </div>
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">${grade.description || '—'}</p>
                <div class="flex justify-between text-xs">
                    <span>${grade.employees} emp</span>
                    <span class="font-medium">${steps.length} steps</span>
                </div>
            `;
            container.appendChild(el);
        });
    }

    // --- Grade Details (displays step names) ---
    function loadGradeDetails(gradeId) {
        const grade = jobGrades.find(g => g.id === gradeId);
        if (!grade) return;
        const steps = getStepsForGrade(gradeId);
        const minSal = steps.length ? Math.min(...steps.map(s => s.baseSalary)) : 0;
        const maxSal = steps.length ? Math.max(...steps.map(s => s.baseSalary)) : 0;
        const avgSal = steps.length ? (steps.reduce((a,s)=>a+s.baseSalary,0)/steps.length).toFixed(2) : 0;

        let stepsHtml = '';
        steps.forEach((s, idx) => {
            stepsHtml += `<div class="flex justify-between items-center py-1 border-b border-gray-100 dark:border-gray-700 text-sm"><span>${s.stepName || 'Step ' + (idx+1)}</span><span class="font-mono">$${s.baseSalary.toFixed(2)}</span></div>`;
        });

        document.getElementById('gradeDetails').innerHTML = `
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold">${grade.name}</h3>
                    <span class="text-xs bg-primary-100 text-primary-800 px-2 py-1 rounded">${grade.department}</span>
                </div>
            </div>
            <div class="p-4 space-y-3">
                <p class="text-sm text-gray-600">${grade.description || 'No description'}</p>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div class="bg-gray-50 dark:bg-gray-750 p-2 rounded"><span class="block text-gray-500">Code</span><span class="font-medium">${grade.code}</span></div>
                    <div class="bg-gray-50 dark:bg-gray-750 p-2 rounded"><span class="block text-gray-500">Level</span><span class="font-medium">${grade.level}</span></div>
                </div>
                <div class="mt-4">
                    <h4 class="font-medium text-sm mb-2">Steps (${steps.length})</h4>
                    <div class="max-h-48 overflow-y-auto pr-1 border rounded p-2">${stepsHtml || '<p class="text-gray-400 italic">No steps defined</p>'}</div>
                </div>
                <div class="mt-3 pt-2 border-t border-gray-200 dark:border-gray-700 grid grid-cols-2 gap-2 text-xs">
                    <div><span class="text-gray-500">Range</span><div class="font-medium">$${minSal} – $${maxSal}</div></div>
                    <div><span class="text-gray-500">Avg salary</span><div class="font-medium">$${avgSal}</div></div>
                </div>
            </div>
        `;
    }

    function selectGrade(id) {
        selectedGradeId = id;
        loadGrades();
        loadGradeDetails(id);
    }

    function getStepsForGrade(gid) {
        return jobSteps.filter(s => s.gradeId === gid);
    }

    function updateStats() {
        document.getElementById('totalGrades').innerText = jobGrades.length;
        document.getElementById('totalSteps').innerText = jobSteps.length;
    }

    function deleteGrade(id) {
        if (!confirm('Delete grade and all its steps?')) return;
        jobGrades = jobGrades.filter(g => g.id !== id);
        jobSteps = jobSteps.filter(s => s.gradeId !== id);
        if (selectedGradeId === id) {
            selectedGradeId = null;
            document.getElementById('gradeDetails').innerHTML = `<div class="p-6 text-center text-gray-500">Select a grade</div>`;
        }
        loadGrades();
        updateStats();
        showNotification('Grade deleted', 'success');
    }

    function editGrade(id) {
        const grade = jobGrades.find(g => g.id === id);
        if (!grade) return;
        document.getElementById('editGradeId').value = grade.id;
        document.getElementById('editGradeName').value = grade.name;
        const deptSelect = document.getElementById('editGradeDept');
        // Find the numeric value for the department (reverse map)
        const deptId = Object.keys(departmentMap).find(key => departmentMap[key] === grade.department) || '';
        if (deptId) deptSelect.value = deptId;
        document.getElementById('editGradeCode').value = grade.code || '';
        document.getElementById('editGradeDescription').value = grade.description || '';
        openModal('editGradeModal');
    }

    function updateGrade(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const id = parseInt(formData.get('id'));
        const index = jobGrades.findIndex(g => g.id === id);
        if (index !== -1) {
            // Convert department ID back to name
            const deptId = formData.get('department');
            jobGrades[index].name = formData.get('name');
            jobGrades[index].department = departmentMap[deptId] || 'Unknown';
            jobGrades[index].code = formData.get('code');
            jobGrades[index].description = formData.get('description');
            closeModal('editGradeModal');
            loadGrades();
            if (selectedGradeId === id) loadGradeDetails(id);
            showNotification('Grade updated', 'success');
        }
    }

    function showNotification(msg, type) { alert(msg); } // simple

    // --- Disable submit button on form submission to prevent double posting ---
    function disableSubmitButton(form) {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerText = 'Submitting...';
        }
        return true; // allow form submission
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function() {
        const addForm = document.getElementById('addGradeForm');
        addForm.addEventListener('submit', function(e) {
            // Optional: perform any custom validation, then disable button
            if (!disableSubmitButton(this)) {
                e.preventDefault();
                return false;
            }
            // If using Thymeleaf, the form will submit normally.
        });

        document.getElementById('editGradeForm').addEventListener('submit', updateGrade);

        loadGrades();
        updateStats();
    });

    // Expose functions globally
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.addStepRow = addStepRow;
    window.removeStepRow = removeStepRow;
    window.selectGrade = selectGrade;
    window.editGrade = editGrade;
    window.deleteGrade = deleteGrade;
  </script>
</main>
</body>
</html>