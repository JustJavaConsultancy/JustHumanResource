<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="layouts/employeeLayout">
<head>
  <meta charset="UTF-8">
  <title>My Appraisals</title>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: {
              50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',
              400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',
              800:'#1e40af',900:'#1e3a8a'
            }
          }
        }
      }
    };
  </script>
  <style>
    * { font-family: 'Inter', sans-serif; }

    /* ── Badges ── */
    .badge { padding:.2rem .65rem; font-size:.68rem; font-weight:600; border-radius:9999px; letter-spacing:.02em; text-transform:uppercase; display:inline-flex; align-items:center; }
    .badge-success { background:#dcfce7; color:#15803d; }
    .badge-warning { background:#fef3c7; color:#b45309; }
    .badge-error   { background:#fee2e2; color:#b91c1c; }
    .badge-info    { background:#dbeafe; color:#1e40af; }
    .badge-neutral { background:#f3f4f6; color:#4b5563; }
    .badge-purple  { background:#f3e8ff; color:#7e22ce; }
    .badge-orange  { background:#fff7ed; color:#c2410c; }
    .dark .badge-success { background:#14532d; color:#86efac; }
    .dark .badge-warning { background:#92400e; color:#fde68a; }
    .dark .badge-info    { background:#1e3a8a; color:#bfdbfe; }
    .dark .badge-neutral { background:#374151; color:#d1d5db; }
    .dark .badge-purple  { background:#4c1d95; color:#d8b4fe; }
    .dark .badge-orange  { background:#7c2d12; color:#fed7aa; }

    /* ── Cards ── */
    .kpi-card { background:white; border-radius:1rem; border:1px solid #e5e7eb; }
    .dark .kpi-card { background:#1f2937; border-color:#374151; }
    .section-title { font-size:.72rem; font-weight:600; text-transform:uppercase; letter-spacing:.05em; color:#6b7280; }
    .dark .section-title { color:#9ca3af; }

    /* ── Progress bars ── */
    .progress-bar { height:8px; border-radius:4px; overflow:hidden; background:#e5e7eb; }
    .dark .progress-bar { background:#374151; }
    .progress-fill { height:100%; border-radius:4px; transition:width .3s; }
    .progress-bar-purple { height:8px; border-radius:4px; overflow:hidden; background:#f3e8ff; }
    .dark .progress-bar-purple { background:#4c1d95; }
    .progress-fill-purple { height:100%; border-radius:4px; background:linear-gradient(90deg,#9333ea,#7c3aed); transition:width .3s; }

    /* ── Self-review card ── */
    .self-review-card { background:white; border-radius:1rem; border:2px solid #e9d5ff; overflow:hidden; }
    .dark .self-review-card { background:#1f2937; border-color:#6b21a8; }
    .self-review-header { background:linear-gradient(135deg,#faf5ff 0%,#f3e8ff 100%); border-bottom:1px solid #e9d5ff; padding:1.25rem 1.5rem; }
    .dark .self-review-header { background:linear-gradient(135deg,rgba(88,28,135,.15) 0%,rgba(107,33,168,.1) 100%); border-bottom-color:#6b21a8; }

    /* ── Score ring ── */
    .score-ring { width:72px; height:72px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:conic-gradient(#9333ea 0deg,#e5e7eb 0deg); transition:background .4s; flex-shrink:0; }
    .score-ring-inner { width:54px; height:54px; border-radius:50%; background:white; display:flex; align-items:center; justify-content:center; flex-direction:column; }
    .dark .score-ring-inner { background:#1f2937; }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    input[type="number"] { -moz-appearance:textfield; }

    /* ── Buttons ── */
    .btn-submit { display:inline-flex; align-items:center; gap:8px; padding:.6rem 1.5rem; background:linear-gradient(135deg,#9333ea,#7c3aed); color:white; border:none; border-radius:.625rem; font-size:.875rem; font-weight:600; cursor:pointer; transition:opacity .2s,transform .15s,box-shadow .2s; box-shadow:0 4px 12px rgba(147,51,234,.35); }
    .btn-submit:hover { opacity:.92; transform:translateY(-1px); }
    .btn-submit:disabled { opacity:.5; cursor:not-allowed; transform:none; }

    /* ── Textarea focus ── */
    textarea.self-comment-input:focus { outline:none; border-color:#9333ea !important; box-shadow:0 0 0 3px rgba(147,51,234,.15); }
    .char-counter { font-size:.7rem; color:#9ca3af; }
    .char-counter.warn { color:#f59e0b; }
    .char-counter.over { color:#ef4444; }

    /* ── Process timeline ── */
    .step-connector { width:2px; height:2.5rem; background:#e5e7eb; margin:4px 0; }
    .step-connector.done { background:#22c55e; }
    .step-connector.active { background:linear-gradient(#9333ea,#e5e7eb); }
    .dark .step-connector { background:#374151; }

    /* ── Manager pending banner ── */
    .manager-pending-banner { display:flex; align-items:center; gap:10px; background:#fff7ed; border:1px solid #fed7aa; border-radius:.75rem; padding:.85rem 1rem; }
    .dark .manager-pending-banner { background:rgba(120,53,15,.2); border-color:#92400e; }

    /* ── Submitted overlay ── */
    .submitted-readonly { background:#f0fdf4; border:1px solid #bbf7d0; border-radius:.75rem; padding:1rem 1.25rem; }
    .dark .submitted-readonly { background:rgba(20,83,45,.2); border-color:#166534; }

    /* ── Task separator ── */
    .task-block + .task-block { margin-top: 3rem; padding-top: 2rem; border-top: 2px dashed #e5e7eb; }
    .dark .task-block + .task-block { border-color: #374151; }

    /* ── Empty state ── */
    .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:3rem; text-align:center; }
  </style>
</head>
<body>
<main layout:fragment="content">

  <!-- ══════════════════════════════════════════════════════════════
       PAGE HEADER
  ══════════════════════════════════════════════════════════════ -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center">
        <span class="material-icons-round text-blue-600 dark:text-blue-400">assignment_turned_in</span>
      </div>
      <div>
        <h3 class="text-lg font-bold text-gray-900 dark:text-white">My Appraisal Tasks</h3>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          <!-- Show count of pending tasks -->
          <span th:text="${tasks != null ? tasks.size() : 0}">0</span> task(s) awaiting your action
        </p>
      </div>
    </div>
    <!-- Summary badges -->
    <div class="flex items-center gap-2 flex-wrap" th:if="${tasks != null and !tasks.isEmpty()}">
      <span th:each="task : ${tasks}"
            th:with="selfDone=${task.variables['selfComplete']}"
            th:class="${selfDone} ? 'badge badge-success' : 'badge badge-purple'"
            th:text="${task.businessKey}">
      </span>
    </div>
  </div>

  <!-- ══════════════════════════════════════════════════════════════
       EMPTY STATE — no tasks
  ══════════════════════════════════════════════════════════════ -->
  <div th:if="${tasks == null or tasks.isEmpty()}" class="kpi-card empty-state mb-6">
    <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-4">
      <span class="material-icons-round text-green-600 dark:text-green-400" style="font-size:32px;">check_circle</span>
    </div>
    <h4 class="text-base font-semibold text-gray-800 dark:text-white mb-1">No Pending Appraisal Tasks</h4>
    <p class="text-sm text-gray-500 dark:text-gray-400">You have no self-appraisal tasks to complete right now.</p>
  </div>

  <!-- ══════════════════════════════════════════════════════════════
       TASK LOOP — one block per task
  ══════════════════════════════════════════════════════════════ -->
  <div th:each="task, taskStat : ${tasks}"
       th:with="
  selfComplete=${task.variables['selfComplete']},
  managerComplete=${task.variables['managerComplete']},
  kpiScoreVar=${task.variables['kpiScore']},
  appraisalIdVar=${task.variables['appraisalId']},
  appraisal=${appraisalMap[task.variables['appraisalId']]},
  processComplete=${selfComplete and managerComplete}
"
       class="task-block">

    <!-- ── Task Header Banner ── -->
    <div th:class="${selfComplete} ? 'flex items-center gap-3 bg-green-50 dark:bg-green-900/10 border border-green-200 dark:border-green-800 rounded-xl p-3.5 mb-6'
                                  : 'flex items-center gap-3 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-xl p-3.5 mb-6'">
      <div th:class="${selfComplete} ? 'w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/40 flex items-center justify-center flex-shrink-0'
                                    : 'w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/40 flex items-center justify-center flex-shrink-0'">
        <span th:class="${selfComplete} ? 'material-icons-round text-green-600 dark:text-green-400'
                                       : 'material-icons-round text-purple-600 dark:text-purple-400'"
              style="font-size:17px;"
              th:text="${selfComplete} ? 'check_circle' : 'edit_note'">edit_note</span>
      </div>
      <div class="flex-1">
        <p th:class="${selfComplete} ? 'text-sm font-semibold text-green-800 dark:text-green-300'
                                    : 'text-sm font-semibold text-purple-800 dark:text-purple-300'"
           th:text="${selfComplete} ? 'Self-review submitted — waiting for manager' : 'Action Required: Your self-review is open'">
        </p>
        <p th:class="${selfComplete} ? 'text-xs text-green-600 dark:text-green-400 mt-0.5'
                                    : 'text-xs text-purple-600 dark:text-purple-400 mt-0.5'">
          Task: <strong th:text="${task.taskName}">Self Appraisal</strong>
          &nbsp;·&nbsp; Cycle:
          <strong th:text="${appraisal != null and appraisal.cycle != null} ? ${appraisal.cycle.name} : ${task.businessKey}">Q1 2026</strong>
          &nbsp;·&nbsp; Opened:
          <strong th:text="${#temporals.format(task.createdTime, 'dd MMM yyyy, HH:mm')}">28 Feb 2026</strong>
        </p>
      </div>
      <a th:if="${!selfComplete}"
         th:href="'#review-form-' + ${task.taskId}"
         class="text-xs font-semibold text-purple-700 dark:text-purple-300 underline underline-offset-2 whitespace-nowrap hover:text-purple-900">
        Go to form ↓
      </a>
    </div>

    <!-- ── Score Summary Card ── -->
    <div class="kpi-card p-5 md:p-6 mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-750 border border-blue-100 dark:border-blue-900">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-center space-x-4">
          <!-- KPI score circle -->
          <div class="w-16 h-16 bg-white dark:bg-gray-800 rounded-full flex items-center justify-center shadow-md flex-shrink-0">
            <span class="text-xl font-bold text-blue-600 dark:text-blue-400"
                  th:text="${appraisal != null and appraisal.kpiScore != null} ? ${#numbers.formatDecimal(appraisal.kpiScore, 1, 2)} : (${kpiScoreVar} ?: '—')">
              71.43
            </span>
          </div>
          <div>
            <p class="text-sm text-gray-600 dark:text-gray-300">System KPI Score</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"
               th:text="'Calculated by HR — ' + (${appraisal != null and appraisal.cycle != null} ? ${appraisal.cycle.name} : ${task.businessKey})">
            </p>
          </div>
        </div>
        <div class="flex items-center gap-5 flex-wrap">
          <!-- Self Score -->
          <div class="text-center">
            <span class="text-xs text-gray-500 dark:text-gray-400">Self Score</span>
            <p th:if="${appraisal != null and appraisal.selfScore != null}"
               class="text-lg font-semibold text-purple-600 dark:text-purple-400"
               th:text="${#numbers.formatDecimal(appraisal.selfScore, 1, 2)}">—</p>
            <p th:if="${appraisal == null or appraisal.selfScore == null}"
               class="text-lg font-semibold text-gray-400">Pending</p>
          </div>
          <!-- Manager Score -->
          <div class="text-center">
            <span class="text-xs text-gray-500 dark:text-gray-400">Manager Score</span>
            <p th:if="${appraisal != null and appraisal.managerScore != null}"
               class="text-lg font-semibold text-green-600 dark:text-green-400"
               th:text="${#numbers.formatDecimal(appraisal.managerScore, 1, 2)}">—</p>
            <p th:if="${appraisal == null or appraisal.managerScore == null}"
               class="text-lg font-semibold text-gray-400">Pending</p>
          </div>
          <!-- Final Score — only when process complete -->
          <div class="text-center">
            <span class="text-xs text-gray-500 dark:text-gray-400">Final Score</span>
            <p th:if="${processComplete and appraisal != null and appraisal.finalScore != null}"
               class="text-lg font-semibold text-emerald-600 dark:text-emerald-400"
               th:text="${#numbers.formatDecimal(appraisal.finalScore, 1, 2)}">—</p>
            <p th:if="${!processComplete or appraisal == null or appraisal.finalScore == null}"
               class="text-lg font-semibold text-gray-300">—</p>
          </div>
          <!-- Outcome badge — only when process complete -->
          <div class="text-center" th:if="${processComplete and appraisal != null and appraisal.outcome != null}">
            <span class="text-xs text-gray-500 dark:text-gray-400 block mb-1">Outcome</span>
            <span th:switch="${appraisal.outcome.name()}">
              <span th:case="'EXCEEDS_EXPECTATION'" class="badge badge-success" th:text="${appraisal.outcome}"></span>
              <span th:case="'MEETS_EXPECTATION'"   class="badge badge-info"    th:text="${appraisal.outcome}"></span>
              <span th:case="'NEEDS_IMPROVEMENT'"   class="badge badge-warning" th:text="${appraisal.outcome}"></span>
              <span th:case="*"                     class="badge badge-neutral" th:text="${appraisal.outcome}"></span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════
         APPRAISAL PROCESS TIMELINE
    ════════════════════════════════════════════════════════════ -->
    <div class="kpi-card p-5 md:p-6 mb-6">
      <div class="flex items-center space-x-2 mb-5">
        <span class="material-icons-round text-blue-600 dark:text-blue-400">account_tree</span>
        <h4 class="section-title mb-0">Appraisal Process</h4>
        <span th:if="${processComplete}"    class="badge badge-success ml-2">Completed</span>
        <span th:if="${!processComplete}"   class="badge badge-warning ml-2">In Progress</span>
      </div>

      <div class="flex flex-col gap-0">

        <!-- Step 1: Self Appraisal -->
        <div class="flex items-start gap-4">
          <div class="flex flex-col items-center flex-shrink-0">
            <!-- Done icon if selfComplete, active if not -->
            <div th:if="${selfComplete}"
                 class="w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 border-2 border-green-500 flex items-center justify-center">
              <span class="material-icons-round text-green-600 dark:text-green-400" style="font-size:18px;">check</span>
            </div>
            <div th:if="${!selfComplete}"
                 class="w-9 h-9 rounded-full bg-purple-100 dark:bg-purple-900/30 border-2 border-purple-400 flex items-center justify-center">
              <span class="material-icons-round text-purple-600 dark:text-purple-400" style="font-size:18px;">person</span>
            </div>
            <div th:class="${selfComplete} ? 'step-connector done' : 'step-connector active'"></div>
          </div>
          <div class="pt-1 pb-6 flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="font-semibold text-sm text-gray-900 dark:text-white">Self Appraisal</span>
              <span th:if="${selfComplete}"  class="badge badge-success">Submitted</span>
              <span th:if="${!selfComplete}" class="badge badge-purple">In Progress</span>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
              Employee submits self-score and review comment.
            </p>
            <!-- Show submitted details if done -->
            <div th:if="${selfComplete and appraisal != null}" class="mt-2 flex items-center gap-3 flex-wrap text-xs text-gray-500 dark:text-gray-400">
              <span th:if="${appraisal.selfScore != null}">
                Score submitted: <strong class="text-purple-600 dark:text-purple-400" th:text="${#numbers.formatDecimal(appraisal.selfScore,1,2)}"></strong>
              </span>
              <span th:if="${appraisal.selfCompletedAt != null}">
                · Submitted at: <strong th:text="${#temporals.format(appraisal.selfCompletedAt,'dd MMM yyyy, HH:mm')}"></strong>
              </span>
            </div>
            <p class="text-xs text-gray-400 mt-0.5">
              Task opened: <span th:text="${#temporals.format(task.createdTime,'dd MMM yyyy, HH:mm')}"></span>
            </p>
          </div>
        </div>

        <!-- Step 2: Manager Review -->
        <div class="flex items-start gap-4">
          <div class="flex flex-col items-center flex-shrink-0">
            <div th:if="${managerComplete}"
                 class="w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 border-2 border-green-500 flex items-center justify-center">
              <span class="material-icons-round text-green-600 dark:text-green-400" style="font-size:18px;">check</span>
            </div>
            <div th:if="${selfComplete and !managerComplete}"
                 class="w-9 h-9 rounded-full bg-orange-100 dark:bg-orange-900/30 border-2 border-orange-400 flex items-center justify-center">
              <span class="material-icons-round text-orange-500" style="font-size:18px;">hourglass_top</span>
            </div>
            <div th:if="${!selfComplete and !managerComplete}"
                 class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center">
              <span class="material-icons-round text-gray-400" style="font-size:18px;">manage_accounts</span>
            </div>
            <div th:class="${managerComplete} ? 'step-connector done' : 'step-connector'"></div>
          </div>
          <div class="pt-1 pb-6 flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="font-semibold text-sm"
                    th:class="${managerComplete} ? 'font-semibold text-sm text-gray-900 dark:text-white' : 'font-semibold text-sm text-gray-500 dark:text-gray-400'">
                Manager Review
              </span>
              <span th:if="${managerComplete}"                 class="badge badge-success">Completed</span>
              <span th:if="${selfComplete and !managerComplete}" class="badge badge-orange">Awaiting Manager</span>
              <span th:if="${!selfComplete}"                   class="badge badge-neutral">Waiting</span>
            </div>
            <p class="text-xs text-gray-400 mt-1">
              Manager adds a subjective score and comment after the employee submits.
            </p>
            <!-- Show manager details if done -->
            <div th:if="${managerComplete and appraisal != null}" class="mt-2 flex items-center gap-3 flex-wrap text-xs text-gray-500 dark:text-gray-400">
              <span th:if="${appraisal.managerScore != null}">
                Manager score: <strong class="text-green-600 dark:text-green-400" th:text="${#numbers.formatDecimal(appraisal.managerScore,1,2)}"></strong>
              </span>
            </div>
          </div>
        </div>

        <!-- Step 3: Final Score -->
        <div class="flex items-start gap-4">
          <div class="flex flex-col items-center flex-shrink-0">
            <div th:if="${processComplete}"
                 class="w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 border-2 border-green-500 flex items-center justify-center">
              <span class="material-icons-round text-green-600 dark:text-green-400" style="font-size:18px;">emoji_events</span>
            </div>
            <div th:if="${!processComplete}"
                 class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 flex items-center justify-center">
              <span class="material-icons-round text-gray-300 dark:text-gray-500" style="font-size:18px;">lock</span>
            </div>
          </div>
          <div class="pt-1 flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="font-semibold text-sm"
                    th:class="${processComplete} ? 'font-semibold text-sm text-gray-900 dark:text-white' : 'font-semibold text-sm text-gray-400 dark:text-gray-500'">
                Final Score &amp; Outcome
              </span>
              <span th:if="${processComplete}"  class="badge badge-success">Finalised</span>
              <span th:if="${!processComplete}" class="badge badge-neutral">Locked</span>
            </div>
            <p class="text-xs text-gray-400 mt-1">
              Final score is calculated once both parties complete their reviews.
            </p>
          </div>
        </div>
      </div>

      <!-- Manager pending notice (only when self done but manager not) -->
      <div th:if="${selfComplete and !managerComplete}" class="manager-pending-banner mt-5">
        <div class="w-8 h-8 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center flex-shrink-0">
          <span class="material-icons-round text-orange-500" style="font-size:18px;">hourglass_top</span>
        </div>
        <div>
          <p class="text-sm font-semibold text-orange-800 dark:text-orange-300">Final score not yet available</p>
          <p class="text-xs text-orange-600 dark:text-orange-400 mt-0.5">
            Your self-review has been submitted. You are waiting for your manager to complete their review.
            The final score, outcome, and manager's comment will appear once the appraisal is fully complete.
          </p>
        </div>
      </div>

      <!-- Both pending notice -->
      <div th:if="${!selfComplete and !managerComplete}" class="manager-pending-banner mt-5">
        <div class="w-8 h-8 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center flex-shrink-0">
          <span class="material-icons-round text-orange-500" style="font-size:18px;">info</span>
        </div>
        <div>
          <p class="text-sm font-semibold text-orange-800 dark:text-orange-300">Final score not yet available</p>
          <p class="text-xs text-orange-600 dark:text-orange-400 mt-0.5">
            Complete your self-review below. Your manager will then score and comment. The final score will be available once both steps are complete.
          </p>
        </div>
      </div>

      <!-- Process complete: final score revealed -->
      <div th:if="${processComplete and appraisal != null}" class="mt-5 p-4 bg-green-50 dark:bg-green-900/10 border border-green-200 dark:border-green-800 rounded-xl">
        <p class="text-xs font-semibold text-green-700 dark:text-green-400 uppercase tracking-wider mb-3">
          <span class="material-icons-round align-text-bottom" style="font-size:14px;">emoji_events</span>
          Appraisal Complete — Final Results
        </p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="p-3 bg-white dark:bg-gray-800 rounded-lg text-center">
            <p class="text-xs text-gray-400 mb-1">KPI Score</p>
            <p class="text-xl font-bold text-blue-600" th:text="${appraisal.kpiScore != null ? #numbers.formatDecimal(appraisal.kpiScore,1,2) : '—'}"></p>
          </div>
          <div class="p-3 bg-white dark:bg-gray-800 rounded-lg text-center">
            <p class="text-xs text-gray-400 mb-1">Self Score</p>
            <p class="text-xl font-bold text-purple-600" th:text="${appraisal.selfScore != null ? #numbers.formatDecimal(appraisal.selfScore,1,2) : '—'}"></p>
          </div>
          <div class="p-3 bg-white dark:bg-gray-800 rounded-lg text-center">
            <p class="text-xs text-gray-400 mb-1">Manager Score</p>
            <p class="text-xl font-bold text-green-600" th:text="${appraisal.managerScore != null ? #numbers.formatDecimal(appraisal.managerScore,1,2) : '—'}"></p>
          </div>
          <div class="p-3 bg-white dark:bg-gray-800 rounded-lg text-center border-2 border-emerald-300 dark:border-emerald-700">
            <p class="text-xs text-gray-400 mb-1">Final Score</p>
            <p class="text-xl font-bold text-emerald-600 dark:text-emerald-400" th:text="${appraisal.finalScore != null ? #numbers.formatDecimal(appraisal.finalScore,1,2) : '—'}"></p>
          </div>
        </div>
        <!-- Manager comment -->
        <div th:if="${appraisal.managerComment != null and !#strings.isEmpty(appraisal.managerComment)}"
             class="mt-3 p-3 bg-white dark:bg-gray-800 rounded-lg">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Manager's Comment</p>
          <p class="text-sm text-gray-700 dark:text-gray-300 italic" th:text="${appraisal.managerComment}"></p>
        </div>
        <div th:if="${appraisal.completedAt != null}" class="mt-2 text-xs text-gray-400 text-right">
          Completed: <span th:text="${#temporals.format(appraisal.completedAt,'dd MMM yyyy, HH:mm')}"></span>
        </div>
      </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════
         SELF-REVIEW FORM SECTION
         Shown: selfComplete = false
         Hidden: selfComplete = true (show read-only instead)
    ════════════════════════════════════════════════════════════ -->
    <div th:id="'review-form-' + ${task.taskId}" class="self-review-card mb-6 scroll-mt-6">

      <!-- Card Header -->
      <div class="self-review-header flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-full bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center">
            <span class="material-icons-round text-purple-600 dark:text-purple-400" style="font-size:20px;">person</span>
          </div>
          <div>
            <div class="flex items-center gap-2">
              <h4 class="font-bold text-gray-900 dark:text-white text-base" th:text="${task.taskName}">Self Appraisal</h4>
              <span class="badge badge-purple"
                    th:text="${appraisal != null and appraisal.cycle != null} ? ${appraisal.cycle.name} : ${task.businessKey}">
                Q1 2026
              </span>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
              Rate your own performance and leave a comment for your manager
            </p>
          </div>
        </div>
        <!-- KPI score pill -->
        <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white dark:bg-gray-800 border border-purple-200 dark:border-purple-700 shadow-sm text-xs font-semibold text-purple-700 dark:text-purple-300 self-start sm:self-auto">
          <span class="material-icons-round" style="font-size:13px;">bar_chart</span>
          KPI Score:
          <span th:text="${appraisal != null and appraisal.kpiScore != null} ? ${#numbers.formatDecimal(appraisal.kpiScore,1,2)} : ${kpiScoreVar}">71.43</span>
        </div>
      </div>

      <!-- Card Body -->
      <div class="p-5 md:p-6">

        <!-- ── READ-ONLY: Self review already submitted ── -->
        <div th:if="${selfComplete}" class="submitted-readonly">
          <div class="flex items-start gap-3">
            <div class="w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0">
              <span class="material-icons-round text-green-600 dark:text-green-400" style="font-size:20px;">check_circle</span>
            </div>
            <div class="flex-1">
              <p class="font-semibold text-sm text-green-800 dark:text-green-300">Self-review submitted</p>
              <p class="text-xs text-green-600 dark:text-green-400 mt-0.5">
                Your self-review has been recorded and is now with your manager.
              </p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                  <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Your Self Score</p>
                  <p class="text-2xl font-bold text-purple-600 dark:text-purple-400"
                     th:text="${appraisal != null and appraisal.selfScore != null} ? ${#numbers.formatDecimal(appraisal.selfScore,1,2)} : '—'">—</p>
                </div>
                <div th:if="${appraisal != null and appraisal.selfCompletedAt != null}">
                  <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Submitted At</p>
                  <p class="text-sm text-gray-700 dark:text-gray-300"
                     th:text="${#temporals.format(appraisal.selfCompletedAt,'dd MMM yyyy, HH:mm')}"></p>
                </div>
              </div>
              <div th:if="${appraisal != null and appraisal.selfComment != null and !#strings.isEmpty(appraisal.selfComment)}"
                   class="mt-3">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Your Comment</p>
                <p class="text-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-100 dark:border-gray-700"
                   th:text="${appraisal.selfComment}"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- ── FORM: Self review not yet submitted ── -->
        <div th:if="${!selfComplete}">
          <!--
            Form submits to /finalize-appraisal via POST.
            taskId is carried as a hidden input.
            The JS reads data-kpi-score from the form wrapper for live comparison.
          -->
          <form th:action="@{/employee/self-review}"
                method="post"
                th:id="'selfReviewForm_' + ${task.taskId}"
                th:attr="data-kpi-score=${appraisal != null and appraisal.kpiScore != null} ? ${appraisal.kpiScore} : ${kpiScoreVar},
                         data-task-idx=${taskStat.index}">

            <!-- Hidden: taskId -->
            <input type="hidden" name="taskId" th:value="${task.taskId}">

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

              <!-- ── Left: Score input ── -->
              <div class="lg:col-span-2 flex flex-col">
                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
                  Self Score
                </label>

                <!-- Ring + input -->
                <div class="flex items-center gap-4 mb-4">
                  <div class="score-ring" th:id="'scoreRing_' + ${taskStat.index}">
                    <div class="score-ring-inner">
                      <span class="text-lg font-bold text-purple-700 dark:text-purple-300 leading-none"
                            th:id="'ringValue_' + ${taskStat.index}">—</span>
                      <span class="text-xs text-gray-400 leading-none">/100</span>
                    </div>
                  </div>
                  <div class="flex-1">
                    <input type="number"
                           name="selfScore"
                           th:id="'selfScoreInput_' + ${taskStat.index}"
                           min="0" max="100" step="0.1"
                           placeholder="0.0"
                           th:attr="oninput='onScoreInput(this,' + ${taskStat.index} + ')'"
                           class="w-full px-4 py-2.5 bg-white dark:bg-gray-800 border-2 border-purple-200 dark:border-purple-700 rounded-lg text-gray-900 dark:text-white font-bold text-xl focus:ring-0 focus:border-purple-500 dark:focus:border-purple-400 outline-none"
                           style="font-family:'Courier New',monospace;">
                    <p class="text-xs text-gray-400 mt-1.5">Enter a value between 0 and 100</p>
                  </div>
                </div>

                <!-- Purple progress bar -->
                <div class="progress-bar-purple mb-1">
                  <div class="progress-fill-purple" th:id="'selfScoreBar_' + ${taskStat.index}" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-1 mb-4">
                  <span>0</span>
                  <span class="font-medium" th:id="'scoreOutcomeLabel_' + ${taskStat.index}">—</span>
                  <span>100</span>
                </div>

                <!-- Score comparison box -->
                <div class="mt-auto p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-100 dark:border-gray-700">
                  <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Score Comparison</p>
                  <div class="space-y-1.5">
                    <div class="flex items-center justify-between text-xs">
                      <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                        <span class="text-gray-600 dark:text-gray-400">System KPI Score</span>
                      </div>
                      <span class="font-bold text-gray-900 dark:text-white" style="font-family:monospace;"
                            th:text="${appraisal != null and appraisal.kpiScore != null} ? ${#numbers.formatDecimal(appraisal.kpiScore,1,2)} : ${kpiScoreVar}">
                        71.43
                      </span>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                      <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                        <span class="text-gray-600 dark:text-gray-400">Your Self Score</span>
                      </div>
                      <span class="font-bold text-purple-700 dark:text-purple-300"
                            th:id="'selfScoreDisplay_' + ${taskStat.index}"
                            style="font-family:monospace;">—</span>
                    </div>
                    <div class="flex items-center justify-between text-xs border-t border-gray-200 dark:border-gray-600 pt-1.5 mt-1.5">
                      <span class="text-gray-500">Difference</span>
                      <span class="font-semibold" th:id="'scoreDiff_' + ${taskStat.index}">—</span>
                    </div>
                  </div>
                </div>
              </div><!-- /left col -->

              <!-- ── Right: Comment ── -->
              <div class="lg:col-span-3 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                  <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                    Self-Review Comment
                  </label>
                  <span class="char-counter" th:id="'charCounter_' + ${taskStat.index}">0 / 2000</span>
                </div>

                <textarea name="selfComment"
                          maxlength="2000"
                          rows="8"
                          th:id="'selfComment_' + ${taskStat.index}"
                          th:attr="oninput='onCommentInput(this,' + ${taskStat.index} + ')'"
                          placeholder="Describe your performance this period…&#10;&#10;• What did you achieve?&#10;• What challenges did you face?&#10;• What would you improve?"
                          class="self-comment-input flex-1 w-full px-4 py-3 bg-white dark:bg-gray-800 border-2 border-purple-200 dark:border-purple-700 rounded-xl text-sm text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 resize-none"
                          style="min-height:180px;"></textarea>

                <!-- Quick-add chips -->
                <div class="flex flex-wrap gap-2 mt-3">
                  <span class="text-xs text-gray-400">Quick add:</span>
                  <button type="button"
                          th:attr="onclick='appendPrompt(\'I exceeded my target on \',' + ${taskStat.index} + ')'"
                          class="text-xs px-2.5 py-1 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded-full border border-purple-200 dark:border-purple-700 hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-colors">
                    + Exceeded target
                  </button>
                  <button type="button"
                          th:attr="onclick='appendPrompt(\'I faced challenges with \',' + ${taskStat.index} + ')'"
                          class="text-xs px-2.5 py-1 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded-full border border-purple-200 dark:border-purple-700 hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-colors">
                    + Challenge faced
                  </button>
                  <button type="button"
                          th:attr="onclick='appendPrompt(\'Next period, I plan to improve \',' + ${taskStat.index} + ')'"
                          class="text-xs px-2.5 py-1 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded-full border border-purple-200 dark:border-purple-700 hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-colors">
                    + Improvement plan
                  </button>
                </div>
              </div><!-- /right col -->
            </div>

            <!-- Validation message -->
            <div th:id="'validationMsg_' + ${taskStat.index}"
                 class="hidden mt-4 flex items-center gap-2 text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg px-4 py-2.5">
              <span class="material-icons-round" style="font-size:16px;">error_outline</span>
              <span th:id="'validationText_' + ${taskStat.index}"></span>
            </div>

            <!-- Form Footer -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mt-5 pt-5 border-t border-purple-100 dark:border-purple-900">
              <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1.5">
                <span class="material-icons-round text-gray-400" style="font-size:14px;">info</span>
                Your self-review is visible only to you and your manager.
              </p>
              <div class="flex items-center gap-3 self-end sm:self-auto">
                <button type="button"
                        th:attr="onclick='clearForm(' + ${taskStat.index} + ')'"
                        class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                  Clear
                </button>
                <button type="submit"
                        th:id="'submitBtn_' + ${taskStat.index}"
                        th:attr="onclick='submitSelfReview(' + ${taskStat.index} + ')'"
                        class="btn-submit">
                  <span class="material-icons-round" style="font-size:17px;">send</span>
                  Submit Self-Review
                </button>
              </div>
            </div>

          </form><!-- /form -->
        </div><!-- /if not selfComplete -->

      </div><!-- /card body -->
    </div><!-- /self-review-card -->

  </div><!-- /task-block th:each -->

  <!-- Footer note -->
  <div class="mt-6 text-center text-xs text-gray-500 dark:text-gray-400">
    <span class="material-icons-round text-xs align-text-bottom mr-1">lock</span>
    KPI data is managed by HR. For questions, contact your manager or HR representative.
  </div>

  <!-- ══════════════════════════════════════════════════════════════
       JAVASCRIPT
  ══════════════════════════════════════════════════════════════ -->
  <script th:inline="javascript">
    /**
     * Each form is identified by its taskStat.index (idx).
     * kpiScores is a map: idx -> kpiScore value, read from the form's data attribute.
     */
    function getKpiScore(idx) {
      const form = document.getElementById('selfReviewForm_' + idx);
      return form ? parseFloat(form.dataset.kpiScore) || 0 : 0;
    }

    /* ── Score ring ─────────────────────────────────────────── */
    function onScoreInput(input, idx) {
      const val  = input.value;
      const n    = parseFloat(val);
      const KPI  = getKpiScore(idx);

      const bar      = document.getElementById('selfScoreBar_'     + idx);
      const ring     = document.getElementById('scoreRing_'        + idx);
      const ringVal  = document.getElementById('ringValue_'        + idx);
      const selfDisp = document.getElementById('selfScoreDisplay_' + idx);
      const diff     = document.getElementById('scoreDiff_'        + idx);
      const label    = document.getElementById('scoreOutcomeLabel_'+ idx);

      if (isNaN(n) || val === '') {
        bar.style.width = '0%';
        ring.style.background = 'conic-gradient(#9333ea 0deg,#e5e7eb 0deg)';
        ringVal.textContent = '—'; selfDisp.textContent = '—';
        diff.textContent = '—'; diff.className = 'font-semibold text-gray-500';
        label.textContent = '—'; return;
      }
      const c   = Math.min(Math.max(n, 0), 100);
      const deg = (c / 100) * 360;
      bar.style.width = c + '%';
      ring.style.background = `conic-gradient(#9333ea ${deg}deg,#e5e7eb ${deg}deg)`;
      ringVal.textContent = c.toFixed(1);
      selfDisp.textContent = c.toFixed(1);

      const delta = (c - KPI).toFixed(1);
      if (delta > 0)      { diff.textContent = '+' + delta; diff.className = 'font-semibold text-green-600'; }
      else if (delta < 0) { diff.textContent = delta;       diff.className = 'font-semibold text-red-500';   }
      else                { diff.textContent = '0.0';       diff.className = 'font-semibold text-gray-500';  }

      label.textContent = scoreToLabel(c);
    }

    function scoreToLabel(s) {
      if (s >= 80) return 'Exceeds';
      if (s >= 60) return 'Meets';
      if (s >= 40) return 'Needs Improvement';
      return 'Unsatisfactory';
    }

    /* ── Char counter ───────────────────────────────────────── */
    function onCommentInput(el, idx) {
      const len = el.value.length;
      const c   = document.getElementById('charCounter_' + idx);
      c.textContent = len + ' / 2000';
      c.className   = 'char-counter' + (len >= 2000 ? ' over' : len >= 1800 ? ' warn' : '');
    }

    /* ── Quick-prompt chips ─────────────────────────────────── */
    function appendPrompt(text, idx) {
      const ta  = document.getElementById('selfComment_' + idx);
      const sep = ta.value.length > 0 && !ta.value.endsWith('\n') ? '\n' : '';
      ta.value += sep + text; ta.focus(); onCommentInput(ta, idx);
    }

    /* ── Validation helpers ─────────────────────────────────── */
    function showError(idx, msg) {
      const el = document.getElementById('validationMsg_' + idx);
      document.getElementById('validationText_' + idx).textContent = msg;
      el.classList.remove('hidden'); el.classList.add('flex');
    }
    function hideError(idx) {
      const el = document.getElementById('validationMsg_' + idx);
      el.classList.add('hidden'); el.classList.remove('flex');
    }

    /* ── Submit (client-side validation, then native form submit) ── */
    function submitSelfReview(idx) {
      hideError(idx);
      const scoreInput = document.getElementById('selfScoreInput_' + idx);
      const comment    = document.getElementById('selfComment_'    + idx).value.trim();
      const score      = parseFloat(scoreInput.value);

      if (scoreInput.value === '' || isNaN(score)) {
        showError(idx, 'Please enter your self score before submitting.'); scoreInput.focus(); return;
      }
      if (score < 0 || score > 100) {
        showError(idx, 'Score must be between 0 and 100.'); scoreInput.focus(); return;
      }
      if (comment.length < 20) {
        showError(idx, 'Please add a comment of at least 20 characters so your manager understands your assessment.');
        document.getElementById('selfComment_' + idx).focus(); return;
      }

      const btn = document.getElementById('submitBtn_' + idx);
      btn.disabled = true;
      btn.innerHTML = `<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
      </svg> Submitting…`;

      // Native form submit (Thymeleaf POST to /finalize-appraisal)
      document.getElementById('selfReviewForm_' + idx).submit();
    }

    /* ── Clear form ─────────────────────────────────────────── */
    function clearForm(idx) {
      const scoreInput = document.getElementById('selfScoreInput_' + idx);
      const commentEl  = document.getElementById('selfComment_'    + idx);
      scoreInput.value = ''; commentEl.value = '';
      onScoreInput(scoreInput, idx);
      onCommentInput(commentEl, idx);
      hideError(idx);
    }
  </script>

</main>
</body>
</html>