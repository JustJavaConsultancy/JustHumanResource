<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="layouts/employeeLayout">
<head>
  <meta charset="UTF-8">
  <title>My Appraisals</title>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: {
              50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',
              400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',
              800:'#1e40af',900:'#1e3a8a'
            }
          }
        }
      }
    };
  </script>
  <style>
    * { font-family: 'Inter', sans-serif; }

    .badge { padding:.2rem .65rem; font-size:.68rem; font-weight:600; border-radius:9999px; letter-spacing:.02em; text-transform:uppercase; display:inline-flex; align-items:center; }
    .badge-success { background:#dcfce7; color:#15803d; }
    .badge-warning { background:#fef3c7; color:#b45309; }
    .badge-error   { background:#fee2e2; color:#b91c1c; }
    .badge-info    { background:#dbeafe; color:#1e40af; }
    .badge-neutral { background:#f3f4f6; color:#4b5563; }
    .badge-purple  { background:#f3e8ff; color:#7e22ce; }
    .badge-orange  { background:#fff7ed; color:#c2410c; }
    .dark .badge-success { background:#14532d; color:#86efac; }
    .dark .badge-warning { background:#92400e; color:#fde68a; }
    .dark .badge-info    { background:#1e3a8a; color:#bfdbfe; }
    .dark .badge-neutral { background:#374151; color:#d1d5db; }
    .dark .badge-purple  { background:#4c1d95; color:#d8b4fe; }
    .dark .badge-orange  { background:#7c2d12; color:#fed7aa; }

    .kpi-card { background:white; border-radius:1rem; border:1px solid #e5e7eb; }
    .dark .kpi-card { background:#1f2937; border-color:#374151; }
    .section-title { font-size:.72rem; font-weight:600; text-transform:uppercase; letter-spacing:.05em; color:#6b7280; }
    .dark .section-title { color:#9ca3af; }

    .progress-bar-purple { height:8px; border-radius:4px; overflow:hidden; background:#f3e8ff; }
    .dark .progress-bar-purple { background:#4c1d95; }
    .progress-fill-purple { height:100%; border-radius:4px; background:linear-gradient(90deg,#9333ea,#7c3aed); transition:width .3s; }

    .self-review-card { background:white; border-radius:1rem; border:2px solid #e9d5ff; overflow:hidden; }
    .dark .self-review-card { background:#1f2937; border-color:#6b21a8; }
    .self-review-header { background:linear-gradient(135deg,#faf5ff,#f3e8ff); border-bottom:1px solid #e9d5ff; padding:1.25rem 1.5rem; }
    .dark .self-review-header { background:linear-gradient(135deg,rgba(88,28,135,.15),rgba(107,33,168,.1)); border-bottom-color:#6b21a8; }

    .score-ring { width:72px; height:72px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:conic-gradient(#9333ea 0deg,#e5e7eb 0deg); transition:background .4s; flex-shrink:0; }
    .score-ring-inner { width:54px; height:54px; border-radius:50%; background:white; display:flex; align-items:center; justify-content:center; flex-direction:column; }
    .dark .score-ring-inner { background:#1f2937; }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    input[type="number"] { -moz-appearance:textfield; }

    .btn-submit { display:inline-flex; align-items:center; gap:8px; padding:.6rem 1.5rem; background:linear-gradient(135deg,#9333ea,#7c3aed); color:white; border:none; border-radius:.625rem; font-size:.875rem; font-weight:600; cursor:pointer; transition:opacity .2s,transform .15s,box-shadow .2s; box-shadow:0 4px 12px rgba(147,51,234,.35); }
    .btn-submit:hover { opacity:.92; transform:translateY(-1px); }
    .btn-submit:disabled { opacity:.5; cursor:not-allowed; transform:none; }

    textarea.self-comment-input:focus { outline:none; border-color:#9333ea !important; box-shadow:0 0 0 3px rgba(147,51,234,.15); }
    .char-counter { font-size:.7rem; color:#9ca3af; }
    .char-counter.warn { color:#f59e0b; }
    .char-counter.over { color:#ef4444; }

    .step-connector { width:2px; height:2.5rem; background:#e5e7eb; margin:4px 0; }
    .step-connector.done   { background:#22c55e; }
    .step-connector.active { background:linear-gradient(#9333ea,#e5e7eb); }
    .dark .step-connector  { background:#374151; }

    .pending-banner { display:flex; align-items:flex-start; gap:10px; background:#fff7ed; border:1px solid #fed7aa; border-radius:.75rem; padding:.85rem 1rem; }
    .dark .pending-banner { background:rgba(120,53,15,.2); border-color:#92400e; }

    .submitted-readonly { background:#f0fdf4; border:1px solid #bbf7d0; border-radius:.75rem; padding:1rem 1.25rem; }
    .dark .submitted-readonly { background:rgba(20,83,45,.2); border-color:#166534; }

    .task-block + .task-block { margin-top:3rem; padding-top:2rem; border-top:2px dashed #e5e7eb; }
    .dark .task-block + .task-block { border-color:#374151; }

    .history-card { transition:box-shadow .2s,border-color .2s; }
    .history-card:hover { box-shadow:0 8px 24px rgba(0,0,0,.07); border-color:#93c5fd; }
    .dark .history-card:hover { border-color:#1d4ed8; }

    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  </style>
</head>
<body>
<main layout:fragment="content">

  <!-- ══════════════════════════════════════════════
       PAGE HEADER
  ══════════════════════════════════════════════════ -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center">
        <span class="material-icons-round text-blue-600 dark:text-blue-400">assignment_turned_in</span>
      </div>
      <div>
        <h3 class="text-lg font-bold text-gray-900 dark:text-white">My Appraisals</h3>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          <span th:text="${tasks != null ? tasks.size() : 0}">0</span> pending task(s)
          &nbsp;·&nbsp;
          <span th:text="${employeeAppraisals != null ? employeeAppraisals.size() : 0}">0</span> total appraisal(s)
        </p>
      </div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════════
       SECTION 1 — PENDING TASKS
       Controller must add to model:
         model.addAttribute("appraisalMap",
           employeeAppraisals.stream()
             .collect(Collectors.toMap(EmployeeAppraisal::getId, ea -> ea)));
  ══════════════════════════════════════════════════ -->

  <!-- Section heading -->
  <div th:if="${tasks != null and !tasks.isEmpty()}" class="flex items-center gap-2 mb-4">
    <span class="material-icons-round text-purple-600 dark:text-purple-400">pending_actions</span>
    <h4 class="section-title mb-0">Pending Tasks</h4>
    <span class="badge badge-purple" th:text="${tasks.size()} + ' task(s)'"></span>
  </div>

  <!-- No tasks notice -->
  <div th:if="${tasks == null or tasks.isEmpty()}"
       class="kpi-card p-6 mb-8 flex items-center gap-4">
    <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center flex-shrink-0">
      <span class="material-icons-round text-green-600 dark:text-green-400" style="font-size:26px;">check_circle</span>
    </div>
    <div>
      <p class="font-semibold text-gray-800 dark:text-white">No pending appraisal tasks</p>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">You have no self-appraisal tasks to complete right now. See your full appraisal history below.</p>
    </div>
  </div>

  <!-- ── Task loop ─────────────────────────────────
       appraisalMap lookup avoids the SpEL scoping
       bug that occurs with .?[...] collection filter
       when variables from th:with are referenced.
  ──────────────────────────────────────────────── -->
  <div th:each="task, taskStat : ${tasks}"
       th:with="
         selfComplete=${task.variables['selfComplete']},
         managerComplete=${task.variables['managerComplete']},
         kpiScoreVar=${task.variables['kpiScore']},
         appraisalIdVar=${task.variables['appraisalId']},
         managerScoreVar=${task.variables['managerScore']},
         managerCommentVar=${task.variables['managerComment']},
         appraisal=${appraisalMap[task.variables['appraisalId']]},
         processComplete=${appraisal != null and appraisal.managerScore != null}
       "
       class="task-block mb-8">

    <!-- Task banner -->
    <div th:class="${selfComplete}
           ? 'flex items-center gap-3 bg-green-50 dark:bg-green-900/10 border border-green-200 dark:border-green-800 rounded-xl p-3.5 mb-5'
           : 'flex items-center gap-3 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-xl p-3.5 mb-5'">
      <div th:class="${selfComplete}
             ? 'w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/40 flex items-center justify-center flex-shrink-0'
             : 'w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/40 flex items-center justify-center flex-shrink-0'">
        <span th:class="${selfComplete}
                ? 'material-icons-round text-green-600 dark:text-green-400'
                : 'material-icons-round text-purple-600 dark:text-purple-400'"
              style="font-size:17px;"
              th:text="${selfComplete} ? 'check_circle' : 'edit_note'">edit_note</span>
      </div>
      <div class="flex-1">
        <p th:class="${selfComplete}
             ? 'text-sm font-semibold text-green-800 dark:text-green-300'
             : 'text-sm font-semibold text-purple-800 dark:text-purple-300'"
           th:text="${selfComplete}
             ? 'Self-review submitted — awaiting manager review'
             : 'Action Required: Complete your self-review'">
        </p>
        <p th:class="${selfComplete}
             ? 'text-xs text-green-600 dark:text-green-400 mt-0.5'
             : 'text-xs text-purple-600 dark:text-purple-400 mt-0.5'">
          Task: <strong th:text="${task.taskName}">Self Appraisal</strong>
          &nbsp;·&nbsp; Cycle:
          <strong th:text="${appraisal != null and appraisal.cycle != null}
                           ? ${appraisal.cycle.name}
                           : ${task.businessKey}">Q1 2026</strong>
          &nbsp;·&nbsp; Opened:
          <strong th:text="${#temporals.format(task.createdTime,'dd MMM yyyy, HH:mm')}"></strong>
        </p>
      </div>
      <a th:if="${!selfComplete}"
         th:href="'#review-form-' + ${task.taskId}"
         class="text-xs font-semibold text-purple-700 dark:text-purple-300 underline underline-offset-2 whitespace-nowrap hover:text-purple-900">
        Go to form ↓
      </a>
    </div>

    <!-- Score summary -->
    <div class="kpi-card p-5 md:p-6 mb-5 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-750 border border-blue-100 dark:border-blue-900">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-center space-x-4">
          <div class="w-16 h-16 bg-white dark:bg-gray-800 rounded-full flex items-center justify-center shadow-md flex-shrink-0">
            <span class="text-xl font-bold text-blue-600 dark:text-blue-400"
                  th:text="${appraisal != null and appraisal.kpiScore != null}
                           ? ${#numbers.formatDecimal(appraisal.kpiScore,1,2)}
                           : (${kpiScoreVar} ?: '—')">71.43</span>
          </div>
          <div>
            <p class="text-sm text-gray-600 dark:text-gray-300">System KPI Score</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"
               th:text="'Cycle: ' + (${appraisal != null and appraisal.cycle != null}
                                     ? ${appraisal.cycle.name} : ${task.businessKey})"></p>
          </div>
        </div>
        <div class="flex items-center gap-5 flex-wrap">
          <!-- Self score -->
          <div class="text-center">
            <span class="text-xs text-gray-500 dark:text-gray-400">Self Score</span>
            <p th:if="${appraisal != null and appraisal.selfScore != null}"
               class="text-lg font-semibold text-purple-600 dark:text-purple-400"
               th:text="${#numbers.formatDecimal(appraisal.selfScore,1,2)}"></p>
            <p th:if="${appraisal == null or appraisal.selfScore == null}"
               class="text-lg font-semibold text-gray-400">Pending</p>
          </div>
          <!-- Manager score — from task.variables (available mid-process) -->
          <div class="text-center">
            <span class="text-xs text-gray-500 dark:text-gray-400">Manager Score</span>
            <p th:if="${managerScoreVar != null}"
               class="text-lg font-semibold text-green-600 dark:text-green-400"
               th:text="${managerScoreVar}"></p>
            <p th:if="${managerScoreVar == null}"
               class="text-lg font-semibold text-gray-400">Pending</p>
          </div>
          <!-- Final score — only when appraisal.managerScore is set on the entity -->
          <div class="text-center">
            <span class="text-xs text-gray-500 dark:text-gray-400">Final Score</span>
            <p th:if="${processComplete and appraisal.finalScore != null}"
               class="text-lg font-semibold text-emerald-600 dark:text-emerald-400"
               th:text="${#numbers.formatDecimal(appraisal.finalScore,1,2)}"></p>
            <p th:if="${!processComplete or appraisal == null or appraisal.finalScore == null}"
               class="text-lg font-semibold text-gray-300">—</p>
          </div>
          <!-- Outcome — only when complete -->
          <div class="text-center" th:if="${processComplete and appraisal.outcome != null}">
            <span class="text-xs text-gray-500 dark:text-gray-400 block mb-1">Outcome</span>
            <span th:switch="${appraisal.outcome.name()}">
              <span th:case="'EXCEEDS_EXPECTATION'" class="badge badge-success" th:text="${appraisal.outcome}"></span>
              <span th:case="'MEETS_EXPECTATION'"   class="badge badge-info"    th:text="${appraisal.outcome}"></span>
              <span th:case="'NEEDS_IMPROVEMENT'"   class="badge badge-warning" th:text="${appraisal.outcome}"></span>
              <span th:case="*"                     class="badge badge-neutral" th:text="${appraisal.outcome}"></span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- ── Process timeline ── -->
    <div class="kpi-card p-5 md:p-6 mb-5">
      <div class="flex items-center gap-2 mb-5">
        <span class="material-icons-round text-blue-600 dark:text-blue-400">account_tree</span>
        <h4 class="section-title mb-0">Appraisal Process</h4>
        <span th:if="${processComplete}"  class="badge badge-success ml-1">Completed</span>
        <span th:if="${!processComplete}" class="badge badge-warning ml-1">In Progress</span>
      </div>

      <!-- Step 1: Self Appraisal -->
      <div class="flex items-start gap-4">
        <div class="flex flex-col items-center flex-shrink-0">
          <div th:if="${selfComplete}"
               class="w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 border-2 border-green-500 flex items-center justify-center">
            <span class="material-icons-round text-green-600" style="font-size:18px;">check</span>
          </div>
          <div th:if="${!selfComplete}"
               class="w-9 h-9 rounded-full bg-purple-100 dark:bg-purple-900/30 border-2 border-purple-400 flex items-center justify-center">
            <span class="material-icons-round text-purple-600" style="font-size:18px;">person</span>
          </div>
          <div th:class="${selfComplete} ? 'step-connector done' : 'step-connector active'"></div>
        </div>
        <div class="pt-1 pb-5 flex-1">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-semibold text-sm text-gray-900 dark:text-white">Self Appraisal</span>
            <span th:if="${selfComplete}"  class="badge badge-success">Submitted</span>
            <span th:if="${!selfComplete}" class="badge badge-purple">In Progress</span>
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Employee submits self-score and review comment.</p>
          <div th:if="${selfComplete and appraisal != null}" class="mt-1.5 flex flex-wrap gap-3 text-xs text-gray-500">
            <span th:if="${appraisal.selfScore != null}">
              Score: <strong class="text-purple-600" th:text="${#numbers.formatDecimal(appraisal.selfScore,1,2)}"></strong>
            </span>
            <span th:if="${appraisal.selfCompletedAt != null}">
              · Submitted: <strong th:text="${#temporals.format(appraisal.selfCompletedAt,'dd MMM yyyy, HH:mm')}"></strong>
            </span>
          </div>
        </div>
      </div>

      <!-- Step 2: Manager Review -->
      <div class="flex items-start gap-4">
        <div class="flex flex-col items-center flex-shrink-0">
          <!-- Entity confirms complete -->
          <div th:if="${processComplete}"
               class="w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 border-2 border-green-500 flex items-center justify-center">
            <span class="material-icons-round text-green-600" style="font-size:18px;">check</span>
          </div>
          <!-- managerScore in variables but entity not yet written -->
          <div th:if="${!processComplete and managerScoreVar != null}"
               class="w-9 h-9 rounded-full bg-blue-100 dark:bg-blue-900/30 border-2 border-blue-400 flex items-center justify-center">
            <span class="material-icons-round text-blue-500" style="font-size:18px;">hourglass_bottom</span>
          </div>
          <!-- Waiting for manager to start -->
          <div th:if="${selfComplete and managerScoreVar == null and !processComplete}"
               class="w-9 h-9 rounded-full bg-orange-100 dark:bg-orange-900/30 border-2 border-orange-400 flex items-center justify-center">
            <span class="material-icons-round text-orange-500" style="font-size:18px;">hourglass_top</span>
          </div>
          <!-- Self not yet submitted -->
          <div th:if="${!selfComplete}"
               class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center">
            <span class="material-icons-round text-gray-400" style="font-size:18px;">manage_accounts</span>
          </div>
          <div th:class="${processComplete} ? 'step-connector done' : 'step-connector'"></div>
        </div>
        <div class="pt-1 pb-5 flex-1">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-semibold text-sm"
                  th:class="${processComplete or managerScoreVar != null}
                            ? 'font-semibold text-sm text-gray-900 dark:text-white'
                            : 'font-semibold text-sm text-gray-500 dark:text-gray-400'">
              Manager Review
            </span>
            <span th:if="${processComplete}"                                               class="badge badge-success">Completed</span>
            <span th:if="${!processComplete and managerScoreVar != null}"                  class="badge badge-info">Finalising</span>
            <span th:if="${selfComplete and managerScoreVar == null and !processComplete}" class="badge badge-orange">Awaiting Manager</span>
            <span th:if="${!selfComplete}"                                                 class="badge badge-neutral">Waiting</span>
          </div>
          <p class="text-xs text-gray-400 mt-1">Manager adds a subjective score and comment after employee submits.</p>

          <!-- managerScore visible from variables as soon as set -->
          <div th:if="${managerScoreVar != null}" class="mt-1.5 text-xs text-gray-500">
            Score: <strong class="text-green-600" th:text="${managerScoreVar}"></strong>
          </div>

          <!--
            Manager comment — shown as soon as it exists in task.variables.
            Check both null AND empty string because variables map may hold an empty string.
          -->
          <div th:if="${managerCommentVar != null and !#strings.isEmpty(managerCommentVar.toString())}"
               class="mt-2 p-2.5 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-700">
            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Manager's Comment</p>
            <p class="text-xs text-gray-700 dark:text-gray-300 italic" th:text="${managerCommentVar}"></p>
          </div>
        </div>
      </div>

      <!-- Step 3: Final Score -->
      <div class="flex items-start gap-4">
        <div class="flex flex-col items-center flex-shrink-0">
          <div th:if="${processComplete}"
               class="w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 border-2 border-green-500 flex items-center justify-center">
            <span class="material-icons-round text-green-600" style="font-size:18px;">emoji_events</span>
          </div>
          <div th:if="${!processComplete}"
               class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 flex items-center justify-center">
            <span class="material-icons-round text-gray-300 dark:text-gray-500" style="font-size:18px;">lock</span>
          </div>
        </div>
        <div class="pt-1 flex-1">
          <div class="flex items-center gap-2">
            <span class="font-semibold text-sm"
                  th:class="${processComplete}
                            ? 'font-semibold text-sm text-gray-900 dark:text-white'
                            : 'font-semibold text-sm text-gray-400 dark:text-gray-500'">
              Final Score &amp; Outcome
            </span>
            <span th:if="${processComplete}"  class="badge badge-success">Finalised</span>
            <span th:if="${!processComplete}" class="badge badge-neutral">Locked</span>
          </div>
          <p class="text-xs text-gray-400 mt-1">Calculated once both reviews are complete.</p>
        </div>
      </div>

      <!-- Pending notice: waiting for self submission -->
      <div th:if="${!selfComplete}" class="pending-banner mt-5">
        <span class="material-icons-round text-orange-500 flex-shrink-0 mt-0.5" style="font-size:20px;">info</span>
        <div>
          <p class="text-sm font-semibold text-orange-800 dark:text-orange-300">Final score not yet available</p>
          <p class="text-xs text-orange-600 dark:text-orange-400 mt-0.5">
            Submit your self-review below. Your manager will then complete their review.
            The final score will be revealed once both steps are done.
          </p>
        </div>
      </div>

      <!-- Pending notice: waiting for manager -->
      <div th:if="${selfComplete and !processComplete}" class="pending-banner mt-5">
        <span class="material-icons-round text-orange-500 flex-shrink-0 mt-0.5" style="font-size:20px;">hourglass_top</span>
        <div>
          <p class="text-sm font-semibold text-orange-800 dark:text-orange-300">Waiting for manager review</p>
          <p class="text-xs text-orange-600 dark:text-orange-400 mt-0.5">
            Your self-review has been submitted. The final score will be available once your manager completes their review.
          </p>
        </div>
      </div>

      <!-- Process complete: final results revealed -->
      <div th:if="${processComplete}" class="mt-5 p-4 bg-green-50 dark:bg-green-900/10 border border-green-200 dark:border-green-800 rounded-xl">
        <p class="text-xs font-semibold text-green-700 dark:text-green-400 uppercase tracking-wider mb-3">
          <span class="material-icons-round align-text-bottom" style="font-size:14px;">emoji_events</span>
          Appraisal Complete — Final Results
        </p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="p-3 bg-white dark:bg-gray-800 rounded-lg text-center">
            <p class="text-xs text-gray-400 mb-1">KPI Score</p>
            <p class="text-xl font-bold text-blue-600"
               th:text="${appraisal.kpiScore != null ? #numbers.formatDecimal(appraisal.kpiScore,1,2) : '—'}"></p>
          </div>
          <div class="p-3 bg-white dark:bg-gray-800 rounded-lg text-center">
            <p class="text-xs text-gray-400 mb-1">Self Score</p>
            <p class="text-xl font-bold text-purple-600"
               th:text="${appraisal.selfScore != null ? #numbers.formatDecimal(appraisal.selfScore,1,2) : '—'}"></p>
          </div>
          <div class="p-3 bg-white dark:bg-gray-800 rounded-lg text-center">
            <p class="text-xs text-gray-400 mb-1">Manager Score</p>
            <p class="text-xl font-bold text-green-600"
               th:text="${appraisal.managerScore != null ? #numbers.formatDecimal(appraisal.managerScore,1,2) : '—'}"></p>
          </div>
          <div class="p-3 bg-white dark:bg-gray-800 rounded-lg text-center border-2 border-emerald-300 dark:border-emerald-700">
            <p class="text-xs text-gray-400 mb-1">Final Score</p>
            <p class="text-xl font-bold text-emerald-600 dark:text-emerald-400"
               th:text="${appraisal.finalScore != null ? #numbers.formatDecimal(appraisal.finalScore,1,2) : '—'}"></p>
          </div>
        </div>
        <!-- Manager comment from entity (authoritative source when process complete) -->
        <div th:if="${appraisal.managerComment != null and !#strings.isEmpty(appraisal.managerComment)}"
             class="mt-3 p-3 bg-white dark:bg-gray-800 rounded-lg">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Manager's Comment</p>
          <p class="text-sm text-gray-700 dark:text-gray-300 italic" th:text="${appraisal.managerComment}"></p>
        </div>
        <div th:if="${appraisal.completedAt != null}" class="mt-2 text-xs text-gray-400 text-right">
          Completed: <span th:text="${#temporals.format(appraisal.completedAt,'dd MMM yyyy, HH:mm')}"></span>
        </div>
      </div>

    </div><!-- /process timeline card -->

    <!-- ── Self-review form / read-only ── -->
    <div th:id="'review-form-' + ${task.taskId}" class="self-review-card scroll-mt-6">

      <!-- Card header -->
      <div class="self-review-header flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-full bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center">
            <span class="material-icons-round text-purple-600 dark:text-purple-400" style="font-size:20px;">person</span>
          </div>
          <div>
            <div class="flex items-center gap-2">
              <h4 class="font-bold text-gray-900 dark:text-white text-base" th:text="${task.taskName}">Self Appraisal</h4>
              <span class="badge badge-purple"
                    th:text="${appraisal != null and appraisal.cycle != null}
                             ? ${appraisal.cycle.name} : ${task.businessKey}">Q1 2026</span>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Rate your own performance and leave a comment for your manager</p>
          </div>
        </div>
        <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white dark:bg-gray-800 border border-purple-200 dark:border-purple-700 shadow-sm text-xs font-semibold text-purple-700 dark:text-purple-300 self-start sm:self-auto">
          <span class="material-icons-round" style="font-size:13px;">bar_chart</span>
          KPI:
          <span th:text="${appraisal != null and appraisal.kpiScore != null}
                         ? ${#numbers.formatDecimal(appraisal.kpiScore,1,2)}
                         : (${kpiScoreVar} ?: '—')">71.43</span>
        </div>
      </div>

      <div class="p-5 md:p-6">

        <!-- READ-ONLY view (selfComplete = true) -->
        <div th:if="${selfComplete}" class="submitted-readonly">
          <div class="flex items-start gap-3">
            <div class="w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0">
              <span class="material-icons-round text-green-600" style="font-size:20px;">check_circle</span>
            </div>
            <div class="flex-1">
              <p class="font-semibold text-sm text-green-800 dark:text-green-300">Self-review submitted</p>
              <p class="text-xs text-green-600 dark:text-green-400 mt-0.5">Your self-review has been recorded and is now with your manager.</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                  <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Your Self Score</p>
                  <p class="text-2xl font-bold text-purple-600 dark:text-purple-400"
                     th:text="${appraisal != null and appraisal.selfScore != null}
                              ? ${#numbers.formatDecimal(appraisal.selfScore,1,2)} : '—'"></p>
                </div>
                <div th:if="${appraisal != null and appraisal.selfCompletedAt != null}">
                  <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Submitted At</p>
                  <p class="text-sm text-gray-700 dark:text-gray-300"
                     th:text="${#temporals.format(appraisal.selfCompletedAt,'dd MMM yyyy, HH:mm')}"></p>
                </div>
              </div>
              <div th:if="${appraisal != null and appraisal.selfComment != null and !#strings.isEmpty(appraisal.selfComment)}"
                   class="mt-3">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Your Comment</p>
                <p class="text-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-100 dark:border-gray-700"
                   th:text="${appraisal.selfComment}"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- FORM (selfComplete = false) -->
        <div th:if="${!selfComplete}">
          <form th:action="@{/employee/self-review}"
                method="post"
                th:id="'selfReviewForm_' + ${taskStat.index}"
                th:attr="data-kpi-score=${appraisal != null and appraisal.kpiScore != null}
                                        ? ${appraisal.kpiScore} : ${kpiScoreVar},
                         data-task-idx=${taskStat.index}">

            <!-- taskId hidden field — required by /finalize-appraisal endpoint -->
            <input type="hidden" name="taskId" th:value="${task.taskId}">

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

              <!-- Left: score input + ring -->
              <div class="lg:col-span-2 flex flex-col">
                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Self Score</label>
                <div class="flex items-center gap-4 mb-4">
                  <div class="score-ring" th:id="'scoreRing_' + ${taskStat.index}">
                    <div class="score-ring-inner">
                      <span class="text-lg font-bold text-purple-700 dark:text-purple-300 leading-none"
                            th:id="'ringValue_' + ${taskStat.index}">—</span>
                      <span class="text-xs text-gray-400 leading-none">/100</span>
                    </div>
                  </div>
                  <div class="flex-1">
                    <input type="number"
                           name="selfScore"
                           th:id="'selfScoreInput_' + ${taskStat.index}"
                           min="0" max="100" step="0.1" placeholder="0.0"
                           th:attr="oninput='onScoreInput(this,' + ${taskStat.index} + ')'"
                           class="w-full px-4 py-2.5 bg-white dark:bg-gray-800 border-2 border-purple-200 dark:border-purple-700 rounded-lg text-gray-900 dark:text-white font-bold text-xl focus:ring-0 focus:border-purple-500 outline-none"
                           style="font-family:'Courier New',monospace;">
                    <p class="text-xs text-gray-400 mt-1.5">Enter a value between 0 and 100</p>
                  </div>
                </div>
                <div class="progress-bar-purple mb-1">
                  <div class="progress-fill-purple" th:id="'selfScoreBar_' + ${taskStat.index}" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-1 mb-4">
                  <span>0</span>
                  <span class="font-medium" th:id="'scoreOutcomeLabel_' + ${taskStat.index}">—</span>
                  <span>100</span>
                </div>
                <!-- Score comparison box -->
                <div class="mt-auto p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-100 dark:border-gray-700">
                  <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Score Comparison</p>
                  <div class="space-y-1.5">
                    <div class="flex items-center justify-between text-xs">
                      <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                        <span class="text-gray-600 dark:text-gray-400">System KPI</span>
                      </div>
                      <span class="font-bold text-gray-900 dark:text-white" style="font-family:monospace;"
                            th:text="${appraisal != null and appraisal.kpiScore != null}
                                     ? ${#numbers.formatDecimal(appraisal.kpiScore,1,2)}
                                     : (${kpiScoreVar} ?: '—')">71.43</span>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                      <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                        <span class="text-gray-600 dark:text-gray-400">Your Self Score</span>
                      </div>
                      <span class="font-bold text-purple-700 dark:text-purple-300"
                            th:id="'selfScoreDisplay_' + ${taskStat.index}"
                            style="font-family:monospace;">—</span>
                    </div>
                    <div class="flex items-center justify-between text-xs border-t border-gray-200 dark:border-gray-600 pt-1.5 mt-1.5">
                      <span class="text-gray-500">Difference</span>
                      <span class="font-semibold" th:id="'scoreDiff_' + ${taskStat.index}">—</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right: comment textarea -->
              <div class="lg:col-span-3 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                  <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                    Self-Review Comment
                  </label>
                  <span class="char-counter" th:id="'charCounter_' + ${taskStat.index}">0 / 2000</span>
                </div>
                <textarea name="selfComment"
                          maxlength="2000" rows="8"
                          th:id="'selfComment_' + ${taskStat.index}"
                          th:attr="oninput='onCommentInput(this,' + ${taskStat.index} + ')'"
                          placeholder="Describe your performance this period…&#10;&#10;• What did you achieve?&#10;• What challenges did you face?&#10;• What would you improve?"
                          class="self-comment-input flex-1 w-full px-4 py-3 bg-white dark:bg-gray-800 border-2 border-purple-200 dark:border-purple-700 rounded-xl text-sm text-gray-900 dark:text-white placeholder-gray-400 resize-none"
                          style="min-height:180px;"></textarea>
                <div class="flex flex-wrap gap-2 mt-3">
                  <span class="text-xs text-gray-400">Quick add:</span>
                  <button type="button"
                          th:attr="onclick='appendPrompt(\'I exceeded my target on \',' + ${taskStat.index} + ')'"
                          class="text-xs px-2.5 py-1 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded-full border border-purple-200 dark:border-purple-700 hover:bg-purple-100 transition-colors">
                    + Exceeded target
                  </button>
                  <button type="button"
                          th:attr="onclick='appendPrompt(\'I faced challenges with \',' + ${taskStat.index} + ')'"
                          class="text-xs px-2.5 py-1 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded-full border border-purple-200 dark:border-purple-700 hover:bg-purple-100 transition-colors">
                    + Challenge faced
                  </button>
                  <button type="button"
                          th:attr="onclick='appendPrompt(\'Next period, I plan to improve \',' + ${taskStat.index} + ')'"
                          class="text-xs px-2.5 py-1 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded-full border border-purple-200 dark:border-purple-700 hover:bg-purple-100 transition-colors">
                    + Improvement plan
                  </button>
                </div>
              </div>
            </div>

            <!-- Validation message -->
            <div th:id="'validationMsg_' + ${taskStat.index}"
                 class="hidden mt-4 flex items-center gap-2 text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg px-4 py-2.5">
              <span class="material-icons-round" style="font-size:16px;">error_outline</span>
              <span th:id="'validationText_' + ${taskStat.index}"></span>
            </div>

            <!-- Form footer -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mt-5 pt-5 border-t border-purple-100 dark:border-purple-900">
              <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1.5">
                <span class="material-icons-round text-gray-400" style="font-size:14px;">info</span>
                Visible only to you and your manager.
              </p>
              <div class="flex items-center gap-3 self-end sm:self-auto">
                <button type="button"
                        th:attr="onclick='clearForm(' + ${taskStat.index} + ')'"
                        class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                  Clear
                </button>
                <button type="button"
                        th:id="'submitBtn_' + ${taskStat.index}"
                        th:attr="onclick='submitSelfReview(' + ${taskStat.index} + ')'"
                        class="btn-submit">
                  <span class="material-icons-round" style="font-size:17px;">send</span>
                  Submit Self-Review
                </button>
              </div>
            </div>

          </form>
        </div><!-- /!selfComplete -->

      </div><!-- /card body -->
    </div><!-- /self-review-card -->

  </div><!-- /task-block th:each -->


  <!-- ══════════════════════════════════════════════════════════
       SECTION 2 — ALL APPRAISALS HISTORY
       Iterates employeeAppraisals — all records regardless of tasks.
       processComplete = appraisal.managerScore != null
       (managerScore on the entity is only written when the full
        process finishes, so it is the authoritative completion flag)
  ══════════════════════════════════════════════════════════════ -->
  <div th:if="${employeeAppraisals != null and !employeeAppraisals.isEmpty()}" class="mt-10">

    <div class="flex items-center gap-2 mb-4">
      <span class="material-icons-round text-blue-600 dark:text-blue-400">history</span>
      <h4 class="section-title mb-0">All Appraisals</h4>
      <span class="badge badge-info" th:text="${employeeAppraisals.size()} + ' record(s)'"></span>
    </div>

    <div class="space-y-4">
      <div th:each="appraisal : ${employeeAppraisals}"
           th:with="isComplete=${appraisal.managerScore != null}"
           class="kpi-card history-card p-5 md:p-6">

        <!-- Header row: cycle + badges -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
          <div class="flex items-center gap-3">
            <div th:class="${isComplete}
                   ? 'w-9 h-9 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0'
                   : 'w-9 h-9 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center flex-shrink-0'">
              <span th:class="${isComplete}
                     ? 'material-icons-round text-green-600 dark:text-green-400'
                     : 'material-icons-round text-blue-600 dark:text-blue-400'"
                    style="font-size:18px;"
                    th:text="${isComplete} ? 'task_alt' : 'pending'">pending</span>
            </div>
            <div>
              <p class="font-semibold text-gray-900 dark:text-white text-sm"
                 th:text="${appraisal.cycle != null} ? ${appraisal.cycle.name} : 'Appraisal #' + ${appraisal.id}"></p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5"
                 th:if="${appraisal.cycle != null and appraisal.cycle.startPeriod != null}"
                 th:text="${#temporals.format(appraisal.cycle.startPeriod,'dd MMM yyyy')}
                          + ' – '
                          + (${appraisal.cycle.endPeriod != null}
                             ? ${#temporals.format(appraisal.cycle.endPeriod,'dd MMM yyyy')}
                             : 'ongoing')"></p>
            </div>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <span th:if="${appraisal.status != null}"
                  th:switch="${appraisal.status.name()}">
              <span th:case="'COMPLETED'"   class="badge badge-success" th:text="${appraisal.status}"></span>
              <span th:case="'IN_PROGRESS'" class="badge badge-warning" th:text="${appraisal.status}"></span>
              <span th:case="'PENDING'"     class="badge badge-neutral" th:text="${appraisal.status}"></span>
              <span th:case="*"             class="badge badge-neutral" th:text="${appraisal.status}"></span>
            </span>
            <!-- Outcome only when fully complete -->
            <span th:if="${isComplete and appraisal.outcome != null}"
                  th:switch="${appraisal.outcome.name()}">
              <span th:case="'EXCEEDS_EXPECTATION'" class="badge badge-success" th:text="${appraisal.outcome}"></span>
              <span th:case="'MEETS_EXPECTATION'"   class="badge badge-info"    th:text="${appraisal.outcome}"></span>
              <span th:case="'NEEDS_IMPROVEMENT'"   class="badge badge-warning" th:text="${appraisal.outcome}"></span>
              <span th:case="*"                     class="badge badge-neutral" th:text="${appraisal.outcome}"></span>
            </span>
          </div>
        </div>

        <!-- Score grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
          <!-- KPI always visible -->
          <div class="p-3 bg-blue-50 dark:bg-blue-900/10 rounded-xl text-center">
            <p class="text-xs text-gray-400 mb-1">KPI Score</p>
            <p class="text-lg font-bold text-blue-600 dark:text-blue-400"
               th:text="${appraisal.kpiScore != null ? #numbers.formatDecimal(appraisal.kpiScore,1,2) : '—'}"></p>
          </div>
          <!-- Self score: visible once submitted -->
          <div class="p-3 bg-purple-50 dark:bg-purple-900/10 rounded-xl text-center">
            <p class="text-xs text-gray-400 mb-1">Self Score</p>
            <p th:if="${appraisal.selfScore != null}"
               class="text-lg font-bold text-purple-600 dark:text-purple-400"
               th:text="${#numbers.formatDecimal(appraisal.selfScore,1,2)}"></p>
            <p th:if="${appraisal.selfScore == null}" class="text-lg font-bold text-gray-300">—</p>
          </div>
          <!-- Manager score: locked until isComplete -->
          <div th:class="${isComplete}
                 ? 'p-3 bg-green-50 dark:bg-green-900/10 rounded-xl text-center'
                 : 'p-3 bg-gray-50 dark:bg-gray-700/40 rounded-xl text-center opacity-50'">
            <p class="text-xs text-gray-400 mb-1 flex items-center justify-center gap-1">
              Manager Score
              <span th:if="${!isComplete}" class="material-icons-round text-gray-300" style="font-size:11px;">lock</span>
            </p>
            <p th:if="${isComplete}"
               class="text-lg font-bold text-green-600 dark:text-green-400"
               th:text="${#numbers.formatDecimal(appraisal.managerScore,1,2)}"></p>
            <p th:if="${!isComplete}" class="text-lg font-bold text-gray-300">—</p>
          </div>
          <!-- Final score: locked until isComplete -->
          <div th:class="${isComplete}
                 ? 'p-3 bg-emerald-50 dark:bg-emerald-900/10 rounded-xl text-center border-2 border-emerald-200 dark:border-emerald-800'
                 : 'p-3 bg-gray-50 dark:bg-gray-700/40 rounded-xl text-center opacity-50'">
            <p class="text-xs text-gray-400 mb-1 flex items-center justify-center gap-1">
              Final Score
              <span th:if="${!isComplete}" class="material-icons-round text-gray-300" style="font-size:11px;">lock</span>
            </p>
            <p th:if="${isComplete}"
               class="text-lg font-bold text-emerald-600 dark:text-emerald-400"
               th:text="${appraisal.finalScore != null ? #numbers.formatDecimal(appraisal.finalScore,1,2) : '—'}"></p>
            <p th:if="${!isComplete}" class="text-lg font-bold text-gray-300">—</p>
          </div>
        </div>

        <!-- Manager comment — only when process complete (managerScore != null) -->
        <div th:if="${isComplete and appraisal.managerComment != null and !#strings.isEmpty(appraisal.managerComment)}"
             class="p-3 bg-gray-50 dark:bg-gray-700/40 rounded-xl mb-3">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Manager's Comment</p>
          <p class="text-sm text-gray-700 dark:text-gray-300 italic" th:text="${appraisal.managerComment}"></p>
        </div>

        <!-- Self comment preview -->
        <div th:if="${appraisal.selfComment != null and !#strings.isEmpty(appraisal.selfComment)}"
             class="p-3 bg-purple-50 dark:bg-purple-900/10 rounded-xl mb-3">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Your Comment</p>
          <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2" th:text="${appraisal.selfComment}"></p>
        </div>

        <!-- Timestamps -->
        <div class="flex flex-wrap gap-4 text-xs text-gray-400 pt-3 border-t border-gray-100 dark:border-gray-700">
          <span th:if="${appraisal.selfCompletedAt != null}">
            <span class="material-icons-round align-text-bottom" style="font-size:13px;">person</span>
            Self submitted: <strong th:text="${#temporals.format(appraisal.selfCompletedAt,'dd MMM yyyy')}"></strong>
          </span>
          <span th:if="${isComplete and appraisal.completedAt != null}">
            <span class="material-icons-round align-text-bottom" style="font-size:13px;">check_circle</span>
            Completed: <strong th:text="${#temporals.format(appraisal.completedAt,'dd MMM yyyy')}"></strong>
          </span>
          <span th:if="${!isComplete}" class="text-orange-400 flex items-center gap-1">
            <span class="material-icons-round" style="font-size:13px;">hourglass_top</span>
            Awaiting manager review — final score locked
          </span>
        </div>

      </div><!-- /appraisal each -->
    </div>
  </div><!-- /history section -->

  <!-- Footer -->
  <div class="mt-8 text-center text-xs text-gray-500 dark:text-gray-400">
    <span class="material-icons-round text-xs align-text-bottom mr-1">lock</span>
    KPI data is managed by HR. For questions, contact your manager or HR representative.
  </div>

  <!-- ══════════════════════════════════════════════
       JAVASCRIPT
  ══════════════════════════════════════════════════ -->
  <script th:inline="javascript">

    function getKpiScore(idx) {
      const form = document.getElementById('selfReviewForm_' + idx);
      return form ? parseFloat(form.dataset.kpiScore) || 0 : 0;
    }

    function onScoreInput(input, idx) {
      const val = input.value;
      const n   = parseFloat(val);
      const KPI = getKpiScore(idx);
      const bar      = document.getElementById('selfScoreBar_'      + idx);
      const ring     = document.getElementById('scoreRing_'         + idx);
      const ringVal  = document.getElementById('ringValue_'         + idx);
      const selfDisp = document.getElementById('selfScoreDisplay_'  + idx);
      const diff     = document.getElementById('scoreDiff_'         + idx);
      const label    = document.getElementById('scoreOutcomeLabel_' + idx);

      if (isNaN(n) || val === '') {
        bar.style.width = '0%';
        ring.style.background = 'conic-gradient(#9333ea 0deg,#e5e7eb 0deg)';
        ringVal.textContent = '—'; selfDisp.textContent = '—';
        diff.textContent = '—'; diff.className = 'font-semibold text-gray-500';
        label.textContent = '—'; return;
      }
      const c   = Math.min(Math.max(n, 0), 100);
      const deg = (c / 100) * 360;
      bar.style.width  = c + '%';
      ring.style.background = `conic-gradient(#9333ea ${deg}deg,#e5e7eb ${deg}deg)`;
      ringVal.textContent  = c.toFixed(1);
      selfDisp.textContent = c.toFixed(1);

      const delta = (c - KPI).toFixed(1);
      if      (delta > 0) { diff.textContent = '+' + delta; diff.className = 'font-semibold text-green-600'; }
      else if (delta < 0) { diff.textContent = delta;       diff.className = 'font-semibold text-red-500';   }
      else                { diff.textContent = '0.0';       diff.className = 'font-semibold text-gray-500';  }

      label.textContent = c >= 80 ? 'Exceeds' : c >= 60 ? 'Meets' : c >= 40 ? 'Needs Improvement' : 'Unsatisfactory';
    }

    function onCommentInput(el, idx) {
      const len = el.value.length;
      const c   = document.getElementById('charCounter_' + idx);
      c.textContent = len + ' / 2000';
      c.className   = 'char-counter' + (len >= 2000 ? ' over' : len >= 1800 ? ' warn' : '');
    }

    function appendPrompt(text, idx) {
      const ta  = document.getElementById('selfComment_' + idx);
      const sep = ta.value.length > 0 && !ta.value.endsWith('\n') ? '\n' : '';
      ta.value += sep + text; ta.focus(); onCommentInput(ta, idx);
    }

    function showError(idx, msg) {
      const el = document.getElementById('validationMsg_' + idx);
      document.getElementById('validationText_' + idx).textContent = msg;
      el.classList.remove('hidden'); el.classList.add('flex');
    }
    function hideError(idx) {
      const el = document.getElementById('validationMsg_' + idx);
      el.classList.add('hidden'); el.classList.remove('flex');
    }

    function submitSelfReview(idx) {
      hideError(idx);
      const scoreInput = document.getElementById('selfScoreInput_' + idx);
      const commentEl  = document.getElementById('selfComment_'    + idx);
      const score      = parseFloat(scoreInput.value);

      if (scoreInput.value === '' || isNaN(score)) {
        showError(idx, 'Please enter your self score before submitting.'); scoreInput.focus(); return;
      }
      if (score < 0 || score > 100) {
        showError(idx, 'Score must be between 0 and 100.'); scoreInput.focus(); return;
      }
      if (commentEl.value.trim().length < 20) {
        showError(idx, 'Please add a comment of at least 20 characters so your manager understands your assessment.');
        commentEl.focus(); return;
      }

      const btn = document.getElementById('submitBtn_' + idx);
      btn.disabled = true;
      btn.innerHTML = `<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg"
        fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
      </svg> Submitting…`;

      document.getElementById('selfReviewForm_' + idx).submit();
    }

    function clearForm(idx) {
      const scoreInput = document.getElementById('selfScoreInput_' + idx);
      const commentEl  = document.getElementById('selfComment_'    + idx);
      scoreInput.value = ''; commentEl.value = '';
      onScoreInput(scoreInput, idx);
      onCommentInput(commentEl, idx);
      hideError(idx);
    }
  </script>

</main>
</body>
</html>