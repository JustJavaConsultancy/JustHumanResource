<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        secondary: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: { 'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'] },
                    borderRadius: { 'xl': '1rem', '2xl': '1.5rem' }
                }
            }
        };
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { overflow-x: hidden; }
        .sidebar-item { transition: all 0.2s ease; position: relative; }
        .sidebar-item.active { background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; border-left: 3px solid #3b82f6; }
        .sidebar-item.active .material-icons-round { color: #3b82f6; }
        .sidebar-item:hover:not(.active) { background-color: rgba(59, 130, 246, 0.05); }
        .dark .sidebar-item.active { background-color: rgba(59, 130, 246, 0.2); }
        .badge { padding: 2px 8px; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; }
        .badge-success { background-color: #dcfce7; color: #16a34a; }
        .badge-warning { background-color: #fef3c7; color: #d97706; }
        .badge-error { background-color: #fee2e2; color: #dc2626; }
        .badge-info { background-color: #dbeafe; color: #2563eb; }
        .form-input { border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem; width: 100%; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .sidebar-container { position: fixed; top: 0; left: 0; height: 100vh; width: 16rem; z-index: 40; overflow-y: auto; }
        .main-content { margin-left: 16rem; width: calc(100% - 16rem); min-height: 100vh; }
        @media (max-width: 1023px) {
            .sidebar-container { transform: translateX(-100%); }
            .sidebar-container.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .payroll-card { transition: all 0.2s ease; border: 1px solid #e5e7eb; }
        .payroll-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .dark .payroll-card { border-color: #374151; }
        .dark .payroll-card:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); }
        .grade-badge { padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 500; }
        .grade-1 { background-color: #dbeafe; color: #1e40af; }
        .grade-2 { background-color: #dcfce7; color: #166534; }
        .grade-3 { background-color: #f0f9ff; color: #0c4a6e; }
        .grade-4 { background-color: #fef3c7; color: #92400e; }
        .grade-5 { background-color: #f3e8ff; color: #5b21b6; }
        .grade-6 { background-color: #fce7f3; color: #9d174d; }
        .grade-7 { background-color: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
<main layout:fragment="content">
    <!-- Payroll status banner (CLOSED) -->
    <div th:if="${payrollStatus == null or payrollStatus == T(com.justjava.humanresource.payroll.enums.PayrollPeriodStatus).CLOSED}" class="mb-6 p-4 rounded-lg border flex items-center justify-between transition-colors duration-200 bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800">
        <div class="flex items-center space-x-3">
            <span id="periodStatusIcon" class="material-icons-round text-red-600 dark:text-red-400">lock</span>
            <div>
                <p class="font-medium text-gray-800 dark:text-gray-200">Payroll Period is CLOSED.</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">All payroll actions are disabled. Open the period to start processing.</p>
            </div>
        </div>
        <!-- Open button triggers confirmation modal with 'activate' action -->
        <button onclick="openToggleModal('activate')" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 transition-colors">Open Period</button>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg"><span class="material-icons-round text-green-600 dark:text-green-400">add_circle</span></div>
                <span class="text-sm font-medium text-green-600 flex items-center"><span class="material-icons-round text-sm mr-1">trending_up</span>+2</span>
            </div>
            <h3 th:text="${allowances}" class="text-2xl font-bold mb-1">8</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Active Allowances</p>
            <div class="mt-3"><div class="flex items-center text-xs text-gray-500"><span class="material-icons-round text-xs mr-1">percent</span><span th:text="${taxableAllowances + ' taxable'}" id="taxableAllowances">4 taxable</span></div></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-lg"><span class="material-icons-round text-red-600 dark:text-red-400">remove_circle</span></div>
                <span class="badge badge-warning">Compliance</span>
            </div>
            <h3 th:text="${deductions}" class="text-2xl font-bold mb-1" >6</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Active Deductions</p>
            <div class="mt-3"><div class="flex items-center text-xs text-gray-500"><span class="material-icons-round text-xs mr-1">gavel</span><span th:text="${saturatoryDeductions + ' saturatory'}" id="statutoryDeductions">3 statutory</span></div></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg"><span class="material-icons-round text-blue-600 dark:text-blue-400">group_work</span></div>
                <span class="text-sm text-gray-500">Active</span>
            </div>
            <h3 th:text="${payGroups}" class="text-2xl font-bold mb-1">3</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Paygroups</p>
            <div class="mt-3"><div class="flex items-center text-xs text-gray-500"><span class="material-icons-round text-xs mr-1">people</span><span id="totalEmployeesPaygroups">248 employees</span></div></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg"><span class="material-icons-round text-purple-600 dark:text-purple-400">payments</span></div>
                <span class="text-sm font-medium text-green-600 flex items-center"><span class="material-icons-round text-sm mr-1">trending_up</span>+5.2%</span>
            </div>
            <h3 class="text-2xl font-bold mb-1">₦476,569</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Net Payroll</p>
            <div class="mt-3"><div class="flex justify-between text-xs"><span class="text-gray-500">Gross: ₦458,240</span><span class="font-medium">Tax: ₦68,736</span></div></div>
        </div>
    </div>

    <!-- Quick Actions + Run Payroll button -->
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-bold text-gray-800 dark:text-white">Quick Access</h3>
        <button onclick="openModal('runPayrollModal')" class="px-5 py-2.5 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 transition-colors flex items-center space-x-2">
            <span class="material-icons-round text-base">play_arrow</span>
            <span>Run Payroll</span>
        </button>
    </div>

    <!-- Quick Access Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
        <a th:href="@{/payroll/items}" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg"><span class="material-icons-round text-green-600">list_alt</span></div>
                <h3 class="text-lg font-bold">Payroll Items</h3>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Manage allowances, deductions, and their tax/statutory settings.</p>
            <span class="inline-block mt-4 text-primary-600 text-sm font-medium">Configure →</span>
        </a>
        <a th:href="@{/payroll/pay-group}" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg"><span class="material-icons-round text-blue-600">group_work</span></div>
                <h3 class="text-lg font-bold">Paygroups</h3>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Create and manage paygroups, link allowances and deductions.</p>
            <span class="inline-block mt-4 text-primary-600 text-sm font-medium">Manage →</span>
        </a>
        <a th:href="@{/payroll/employee-payroll}" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg"><span class="material-icons-round text-purple-600">badge</span></div>
                <h3 class="text-lg font-bold">Employee Payroll</h3>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">View and edit individual employee payroll, grade, step, and additions.</p>
            <span class="inline-block mt-4 text-primary-600 text-sm font-medium">View all →</span>
        </a>
        <a href="payroll-processing.html" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg"><span class="material-icons-round text-yellow-600">play_circle</span></div>
                <h3 class="text-lg font-bold">Payroll Processing</h3>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Step through the payroll run, approve, and generate reports.</p>
            <span class="inline-block mt-4 text-primary-600 text-sm font-medium">Run payroll →</span>
        </a>
        <a href="job-grades.html" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-3 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg"><span class="material-icons-round text-indigo-600">layers</span></div>
                <h3 class="text-lg font-bold">Job Grades & Steps</h3>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Define job grades, steps, and base salary progression.</p>
            <span class="inline-block mt-4 text-primary-600 text-sm font-medium">Configure →</span>
        </a>
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center space-x-4 mb-4">
                <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg"><span class="material-icons-round text-gray-600">description</span></div>
                <h3 class="text-lg font-bold">Reports</h3>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Generate payroll summaries, tax documents, and compliance reports.</p>
            <button onclick="openModal('payrollReportModal')" class="inline-block mt-4 text-primary-600 text-sm font-medium">Generate →</button>
        </div>
    </div>

    <!-- Run Payroll Modal -->
    <div id="runPayrollModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4 custom-scrollbar">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Run Payroll</h3>
                        <button onclick="closeModal('runPayrollModal')" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons-round">close</span>
                        </button>
                    </div>
                </div>

                <div class="p-6">
                    <form id="runPayrollForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Payroll Period</label>
                            <select class="form-input" required>
                                <option value="january">January 2024</option>
                                <option value="february">February 2024</option>
                                <option value="march">March 2024</option>
                                <option value="april">April 2024</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Start Date</label>
                                <input type="date" class="form-input" value="2024-01-01" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">End Date</label>
                                <input type="date" class="form-input" value="2024-01-31" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Payment Date</label>
                            <input type="date" class="form-input" value="2024-01-31" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Employees Included</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>All Employees (248)</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Include taxable allowances</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Apply statutory deductions</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Payroll Components</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Basic Salary (Job Grade/Step)</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Allowances</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Deductions</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded">
                                    <span>Overtime Payments</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Bonuses</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Payment Method</label>
                            <select class="form-input" required>
                                <option value="bank">Bank Transfer</option>
                                <option value="check">Checks</option>
                                <option value="cash">Cash</option>
                            </select>
                        </div>

                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal('runPayrollModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Run Payroll</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Toggle Payroll Status Modal (Clean professional confirmation dialog) -->
    <div id="togglePayrollModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 id="toggleModalTitle" class="text-xl font-bold">Confirm Action</h3>
                        <button onclick="closeModal('togglePayrollModal')" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons-round">close</span>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <p id="toggleModalMessage" class="text-gray-600 dark:text-gray-400 mb-6">Are you sure you want to change payroll status?</p>
                    <!-- Dynamic form: action set by JavaScript, includes CSRF automatically if using Thymeleaf security -->
                    <form id="togglePayrollForm" method="post" onsubmit="return disableSubmitButton(this);">
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('togglePayrollModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                            <button id="toggleConfirmBtn" type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Confirm</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modal control functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Toggle payroll status logic with dynamic modal configuration
        let currentAction = ''; // 'activate' or 'deactivate'

        function openToggleModal(action) {
            currentAction = action;
            const modal = document.getElementById('togglePayrollModal');
            const title = document.getElementById('toggleModalTitle');
            const message = document.getElementById('toggleModalMessage');
            const confirmBtn = document.getElementById('toggleConfirmBtn');
            const form = document.getElementById('togglePayrollForm');

            if (action === 'activate') {
                title.innerText = 'Open Payroll Period';
                message.innerText = 'Are you sure you want to open the payroll period? This will allow processing to begin.';
                confirmBtn.className = 'px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700';
                confirmBtn.innerText = 'Open Period';
                // Set form action to open endpoint
                form.action = '/setup/payroll/open';  // Adjust if needed: use th:action or context-relative
            } else { // deactivate
                title.innerText = 'Close Payroll Period';
                message.innerText = 'Are you sure you want to close the payroll period? This will pause all processing.';
                confirmBtn.className = 'px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600';
                confirmBtn.innerText = 'Close Period';
                // Set form action to close endpoint
                form.action = '/setup/payroll/close'; // Adjust if needed
            }

            openModal('togglePayrollModal');
        }

        function disableSubmitButton(form) {
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                submitButton.innerHTML = 'Submitting...';
            }
            return true; // Allow form submission
        }

        // Close modal when clicking backdrop (optional enhancement)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-backdrop')) {
                const openModal = document.querySelector('.fixed.inset-0.z-50:not(.hidden)');
                if (openModal) {
                    closeModal(openModal.id);
                }
            }
        });
    </script>
</main>
</body>
</html>