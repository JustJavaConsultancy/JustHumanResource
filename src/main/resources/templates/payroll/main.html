<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>Allowances & Deductions · Payroll Items</title>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                    }
                },
            },
        };
    </script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            overflow-x: hidden;
        }

        .sidebar-item {
            transition: all 0.2s ease;
            position: relative;
        }

        .sidebar-item.active {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-left: 3px solid #3b82f6;
        }

        .sidebar-item.active .material-icons-round {
            color: #3b82f6;
        }

        .sidebar-item:hover:not(.active) {
            background-color: rgba(59, 130, 246, 0.05);
        }

        .dark .sidebar-item.active {
            background-color: rgba(59, 130, 246, 0.2);
        }

        .badge {
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
        }

        .badge-success {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .badge-warning {
            background-color: #fef3c7;
            color: #d97706;
        }

        .badge-error {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .badge-info {
            background-color: #dbeafe;
            color: #2563eb;
        }

        .badge-purple {
            background-color: #f3e8ff;
            color: #9333ea;
        }

        .badge-yellow {
            background-color: #fef3c7;
            color: #d97706;
        }

        .badge-gray {
            background-color: #f1f5f9;
            color: #64748b;
        }

        .tab-active {
            background-color: #3b82f6;
            color: white;
        }

        .form-input {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Fix sidebar and main content positioning */
        .sidebar-container {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 16rem;
            z-index: 40;
            overflow-y: auto;
        }

        .main-content {
            margin-left: 16rem;
            width: calc(100% - 16rem);
            min-height: 100vh;
        }

        @media (max-width: 1023px) {
            .sidebar-container {
                transform: translateX(-100%);
            }

            .sidebar-container.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* Payroll specific styles */
        .allowance-badge {
            background-color: #dcfce7;
            color: #16a34a;
            border: 1px solid #86efac;
        }

        .deduction-badge {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .payroll-card {
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
        }

        .payroll-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .dark .payroll-card {
            border-color: #374151;
        }

        .dark .payroll-card:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .payroll-process-step {
            position: relative;
            padding-left: 2rem;
        }

        .payroll-process-step::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
        }

        .dark .payroll-process-step::before {
            background-color: #374151;
        }

        .payroll-process-step:last-child::before {
            display: none;
        }

        .step-icon {
            position: absolute;
            left: 0;
            top: 0;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .step-completed {
            background-color: #10b981;
            color: white;
        }

        .step-current {
            background-color: #3b82f6;
            color: white;
        }

        .step-pending {
            background-color: #d1d5db;
            color: #6b7280;
        }

        .dark .step-pending {
            background-color: #4b5563;
            color: #9ca3af;
        }

        .salary-breakdown-bar {
            height: 20px;
            border-radius: 4px;
            overflow: hidden;
            background-color: #f3f4f6;
        }

        .dark .salary-breakdown-bar {
            background-color: #374151;
        }

        .taxable-badge {
            background-color: #fef3c7;
            color: #d97706;
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 4px;
        }

        .statutory-badge {
            background-color: #dbeafe;
            color: #2563eb;
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 4px;
        }

        .status-active {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .status-inactive {
            background-color: #f1f5f9;
            color: #64748b;
        }

        .grade-badge {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .grade-1 { background-color: #dbeafe; color: #1e40af; }
        .grade-2 { background-color: #dcfce7; color: #166534; }
        .grade-3 { background-color: #f0f9ff; color: #0c4a6e; }
        .grade-4 { background-color: #fef3c7; color: #92400e; }
        .grade-5 { background-color: #f3e8ff; color: #5b21b6; }
        .grade-6 { background-color: #fce7f3; color: #9d174d; }
        .grade-7 { background-color: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
<main layout:fragment="content">
    <!-- Stats Cards (static numbers for allowances/deductions) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
        <!-- Total Allowances -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
                    <span class="material-icons-round text-green-600 dark:text-green-400">add_circle</span>
                </div>
                <span class="text-sm font-medium text-green-600 flex items-center">
                            <span class="material-icons-round text-sm mr-1">trending_up</span>
                            +2
                        </span>
            </div>
            <h3 th:text="${#lists.size(allowances)}" class="text-2xl font-bold mb-1">8</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Active Allowances</p>
            <div class="mt-3">
                <div class="flex items-center text-xs text-gray-500">
                    <span class="material-icons-round text-xs mr-1">percent</span>
                    <span th:text="${taxableAllowances + ' taxable'}">5 taxable</span>
                </div>
            </div>
        </div>

        <!-- Total Deductions -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-lg">
                    <span class="material-icons-round text-red-600 dark:text-red-400">remove_circle</span>
                </div>
                <span class="badge badge-warning">Compliance</span>
            </div>
            <h3 th:text="${#lists.size(deductions)}" class="text-2xl font-bold mb-1">6</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Active Deductions</p>
            <div class="mt-3">
                <div class="flex items-center text-xs text-gray-500">
                    <span class="material-icons-round text-xs mr-1">gavel</span>
                    <span th:text="${saturatoryDeductions + ' saturatory'}">3 statutory</span>
                </div>
            </div>
        </div>

        <!-- Paygroups (unchanged) -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                    <span class="material-icons-round text-blue-600 dark:text-blue-400">group_work</span>
                </div>
                <span class="text-sm text-gray-500">Active</span>
            </div>
            <h3 class="text-2xl font-bold mb-1" id="totalPaygroups">3</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Paygroups</p>
            <div class="mt-3">
                <div class="flex items-center text-xs text-gray-500">
                    <span class="material-icons-round text-xs mr-1">people</span>
                    <span id="totalEmployeesPaygroups">248 employees</span>
                </div>
            </div>
        </div>

        <!-- Monthly Payroll (unchanged) -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
                    <span class="material-icons-round text-purple-600 dark:text-purple-400">payments</span>
                </div>
                <span class="text-sm font-medium text-green-600 flex items-center">
                            <span class="material-icons-round text-sm mr-1">trending_up</span>
                            +5.2%
                        </span>
            </div>
            <h3 class="text-2xl font-bold mb-1">$476,569</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">Net Payroll</p>
            <div class="mt-3">
                <div class="flex justify-between text-xs">
                    <span class="text-gray-500">Gross: $458,240</span>
                    <span class="font-medium">Tax: $68,736</span>
                </div>
            </div>
        </div>
    </div>

    <div style="display:flex;justify-content:end;margin-bottom:20px">
        <button onclick="openModal('runPayrollModal')" class="hidden md:flex items-center space-x-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
            <span class="material-icons-round text-sm">play_arrow</span>
            <span>Run Payroll</span>
        </button>
    </div>
    <!-- Tabs Navigation -->
    <div class="mb-6">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex space-x-8 overflow-x-auto">
                <button id="payrollItemsTab" class="tab-button py-3 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap" onclick="showTab('payrollItems')">
                    Payroll Items
                </button>
                <button id="paygroupsTab" class="tab-button py-3 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap" onclick="showTab('paygroups')">
                    Paygroups
                </button>
                <button id="employeePayrollTab" class="tab-button py-3 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap" onclick="showTab('employeePayroll')">
                    Employee Payroll
                </button>
                <button id="payrollProcessingTab" class="tab-button py-3 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap" onclick="showTab('payrollProcessing')">
                    Payroll Processing
                </button>
                <button id="jobGradesTab" class="tab-button py-3 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap" onclick="showTab('jobGrades')">
                    Job Grades & Steps
                </button>
            </nav>
        </div>
    </div>

    <!-- Payroll Items Tab (now with Thymeleaf) -->
    <div id="payrollItems" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Allowances Section -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons-round text-green-600">add_circle</span>
                                <h3 class="text-lg font-bold">Allowances</h3>
                            </div>
                            <button onclick="openModal('addAllowanceModal')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
                                Add Allowance
                            </button>
                        </div>
                    </div>

                    <div class="p-4 md:p-6">
                        <!-- Allowances List (shown when data exists) -->
                        <div th:if="${not #lists.isEmpty(allowances)}" class="grid grid-cols-1 md:grid-cols-2 gap-4" id="allowancesList">
                            <div th:each="allowance : ${allowances}" class="payroll-card p-4 rounded-lg">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-bold" th:text="${allowance.name}">Housing Allowance</h4>
                                        <p class="text-sm text-gray-500">
                                            <span th:text="${allowance.code}">ALL-HOUSING</span>
                                            <span th:if="${allowance.taxable}" class="taxable-badge ml-2">Taxable</span>
                                            <span th:unless="${allowance.taxable}" class="text-xs text-gray-500 ml-2">Non-taxable</span>
                                            <span th:if="${allowance.status == 'ACTIVE'}" class="badge badge-success ml-2">Active</span>
                                            <span th:if="${allowance.status == 'INACTIVE'}" class="badge badge-gray ml-2">Inactive</span>
                                        </p>
                                    </div>
                                    <span class="text-lg font-bold text-green-600" th:text="'+ ₦' + ${#numbers.formatDecimal(allowance.amount, 1, 2)}">+ $1200.00</span>
                                </div>
                                <div class="flex justify-between items-center mt-2">
                                    <div class="text-xs text-gray-500" th:text="'ID: ' + ${allowance.id}">ID: 1</div>
                                    <div class="flex space-x-2">
                                        <button th:onclick="'editAllowance(' + ${allowance.id} + ')'" class="text-blue-600 hover:text-blue-700 text-sm">Edit</button>
                                        <button th:onclick="'toggleAllowanceStatus(' + ${allowance.id} + ')'" class="text-gray-600 hover:text-gray-700 text-sm" th:text="${allowance.status == 'ACTIVE' ? 'Deactivate' : 'Activate'}">Deactivate</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Allowances Empty State -->
                        <div th:if="${#lists.isEmpty(allowances)}" class="flex flex-col items-center justify-center py-12 text-center">
                            <span class="material-icons-round text-gray-400 text-5xl mb-4">card_giftcard</span>
                            <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-1">No allowances</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Get started by adding a new allowance.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deductions Section -->
            <div>
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons-round text-red-600">remove_circle</span>
                                <h3 class="text-lg font-bold">Deductions</h3>
                            </div>
                            <button onclick="openModal('addDeductionModal')" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700">
                                Add Deduction
                            </button>
                        </div>
                    </div>

                    <div class="p-4 md:p-6">
                        <!-- Deductions List (shown when data exists) -->
                        <div th:if="${not #lists.isEmpty(deductions)}" class="space-y-4" id="deductionsList">
                            <div th:each="deduction : ${deductions}" class="payroll-card p-4 rounded-lg">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-bold" th:text="${deduction.name}">Health Insurance</h4>
                                        <p class="text-sm text-gray-500">
                                            <span th:text="${deduction.code}">DED-HEALTH</span>
                                            <span th:if="${deduction.statutory}" class="statutory-badge ml-2">Statutory</span>
                                            <span th:unless="${deduction.statutory}" class="text-xs text-gray-500 ml-2">Non-statutory</span>
                                            <span th:if="${deduction.status == 'ACTIVE'}" class="badge badge-success ml-2">Active</span>
                                            <span th:if="${deduction.status == 'INACTIVE'}" class="badge badge-gray ml-2">Inactive</span>
                                        </p>
                                    </div>
                                    <span class="text-lg font-bold text-red-600" th:text="'- ₦' + ${#numbers.formatDecimal(deduction.amount, 1, 2)}">- $150.00</span>
                                </div>
                                <div class="flex justify-between items-center mt-2">
                                    <div class="text-xs text-gray-500" th:text="'ID: ' + ${deduction.id}">ID: 1</div>
                                    <div class="flex space-x-2">
                                        <button th:onclick="'editDeduction(' + ${deduction.id} + ')'" class="text-blue-600 hover:text-blue-700 text-sm">Edit</button>
                                        <button th:onclick="'toggleDeductionStatus(' + ${deduction.id} + ')'" class="text-gray-600 hover:text-gray-700 text-sm" th:text="${deduction.status == 'ACTIVE' ? 'Deactivate' : 'Activate'}">Deactivate</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Deductions Empty State -->
                        <div th:if="${#lists.isEmpty(deductions)}" class="flex flex-col items-center justify-center py-12 text-center">
                            <span class="material-icons-round text-gray-400 text-5xl mb-4">remove_circle_outline</span>
                            <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-1">No deductions</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Get started by adding a new deduction.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Paygroups Tab (unchanged) -->
    <div id="paygroups" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Paygroups List -->
            <div>
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold">Paygroups</h3>
                            <button onclick="openModal('createPaygroupModal')" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">
                                Create Paygroup
                            </button>
                        </div>
                    </div>

                    <div class="p-4 md:p-6">
                        <div class="space-y-4" id="paygroupsList">
                            <!-- Paygroups will be loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paygroup Details -->
            <div>
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-bold">Paygroup Details</h3>
                        <p class="text-sm text-gray-500">Select a paygroup to view details</p>
                    </div>

                    <div class="p-4 md:p-6">
                        <div id="paygroupDetails" class="space-y-6">
                            <div class="text-center py-12 text-gray-500">
                                <span class="material-icons-round text-4xl mb-4">group_work</span>
                                <p>Select a paygroup to view its configuration</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Payroll Tab (unchanged) -->
    <div id="employeePayroll" class="tab-content hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 mb-6">
            <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-bold">Employee Payroll</h3>
                        <p class="text-sm text-gray-500">View and edit employee payroll information</p>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <select id="employeeFilter" class="form-input py-2 w-full md:w-40" onchange="filterEmployeePayroll()">
                            <option value="">All Employees</option>
                            <option value="engineering">Engineering</option>
                            <option value="sales">Sales</option>
                            <option value="marketing">Marketing</option>
                        </select>
                        <select id="paygroupFilter" class="form-input py-2 w-full md:w-40" onchange="filterEmployeePayroll()">
                            <option value="">All Paygroups</option>
                            <option value="executive">Executive Level</option>
                            <option value="mid">Mid Level</option>
                            <option value="junior">Junior Level</option>
                        </select>
                        <select id="gradeFilter" class="form-input py-2 w-full md:w-40" onchange="filterEmployeePayroll()">
                            <option value="">All Grades</option>
                            <option value="1">Grade 1</option>
                            <option value="2">Grade 2</option>
                            <option value="3">Grade 3</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                            <option value="6">Grade 6</option>
                            <option value="7">Grade 7</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-750">
                    <tr>
                        <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Employee</th>
                        <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Grade/Step</th>
                        <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Basic Salary</th>
                        <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Allowances</th>
                        <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Deductions</th>
                        <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Net Salary</th>
                        <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="employeePayrollTable">
                    <!-- Employee payroll rows will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Payroll Processing Tab (unchanged) -->
    <div id="payrollProcessing" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Payroll Process Steps -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-lg font-bold mb-6">Payroll Processing Steps</h3>

                    <div class="space-y-8">
                        <!-- Step 1 -->
                        <div class="payroll-process-step">
                            <div class="step-icon step-completed">
                                <span class="material-icons-round text-sm">check</span>
                            </div>
                            <div class="ml-8">
                                <h4 class="font-bold mb-2">Data Collection</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Collect attendance, leaves, and overtime data for all employees</p>
                                <div class="text-xs text-gray-500">
                                    <span class="material-icons-round text-xs mr-1">calendar_today</span>
                                    Completed: Jan 1, 2024
                                </div>
                            </div>
                        </div>

                        <!-- Step 2 -->
                        <div class="payroll-process-step">
                            <div class="step-icon step-completed">
                                <span class="material-icons-round text-sm">check</span>
                            </div>
                            <div class="ml-8">
                                <h4 class="font-bold mb-2">Salary Calculations</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Calculate basic salary based on Job Grade/Step, allowances, deductions, and net pay</p>
                                <div class="text-xs text-gray-500">
                                    <span class="material-icons-round text-xs mr-1">calendar_today</span>
                                    Completed: Jan 5, 2024
                                </div>
                            </div>
                        </div>

                        <!-- Step 3 -->
                        <div class="payroll-process-step">
                            <div class="step-icon step-current">
                                <span class="material-icons-round text-sm">edit</span>
                            </div>
                            <div class="ml-8">
                                <h4 class="font-bold mb-2">Review & Approval</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Review payroll calculations and get management approval</p>
                                <div class="flex items-center space-x-3 mt-4">
                                    <button onclick="approvePayroll()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
                                        Approve Payroll
                                    </button>
                                    <button onclick="openModal('adjustPayrollModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">
                                        Make Adjustments
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4 -->
                        <div class="payroll-process-step">
                            <div class="step-icon step-pending">
                                <span class="material-icons-round text-sm">payments</span>
                            </div>
                            <div class="ml-8">
                                <h4 class="font-bold mb-2">Payment Processing</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Process payments through bank transfer or checks</p>
                                <div class="text-xs text-gray-500">
                                    <span class="material-icons-round text-xs mr-1">schedule</span>
                                    Scheduled: Jan 31, 2024
                                </div>
                            </div>
                        </div>

                        <!-- Step 5 -->
                        <div class="payroll-process-step">
                            <div class="step-icon step-pending">
                                <span class="material-icons-round text-sm">description</span>
                            </div>
                            <div class="ml-8">
                                <h4 class="font-bold mb-2">Reports & Compliance</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Generate payroll reports and tax compliance documents</p>
                                <div class="text-xs text-gray-500">
                                    <span class="material-icons-round text-xs mr-1">schedule</span>
                                    Scheduled: Feb 5, 2024
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payroll Summary -->
            <div>
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-lg font-bold mb-6">Current Payroll Summary</h3>

                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600 dark:text-gray-400">Total Employees</span>
                                <span class="font-bold">248</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600 dark:text-gray-400">Total Gross Salary</span>
                                <span class="font-bold">$458,240</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600 dark:text-gray-400">Taxable Allowances</span>
                                <span class="font-bold text-yellow-600">+ $45,800</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600 dark:text-gray-400">Statutory Deductions</span>
                                <span class="font-bold text-blue-600">- $91,648</span>
                            </div>
                            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold">Net Payroll Amount</span>
                                    <span class="text-2xl font-bold text-primary-600">$476,569</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-bold mb-4">Tax Breakdown</h4>
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Basic Salary Tax</span>
                                        <span>$68,736</span>
                                    </div>
                                    <div class="salary-breakdown-bar">
                                        <div class="h-full bg-blue-500" style="width: 70%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Taxable Allowances</span>
                                        <span>$9,160</span>
                                    </div>
                                    <div class="salary-breakdown-bar">
                                        <div class="h-full bg-yellow-500" style="width: 15%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Other Taxes</span>
                                        <span>$6,880</span>
                                    </div>
                                    <div class="salary-breakdown-bar">
                                        <div class="h-full bg-red-500" style="width: 15%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button onclick="openModal('runPayrollModal')" class="w-full px-4 py-3 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 flex items-center justify-center space-x-2">
                            <span class="material-icons-round">play_arrow</span>
                            <span>Run Payroll Now</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Grades & Steps Tab (unchanged) -->
    <div id="jobGrades" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Job Grades List -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons-round text-primary-600">layers</span>
                                <h3 class="text-lg font-bold">Job Grades & Steps</h3>
                                <span class="text-sm text-gray-500">(Base Salary Structure)</span>
                            </div>
                            <button onclick="openModal('addJobGradeModal')" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">
                                Add Grade
                            </button>
                        </div>
                    </div>

                    <div class="p-4 md:p-6">
                        <div class="space-y-6" id="jobGradesList">
                            <!-- Job grades will be loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Salary Progression -->
            <div>
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-lg font-bold mb-6">Salary Progression</h3>

                    <div class="space-y-6">
                        <div>
                            <h4 class="font-bold mb-4">Grade Statistics</h4>
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Total Grades</span>
                                        <span class="font-bold">7</span>
                                    </div>
                                    <div class="salary-breakdown-bar">
                                        <div class="h-full bg-blue-500" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Total Steps</span>
                                        <span class="font-bold">35</span>
                                    </div>
                                    <div class="salary-breakdown-bar">
                                        <div class="h-full bg-green-500" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Salary Range</span>
                                        <span class="font-bold">$1,500 - $16,500</span>
                                    </div>
                                    <div class="salary-breakdown-bar">
                                        <div class="h-full bg-purple-500" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-bold mb-4">Employee Distribution</h4>
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Grade 1-3 (Junior)</span>
                                        <span class="font-bold">750 employees</span>
                                    </div>
                                    <div class="salary-breakdown-bar">
                                        <div class="h-full bg-green-500" style="width: 60%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Grade 4-5 (Mid)</span>
                                        <span class="font-bold">330 employees</span>
                                    </div>
                                    <div class="salary-breakdown-bar">
                                        <div class="h-full bg-blue-500" style="width: 26%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Grade 6-7 (Senior)</span>
                                        <span class="font-bold">168 employees</span>
                                    </div>
                                    <div class="salary-breakdown-bar">
                                        <div class="h-full bg-purple-500" style="width: 14%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h4 class="font-bold mb-3">Quick Actions</h4>
                            <div class="space-y-2">
                                <button onclick="openModal('addJobStepModal')" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
                                    Add Job Step
                                </button>
                                <button onclick="exportJobStructure()" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">
                                    Export Structure
                                </button>
                                <a href="job-structure.html" class="block w-full px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 text-center">
                                    View Detailed Structure
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Run Payroll Modal (unchanged) -->
    <div id="runPayrollModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4 custom-scrollbar">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Run Payroll</h3>
                        <button onclick="closeModal('runPayrollModal')" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons-round">close</span>
                        </button>
                    </div>
                </div>

                <div class="p-6">
                    <form id="runPayrollForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Payroll Period</label>
                            <select class="form-input" required>
                                <option value="january">January 2024</option>
                                <option value="february">February 2024</option>
                                <option value="march">March 2024</option>
                                <option value="april">April 2024</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Start Date</label>
                                <input type="date" class="form-input" value="2024-01-01" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">End Date</label>
                                <input type="date" class="form-input" value="2024-01-31" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Payment Date</label>
                            <input type="date" class="form-input" value="2024-01-31" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Employees Included</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>All Employees (248)</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Include taxable allowances</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Apply statutory deductions</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Payroll Components</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Basic Salary (Job Grade/Step)</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Allowances</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Deductions</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded">
                                    <span>Overtime Payments</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Bonuses</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Payment Method</label>
                            <select class="form-input" required>
                                <option value="bank">Bank Transfer</option>
                                <option value="check">Checks</option>
                                <option value="cash">Cash</option>
                            </select>
                        </div>

                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal('runPayrollModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Run Payroll</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Paygroup Modal (unchanged) -->
    <div id="createPaygroupModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Create New Paygroup</h3>
                        <button onclick="closeModal('createPaygroupModal')" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons-round">close</span>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <form th:action="@{/createPayGroup}" method="post" id="createPaygroupForm" class="space-y-6" onsubmit="disableSubmitButton(this)">
                        <div>
                            <label class="block text-sm font-medium mb-2">Paygroup Name *</label>
                            <input name="name" type="text" class="form-input" placeholder="Enter paygroup name" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Pay Frequency *</label>
                            <select name="payFrequency" class="form-input" required>
                                <option value="">Select frequency</option>
                                <option value="BI_WEEKLY">BI_Weekly</option>
                                <option value="WEEKLY">Weekly</option>
                                <option value="MONTHLY">Monthly</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal('createPaygroupModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Create Paygroup</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Employee Payroll Modal (unchanged) -->
    <div id="editEmployeePayrollModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4 custom-scrollbar">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <img id="employeeAvatar" src="" class="w-12 h-12 rounded-full">
                            <div>
                                <h3 class="text-xl font-bold" id="employeeName">Edit Payroll</h3>
                                <p class="text-gray-600 dark:text-gray-400" id="employeeDetails">Employee details</p>
                            </div>
                        </div>
                        <button onclick="closeModal('editEmployeePayrollModal')" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons-round">close</span>
                        </button>
                    </div>
                </div>

                <div class="p-6">
                    <form id="editEmployeePayrollForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Job Grade/Step</label>
                                <div class="flex space-x-3">
                                    <select id="jobGradeSelect" class="form-input flex-1" required>
                                        <option value="">Select Grade</option>
                                        <option value="1">Grade 1 - Entry Level</option>
                                        <option value="2">Grade 2 - Associate</option>
                                        <option value="3">Grade 3 - Senior Associate</option>
                                        <option value="4">Grade 4 - Team Lead</option>
                                        <option value="5">Grade 5 - Manager</option>
                                        <option value="6">Grade 6 - Senior Manager</option>
                                        <option value="7">Grade 7 - Director</option>
                                    </select>
                                    <select id="jobStepSelect" class="form-input w-32" required>
                                        <option value="">Step</option>
                                        <option value="1">Step 1</option>
                                        <option value="2">Step 2</option>
                                        <option value="3">Step 3</option>
                                        <option value="4">Step 4</option>
                                        <option value="5">Step 5</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">Basic Salary</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2">$</span>
                                    <input type="number" id="basicSalary" class="form-input pl-8" readonly>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Based on Grade/Step selection</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Paygroup</label>
                            <select id="paygroupSelect" class="form-input" required>
                                <option value="">Select Paygroup</option>
                                <option value="executive">Executive Level</option>
                                <option value="mid">Mid Level</option>
                                <option value="junior">Junior Level</option>
                            </select>
                        </div>

                        <div>
                            <h4 class="font-bold mb-4">Additional Allowances</h4>
                            <div class="space-y-3" id="employeeAllowances">
                                <!-- Allowances will be loaded dynamically -->
                            </div>
                        </div>

                        <div>
                            <h4 class="font-bold mb-4">Additional Deductions</h4>
                            <div class="space-y-3" id="employeeDeductions">
                                <!-- Deductions will be loaded dynamically -->
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-750 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold">Basic Salary</span>
                                <span class="font-bold" id="summaryBasic">$0</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold">Total Allowances</span>
                                <span class="font-bold text-green-600" id="summaryAllowances">+ $0</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold">Total Deductions</span>
                                <span class="font-bold text-red-600" id="summaryDeductions">- $0</span>
                            </div>
                            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold">Net Salary</span>
                                    <span class="text-2xl font-bold text-primary-600" id="summaryNet">$0</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal('editEmployeePayrollModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Job Grade Modal (unchanged) -->
    <div id="addJobGradeModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Add Job Grade</h3>
                    <button onclick="closeModal('addJobGradeModal')" class="text-gray-400 hover:text-gray-600">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
                <form id="addJobGradeForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Grade Code *</label>
                        <input type="text" class="form-input" placeholder="e.g., GRD-001" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Grade Name *</label>
                        <input type="text" class="form-input" placeholder="e.g., Junior Associate" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Grade Level</label>
                        <input type="number" min="1" max="10" class="form-input" placeholder="1-10">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Description</label>
                        <textarea class="form-input h-24" placeholder="Description of this job grade..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('addJobGradeModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Add Grade</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Job Step Modal (unchanged) -->
    <div id="addJobStepModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Add Job Step</h3>
                    <button onclick="closeModal('addJobStepModal')" class="text-gray-400 hover:text-gray-600">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
                <form id="addJobStepForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Job Grade *</label>
                        <select class="form-input" required>
                            <option value="">Select a grade</option>
                            <option value="1">Grade 1 - Entry Level</option>
                            <option value="2">Grade 2 - Associate</option>
                            <option value="3">Grade 3 - Senior Associate</option>
                            <option value="4">Grade 4 - Team Lead</option>
                            <option value="5">Grade 5 - Manager</option>
                            <option value="6">Grade 6 - Senior Manager</option>
                            <option value="7">Grade 7 - Director</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Step Level *</label>
                        <input type="number" min="1" max="10" class="form-input" placeholder="1-10" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Base Salary *</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2">$</span>
                            <input type="number" step="0.01" class="form-input pl-8" placeholder="0.00" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Description</label>
                        <textarea class="form-input h-24" placeholder="Additional information about this step..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('addJobStepModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Add Step</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ========== Data models (kept for other tabs) ==========
        const allowances = [
            { id: 1, code: 'ALL-HOUSING', name: 'Housing Allowance', amount: 1200.00, taxable: true, status: 'ACTIVE' },
            { id: 2, code: 'ALL-TRANSPORT', name: 'Transport Allowance', amount: 400.00, taxable: false, status: 'ACTIVE' },
            { id: 3, code: 'ALL-MEAL', name: 'Meal Allowance', amount: 150.00, taxable: true, status: 'ACTIVE' },
            { id: 4, code: 'ALL-PERFORMANCE', name: 'Performance Bonus', amount: 2000.00, taxable: true, status: 'ACTIVE' },
            { id: 5, code: 'ALL-MEDICAL', name: 'Medical Allowance', amount: 200.00, taxable: false, status: 'ACTIVE' },
            { id: 6, code: 'ALL-COMMUNICATION', name: 'Communication Allowance', amount: 100.00, taxable: true, status: 'ACTIVE' },
            { id: 7, code: 'ALL-TRANSPORT-FUEL', name: 'Fuel Allowance', amount: 300.00, taxable: true, status: 'ACTIVE' },
            { id: 8, code: 'ALL-EDUCATION', name: 'Education Allowance', amount: 500.00, taxable: false, status: 'ACTIVE' }
        ];

        const deductions = [
            { id: 1, code: 'DED-HEALTH', name: 'Health Insurance', amount: 150.00, statutory: false, status: 'ACTIVE' },
            { id: 2, code: 'DED-TAX', name: 'Income Tax', amount: 15.00, statutory: true, status: 'ACTIVE' },
            { id: 3, code: 'DED-PENSION', name: 'Pension Contribution', amount: 5.00, statutory: true, status: 'ACTIVE' },
            { id: 4, code: 'DED-LIFE-INS', name: 'Life Insurance', amount: 100.00, statutory: false, status: 'ACTIVE' },
            { id: 5, code: 'DED-LOAN', name: 'Loan Deduction', amount: 200.00, statutory: false, status: 'ACTIVE' },
            { id: 6, code: 'DED-UNION', name: 'Union Dues', amount: 50.00, statutory: true, status: 'ACTIVE' }
        ];

        const paygroups = [
            { id: 1, name: 'Executive Level', description: 'C-level executives and directors with highest compensation packages',
              salarySource: 'jobGrade', linkedGrades: [6, 7], employees: 12, allowances: [1, 2, 4, 7], deductions: [1, 2, 3, 4] },
            { id: 2, name: 'Mid Level', description: 'Managers and senior professionals with competitive compensation',
              salarySource: 'jobGrade', linkedGrades: [4, 5], employees: 45, allowances: [2, 3, 5, 6], deductions: [1, 2, 3, 5] },
            { id: 3, name: 'Junior Level', description: 'Entry-level employees and early-career professionals',
              salarySource: 'jobGrade', linkedGrades: [1, 2, 3], employees: 89, allowances: [2, 3], deductions: [1, 2, 3, 6] }
        ];

        const jobGrades = [
            { id: 1, code: 'GRD-001', name: 'Entry Level', level: 1, description: 'Entry level positions', employees: 150 },
            { id: 2, code: 'GRD-002', name: 'Associate', level: 2, description: 'Junior associate roles', employees: 280 },
            { id: 3, code: 'GRD-003', name: 'Senior Associate', level: 3, description: 'Experienced individual contributors', employees: 320 },
            { id: 4, code: 'GRD-004', name: 'Team Lead', level: 4, description: 'Team leadership positions', employees: 180 },
            { id: 5, code: 'GRD-005', name: 'Manager', level: 5, description: 'Department managers', employees: 150 },
            { id: 6, code: 'GRD-006', name: 'Senior Manager', level: 6, description: 'Senior management roles', employees: 90 },
            { id: 7, code: 'GRD-007', name: 'Director', level: 7, description: 'Executive leadership', employees: 78 }
        ];

        const jobSteps = [
            { id: 1, gradeId: 1, stepLevel: 1, baseSalary: 1500.00 },
            { id: 2, gradeId: 1, stepLevel: 2, baseSalary: 1800.00 },
            { id: 3, gradeId: 1, stepLevel: 3, baseSalary: 2100.00 },
            { id: 4, gradeId: 1, stepLevel: 4, baseSalary: 2400.00 },
            { id: 5, gradeId: 1, stepLevel: 5, baseSalary: 2700.00 },
            { id: 6, gradeId: 2, stepLevel: 1, baseSalary: 2800.00 },
            { id: 7, gradeId: 2, stepLevel: 2, baseSalary: 3200.00 },
            { id: 8, gradeId: 2, stepLevel: 3, baseSalary: 3600.00 },
            { id: 9, gradeId: 2, stepLevel: 4, baseSalary: 4000.00 },
            { id: 10, gradeId: 2, stepLevel: 5, baseSalary: 4400.00 },
            { id: 11, gradeId: 3, stepLevel: 1, baseSalary: 4500.00 },
            { id: 12, gradeId: 3, stepLevel: 2, baseSalary: 5000.00 },
            { id: 13, gradeId: 3, stepLevel: 3, baseSalary: 5500.00 },
            { id: 14, gradeId: 3, stepLevel: 4, baseSalary: 6000.00 },
            { id: 15, gradeId: 3, stepLevel: 5, baseSalary: 6500.00 },
            { id: 16, gradeId: 4, stepLevel: 1, baseSalary: 7000.00 },
            { id: 17, gradeId: 4, stepLevel: 2, baseSalary: 7500.00 },
            { id: 18, gradeId: 4, stepLevel: 3, baseSalary: 8000.00 },
            { id: 19, gradeId: 4, stepLevel: 4, baseSalary: 8500.00 },
            { id: 20, gradeId: 4, stepLevel: 5, baseSalary: 9000.00 },
            { id: 21, gradeId: 5, stepLevel: 1, baseSalary: 9500.00 },
            { id: 22, gradeId: 5, stepLevel: 2, baseSalary: 10000.00 },
            { id: 23, gradeId: 5, stepLevel: 3, baseSalary: 10500.00 },
            { id: 24, gradeId: 5, stepLevel: 4, baseSalary: 11000.00 },
            { id: 25, gradeId: 5, stepLevel: 5, baseSalary: 11500.00 },
            { id: 26, gradeId: 6, stepLevel: 1, baseSalary: 12000.00 },
            { id: 27, gradeId: 6, stepLevel: 2, baseSalary: 12500.00 },
            { id: 28, gradeId: 6, stepLevel: 3, baseSalary: 13000.00 },
            { id: 29, gradeId: 6, stepLevel: 4, baseSalary: 13500.00 },
            { id: 30, gradeId: 6, stepLevel: 5, baseSalary: 14000.00 },
            { id: 31, gradeId: 7, stepLevel: 1, baseSalary: 14500.00 },
            { id: 32, gradeId: 7, stepLevel: 2, baseSalary: 15000.00 },
            { id: 33, gradeId: 7, stepLevel: 3, baseSalary: 15500.00 },
            { id: 34, gradeId: 7, stepLevel: 4, baseSalary: 16000.00 },
            { id: 35, gradeId: 7, stepLevel: 5, baseSalary: 16500.00 }
        ];

        const employees = [
            { id: 1, name: 'Sarah Jenkins', department: 'Engineering', gradeId: 4, stepLevel: 2, paygroupId: 2, avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=48&h=48&q=80' },
            { id: 2, name: 'Mike Ross', department: 'Sales', gradeId: 2, stepLevel: 3, paygroupId: 3, avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=48&h=48&q=80' },
            { id: 3, name: 'John Doe', department: 'Engineering', gradeId: 3, stepLevel: 1, paygroupId: 2, avatar: null },
            { id: 4, name: 'Sophia Miller', department: 'Product', gradeId: 6, stepLevel: 2, paygroupId: 1, avatar: null },
            { id: 5, name: 'Robert Chen', department: 'Marketing', gradeId: 5, stepLevel: 3, paygroupId: 2, avatar: null },
            { id: 6, name: 'Emma Wilson', department: 'HR', gradeId: 1, stepLevel: 4, paygroupId: 3, avatar: null }
        ];

        let currentPaygroup = null;
        let currentEmployee = null;

        // Initialize the page (load only non-allowance/deduction sections)
        document.addEventListener('DOMContentLoaded', function() {
            loadPaygroups();
            loadEmployeePayroll();
            loadJobGrades();
            updateStats(); // updates paygroups and employees stats only

            // Form submissions
            document.getElementById('runPayrollForm').addEventListener('submit', handleRunPayroll);
            document.getElementById('editEmployeePayrollForm').addEventListener('submit', handleEditEmployeePayroll);
            document.getElementById('addJobGradeForm').addEventListener('submit', handleAddJobGrade);
            document.getElementById('addJobStepForm').addEventListener('submit', handleAddJobStep);

            // Job grade/step salary calculation
            document.getElementById('jobGradeSelect').addEventListener('change', updateEmployeeSalary);
            document.getElementById('jobStepSelect').addEventListener('change', updateEmployeeSalary);
            document.getElementById('paygroupSelect').addEventListener('change', updateEmployeePaygroup);

            // Initialize theme
            initializeTheme();
        });

        // New function to disable submit button on form submission
        function disableSubmitButton(form) {
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                submitButton.innerHTML = 'Submitting...';
            }
            return true; // allow form to submit
        }

        // Removed loadAllowances, loadDeductions, editAllowance, editDeduction, toggleAllowanceStatus, toggleDeductionStatus, filterPayrollItems

        function loadPaygroups() {
            const container = document.getElementById('paygroupsList');
            container.innerHTML = '';

            paygroups.forEach(paygroup => {
                const paygroupElement = document.createElement('div');
                paygroupElement.className = 'payroll-card p-4 rounded-lg cursor-pointer';
                paygroupElement.onclick = () => viewPaygroupDetails(paygroup.id);

                if (currentPaygroup === paygroup.id) {
                    paygroupElement.classList.add('ring-2', 'ring-primary-500');
                }

                const gradeBadges = paygroup.linkedGrades.map(g => `<span class="grade-badge grade-${g} ml-1">G${g}</span>`).join('');

                paygroupElement.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold">${paygroup.name}</h4>
                            <p class="text-sm text-gray-500">${paygroup.description}</p>
                        </div>
                        <span class="badge badge-info">${paygroup.employees} Employees</span>
                    </div>
                    <div class="mb-3">
                        ${gradeBadges}
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Allowances</span>
                            <span class="text-green-600">${paygroup.allowances.length} items</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Deductions</span>
                            <span class="text-red-600">${paygroup.deductions.length} items</span>
                        </div>
                    </div>
                `;

                container.appendChild(paygroupElement);
            });
        }

        function viewPaygroupDetails(paygroupId) {
            currentPaygroup = paygroupId;
            const paygroup = paygroups.find(p => p.id === paygroupId);
            const container = document.getElementById('paygroupDetails');

            if (!paygroup) return;

            const gradeBadges = paygroup.linkedGrades.map(g => {
                const grade = jobGrades.find(jg => jg.id === g);
                return `<span class="grade-badge grade-${g}">${grade.name}</span>`;
            }).join('');

            const allowanceList = paygroup.allowances.map(aid => {
                const allowance = allowances.find(a => a.id === aid);
                if (!allowance) return '';
                return `<div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                    <div>
                        <span class="text-sm font-medium">${allowance.name}</span>
                        <span class="text-xs text-gray-500 ml-2">${allowance.code}</span>
                        ${allowance.taxable ? '<span class="taxable-badge ml-2">Taxable</span>' : ''}
                    </div>
                    <span class="font-bold text-green-600">+ $${allowance.amount.toFixed(2)}</span>
                </div>`;
            }).join('');

            const deductionList = paygroup.deductions.map(did => {
                const deduction = deductions.find(d => d.id === did);
                if (!deduction) return '';
                return `<div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                    <div>
                        <span class="text-sm font-medium">${deduction.name}</span>
                        <span class="text-xs text-gray-500 ml-2">${deduction.code}</span>
                        ${deduction.statutory ? '<span class="statutory-badge ml-2">Statutory</span>' : ''}
                    </div>
                    <span class="font-bold text-red-600">- $${deduction.amount.toFixed(2)}</span>
                </div>`;
            }).join('');

            container.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-xl font-bold">${paygroup.name}</h4>
                            <p class="text-gray-600 dark:text-gray-400">${paygroup.description}</p>
                        </div>
                        <span class="badge badge-info">${paygroup.employees} Employees</span>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <h5 class="font-bold mb-3">Linked Job Grades</h5>
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${gradeBadges}
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-750 rounded-lg p-4">
                                <div class="flex justify-between items-center">
                                    <span>Base Salary Source</span>
                                    <span class="font-bold">${paygroup.salarySource === 'jobGrade' ? 'Job Grade/Step' : 'Fixed Range'}</span>
                                </div>
                                <div class="text-sm text-gray-500 mt-2">
                                    <span class="material-icons-round text-xs mr-1">info</span>
                                    ${paygroup.salarySource === 'jobGrade'
                                        ? 'Basic salary determined by employee Job Grade and Step'
                                        : 'Fixed salary range applied to all employees in this paygroup'}
                                </div>
                            </div>
                        </div>

                        <div>
                            <h5 class="font-bold mb-3">Allowances (${paygroup.allowances.length})</h5>
                            <div class="space-y-2">
                                ${allowanceList || '<p class="text-gray-500 text-sm">No allowances assigned</p>'}
                            </div>
                        </div>

                        <div>
                            <h5 class="font-bold mb-3">Deductions (${paygroup.deductions.length})</h5>
                            <div class="space-y-2">
                                ${deductionList || '<p class="text-gray-500 text-sm">No deductions assigned</p>'}
                            </div>
                        </div>

                        <div class="flex space-x-3 pt-4">
                            <button onclick="editPaygroup(${paygroup.id})" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">
                                Edit Paygroup
                            </button>
                            <button onclick="deletePaygroup(${paygroup.id})" class="px-4 py-2 border border-red-600 text-red-600 rounded-lg text-sm font-medium hover:bg-red-50 dark:hover:bg-red-900/20">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;

            loadPaygroups();
        }

        function loadEmployeePayroll() {
            const container = document.getElementById('employeePayrollTable');
            container.innerHTML = '';

            employees.forEach(employee => {
                const grade = jobGrades.find(g => g.id === employee.gradeId);
                const step = jobSteps.find(s => s.gradeId === employee.gradeId && s.stepLevel === employee.stepLevel);
                const paygroup = paygroups.find(p => p.id === employee.paygroupId);

                if (!grade || !step || !paygroup) return;

                const basicSalary = step.baseSalary;
                const allowanceTotal = calculateEmployeeAllowances(employee);
                const deductionTotal = calculateEmployeeDeductions(employee);
                const netSalary = basicSalary + allowanceTotal - deductionTotal;

                const avatar = employee.avatar
                    ? `<img src="${employee.avatar}" class="w-8 h-8 rounded-full">`
                    : `<div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">${employee.name.split(' ').map(n => n[0]).join('')}</div>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 md:px-6 py-4">
                        <div class="flex items-center">
                            ${avatar}
                            <div class="ml-3">
                                <div class="text-sm font-medium">${employee.name}</div>
                                <div class="text-xs text-gray-500">${employee.department}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 md:px-6 py-4">
                        <span class="grade-badge grade-${grade.id}">${grade.name}</span>
                        <span class="text-xs text-gray-500 ml-2">Step ${employee.stepLevel}</span>
                    </td>
                    <td class="px-4 md:px-6 py-4">
                        <div class="text-sm font-bold">$${basicSalary.toFixed(2)}</div>
                    </td>
                    <td class="px-4 md:px-6 py-4">
                        <div class="text-sm text-green-600">+ $${allowanceTotal.toFixed(2)}</div>
                    </td>
                    <td class="px-4 md:px-6 py-4">
                        <div class="text-sm text-red-600">- $${deductionTotal.toFixed(2)}</div>
                    </td>
                    <td class="px-4 md:px-6 py-4">
                        <div class="text-lg font-bold text-primary-600">$${netSalary.toFixed(2)}</div>
                    </td>
                    <td class="px-4 md:px-6 py-4">
                        <button onclick="editEmployeePayroll(${employee.id})" class="text-primary-600 hover:text-primary-700 text-sm font-medium">Edit</button>
                    </td>
                `;

                container.appendChild(row);
            });
        }

        function calculateEmployeeAllowances(employee) {
            const paygroup = paygroups.find(p => p.id === employee.paygroupId);
            if (!paygroup) return 0;

            let total = 0;
            paygroup.allowances.forEach(allowanceId => {
                const allowance = allowances.find(a => a.id === allowanceId);
                if (allowance && allowance.status === 'ACTIVE') {
                    total += allowance.amount;
                }
            });

            return total;
        }

        function calculateEmployeeDeductions(employee) {
            const paygroup = paygroups.find(p => p.id === employee.paygroupId);
            if (!paygroup) return 0;

            let total = 0;
            const step = jobSteps.find(s => s.gradeId === employee.gradeId && s.stepLevel === employee.stepLevel);
            if (!step) return 0;

            paygroup.deductions.forEach(deductionId => {
                const deduction = deductions.find(d => d.id === deductionId);
                if (deduction && deduction.status === 'ACTIVE') {
                    total += deduction.amount;
                }
            });

            return total;
        }

        function loadJobGrades() {
            const container = document.getElementById('jobGradesList');
            container.innerHTML = '';

            jobGrades.forEach(grade => {
                const gradeSteps = jobSteps.filter(s => s.gradeId === grade.id);
                const minSalary = Math.min(...gradeSteps.map(s => s.baseSalary));
                const maxSalary = Math.max(...gradeSteps.map(s => s.baseSalary));

                const gradeElement = document.createElement('div');
                gradeElement.className = 'payroll-card p-4 rounded-lg';

                gradeElement.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="flex items-center space-x-3">
                                <span class="grade-badge grade-${grade.id} text-lg">${grade.name}</span>
                                <span class="text-sm text-gray-500">${grade.code}</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${grade.description}</p>
                        </div>
                        <span class="badge badge-info">${grade.employees} Employees</span>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Salary Range</span>
                            <span class="font-bold">$${minSalary.toFixed(2)} - $${maxSalary.toFixed(2)}</span>
                        </div>
                        <div class="salary-breakdown-bar">
                            <div class="h-full bg-primary-500" style="width: ${((grade.id - 1) / 6 * 100)}%"></div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <h5 class="font-bold text-sm">Steps:</h5>
                        ${gradeSteps.map(step => `
                            <div class="flex justify-between items-center text-sm">
                                <span>Step ${step.stepLevel}</span>
                                <span class="font-medium">$${step.baseSalary.toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.appendChild(gradeElement);
            });
        }

        function updateStats() {
            // Only update paygroups and employees stats (allowances/deductions are static)
            document.getElementById('totalPaygroups').textContent = paygroups.length;
            document.getElementById('totalEmployeesPaygroups').textContent = `${employees.length} employees`;
        }

        function editEmployeePayroll(employeeId) {
            currentEmployee = employees.find(e => e.id === employeeId);
            if (!currentEmployee) return;

            const grade = jobGrades.find(g => g.id === currentEmployee.gradeId);
            const step = jobSteps.find(s => s.gradeId === currentEmployee.gradeId && s.stepLevel === currentEmployee.stepLevel);
            const paygroup = paygroups.find(p => p.id === currentEmployee.paygroupId);

            document.getElementById('employeeName').textContent = `Edit Payroll - ${currentEmployee.name}`;
            document.getElementById('employeeDetails').textContent = `${currentEmployee.department} • Employee ID: EMP-${String(currentEmployee.id).padStart(5, '0')}`;

            if (currentEmployee.avatar) {
                document.getElementById('employeeAvatar').src = currentEmployee.avatar;
                document.getElementById('employeeAvatar').classList.remove('hidden');
            } else {
                document.getElementById('employeeAvatar').classList.add('hidden');
            }

            document.getElementById('jobGradeSelect').value = currentEmployee.gradeId;
            document.getElementById('jobStepSelect').value = currentEmployee.stepLevel;
            document.getElementById('paygroupSelect').value = currentEmployee.paygroupId;
            document.getElementById('basicSalary').value = step ? step.baseSalary.toFixed(2) : '';

            loadEmployeeAllowancesSelection();
            loadEmployeeDeductionsSelection();
            updateEmployeeSummary();

            openModal('editEmployeePayrollModal');
        }

        function loadEmployeeAllowancesSelection() {
            const container = document.getElementById('employeeAllowances');
            container.innerHTML = '';

            allowances.filter(a => a.status === 'ACTIVE').forEach(allowance => {
                const isInPaygroup = currentEmployee && paygroups.find(p => p.id === currentEmployee.paygroupId)?.allowances.includes(allowance.id);

                container.innerHTML += `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" value="${allowance.id}" class="rounded employee-allowance"
                                   ${isInPaygroup ? 'checked disabled' : ''}>
                            <div>
                                <span class="text-sm">${allowance.name}</span>
                                ${isInPaygroup ? '<span class="text-xs text-green-600 ml-2">(From paygroup)</span>' : ''}
                            </div>
                        </div>
                        <input type="number" class="form-input w-32 allowance-amount"
                               value="${allowance.amount}" step="0.01"
                               ${isInPaygroup ? 'disabled' : ''}>
                    </div>
                `;
            });

            document.querySelectorAll('.employee-allowance').forEach(checkbox => {
                checkbox.addEventListener('change', updateEmployeeSummary);
            });

            document.querySelectorAll('.allowance-amount').forEach(input => {
                input.addEventListener('input', updateEmployeeSummary);
            });
        }

        function loadEmployeeDeductionsSelection() {
            const container = document.getElementById('employeeDeductions');
            container.innerHTML = '';

            deductions.filter(d => d.status === 'ACTIVE').forEach(deduction => {
                const isInPaygroup = currentEmployee && paygroups.find(p => p.id === currentEmployee.paygroupId)?.deductions.includes(deduction.id);

                container.innerHTML += `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" value="${deduction.id}" class="rounded employee-deduction"
                                   ${isInPaygroup ? 'checked disabled' : ''}>
                            <div>
                                <span class="text-sm">${deduction.name}</span>
                                ${isInPaygroup ? '<span class="text-xs text-blue-600 ml-2">(From paygroup)</span>' : ''}
                            </div>
                        </div>
                        <input type="number" class="form-input w-32 deduction-amount"
                               value="${deduction.amount}" step="0.01"
                               ${isInPaygroup ? 'disabled' : ''}>
                    </div>
                `;
            });

            document.querySelectorAll('.employee-deduction').forEach(checkbox => {
                checkbox.addEventListener('change', updateEmployeeSummary);
            });

            document.querySelectorAll('.deduction-amount').forEach(input => {
                input.addEventListener('input', updateEmployeeSummary);
            });
        }

        function updateEmployeeSalary() {
            const gradeId = parseInt(document.getElementById('jobGradeSelect').value);
            const stepLevel = parseInt(document.getElementById('jobStepSelect').value);

            if (gradeId && stepLevel) {
                const step = jobSteps.find(s => s.gradeId === gradeId && s.stepLevel === stepLevel);
                if (step) {
                    document.getElementById('basicSalary').value = step.baseSalary.toFixed(2);
                    updateEmployeeSummary();
                }
            }
        }

        function updateEmployeePaygroup() {
            const paygroupId = parseInt(document.getElementById('paygroupSelect').value);
            if (currentEmployee && paygroupId) {
                currentEmployee.paygroupId = paygroupId;
                loadEmployeeAllowancesSelection();
                loadEmployeeDeductionsSelection();
                updateEmployeeSummary();
            }
        }

        function updateEmployeeSummary() {
            const basicSalary = parseFloat(document.getElementById('basicSalary').value) || 0;

            let totalAllowances = 0;
            document.querySelectorAll('.employee-allowance:checked').forEach(checkbox => {
                if (!checkbox.disabled) {
                    const amountInput = checkbox.closest('.flex.items-center.justify-between').querySelector('.allowance-amount');
                    if (amountInput) {
                        totalAllowances += parseFloat(amountInput.value) || 0;
                    }
                }
            });

            let totalDeductions = 0;
            document.querySelectorAll('.employee-deduction:checked').forEach(checkbox => {
                if (!checkbox.disabled) {
                    const amountInput = checkbox.closest('.flex.items-center.justify-between').querySelector('.deduction-amount');
                    if (amountInput) {
                        totalDeductions += parseFloat(amountInput.value) || 0;
                    }
                }
            });

            const netSalary = basicSalary + totalAllowances - totalDeductions;

            document.getElementById('summaryBasic').textContent = `$${basicSalary.toFixed(2)}`;
            document.getElementById('summaryAllowances').textContent = `+ $${totalAllowances.toFixed(2)}`;
            document.getElementById('summaryDeductions').textContent = `- $${totalDeductions.toFixed(2)}`;
            document.getElementById('summaryNet').textContent = `$${netSalary.toFixed(2)}`;
        }

        // Form handlers
        function handleRunPayroll(e) {
            e.preventDefault();
            showToast('Payroll run initiated successfully!', 'success');
            closeModal('runPayrollModal');
        }

        function handleEditEmployeePayroll(e) {
            e.preventDefault();
            showToast('Employee payroll updated successfully!', 'success');
            closeModal('editEmployeePayrollModal');
            loadEmployeePayroll();
        }

        function handleAddJobGrade(e) {
            e.preventDefault();
            showToast('Job grade added successfully!', 'success');
            closeModal('addJobGradeModal');
            loadJobGrades();
        }

        function handleAddJobStep(e) {
            e.preventDefault();
            showToast('Job step added successfully!', 'success');
            closeModal('addJobStepModal');
            loadJobGrades();
        }

        // Utility functions
        function editPaygroup(id) {
            const paygroup = paygroups.find(p => p.id === id);
            if (paygroup) {
                openModal('createPaygroupModal');
            }
        }

        function deletePaygroup(id) {
            if (confirm('Are you sure you want to delete this paygroup? This will affect all employees assigned to it.')) {
                const index = paygroups.findIndex(p => p.id === id);
                if (index !== -1) {
                    paygroups.splice(index, 1);
                    showToast('Paygroup deleted successfully!', 'success');
                    loadPaygroups();
                    updateStats();
                    document.getElementById('paygroupDetails').innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <span class="material-icons-round text-4xl mb-4">group_work</span>
                            <p>Select a paygroup to view its configuration</p>
                        </div>
                    `;
                }
            }
        }

        function filterEmployeePayroll() {
            const department = document.getElementById('employeeFilter').value.toLowerCase();
            const paygroup = document.getElementById('paygroupFilter').value.toLowerCase();
            const grade = document.getElementById('gradeFilter').value;

            document.querySelectorAll('#employeePayrollTable tr').forEach(row => {
                const departmentCell = row.children[0]?.textContent.toLowerCase();
                const paygroupCell = row.children[1]?.textContent.toLowerCase();
                const gradeCell = row.children[1]?.textContent;

                let show = true;

                if (department && !departmentCell.includes(department)) {
                    show = false;
                }

                if (paygroup && !paygroupCell.includes(paygroup)) {
                    show = false;
                }

                if (grade && gradeCell && !gradeCell.includes(`G${grade}`)) {
                    show = false;
                }

                row.style.display = show ? '' : 'none';
            });
        }

        function exportJobStructure() {
            const data = {
                jobGrades: jobGrades,
                jobSteps: jobSteps,
                allowances: allowances.filter(a => a.status === 'ACTIVE'),
                deductions: deductions.filter(d => d.status === 'ACTIVE'),
                paygroups: paygroups,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `payroll-structure-${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showToast('Job structure exported successfully!', 'success');
        }

        function approvePayroll() {
            if (confirm('Are you sure you want to approve the payroll? This action cannot be undone.')) {
                const currentStep = document.querySelector('.step-current');
                const nextStep = currentStep.nextElementSibling?.querySelector('.step-icon');

                if (currentStep) {
                    currentStep.querySelector('.step-icon').classList.remove('step-current');
                    currentStep.querySelector('.step-icon').classList.add('step-completed');
                    currentStep.querySelector('.step-icon').innerHTML = '<span class="material-icons-round text-sm">check</span>';

                    if (nextStep) {
                        nextStep.classList.remove('step-pending');
                        nextStep.classList.add('step-current');
                        nextStep.innerHTML = '<span class="material-icons-round text-sm">edit</span>';
                    }

                    showToast('Payroll approved successfully!', 'success');
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);

            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Tab functionality
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-primary-600', 'text-primary-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            document.getElementById(tabName).classList.remove('hidden');
            document.getElementById(tabName + 'Tab').classList.add('border-primary-600', 'text-primary-600');
            document.getElementById(tabName + 'Tab').classList.remove('border-transparent', 'text-gray-500');
        }

        document.addEventListener('DOMContentLoaded', () => {
            showTab('payrollItems');
        });

        // Mobile Sidebar Toggle (if elements exist)
        const menuToggle = document.getElementById('menuToggle');
        const mobileOverlay = document.getElementById('mobileOverlay');
        const sidebar = document.querySelector('.sidebar-container');

        if (menuToggle && mobileOverlay && sidebar) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                mobileOverlay.classList.toggle('hidden');
                document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : 'auto';
            });

            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                mobileOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
        }

        // Theme Toggle
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            if (!themeToggle) return;
            const themeIcon = themeToggle.querySelector('.material-icons-round');

            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });

            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                if (themeIcon) themeIcon.textContent = 'light_mode';
            }
        }

        window.addEventListener('resize', () => {
            if (sidebar && window.innerWidth >= 1024) {
                sidebar.classList.remove('open');
                if (mobileOverlay) mobileOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        });

        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.addEventListener('click', function() {
                this.parentElement.classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
        });
    </script>
</main>
</body>
</html>