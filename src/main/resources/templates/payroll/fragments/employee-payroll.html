<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* === PROFESSIONAL CLEAN DESIGN === */
    * { box-sizing: border-box; }

    .breadcrumb-link {
      display: inline-flex; align-items: center; gap: 5px;
      color: #4b5565; font-size: 0.8125rem; font-weight: 500;
      transition: color 0.1s ease;
    }
    .breadcrumb-link:hover { color: #1e3a8a; }

    .period-label {
      font-size: 0.75rem; font-weight: 600; letter-spacing: 0.03em;
      text-transform: uppercase; color: #4b5565;
      border-bottom: 1px solid #e2e4e8;
      padding-bottom: 0.5rem;
      margin-bottom: 1.25rem;
    }

    .current-period-card {
      background: #ffffff;
      border: 1px solid #e6e9ef;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }

    .current-period-header {
      background: #f5f7fb;
      padding: 1.5rem 2rem;
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;
      border-bottom: 1px solid #e6e9ef;
    }

    .period-meta-pill {
      background: transparent;
      border: 1px solid #cbd0d9;
      border-radius: 30px;
      padding: 4px 14px;
      font-size: 0.78rem; font-weight: 500; color: #2e3a4f;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .live-dot {
      width: 7px; height: 7px; border-radius: 50%; background: #6f8f9f;
    }

    .header-stat {
      background: #ffffff;
      border: 1px solid #dde1e7;
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      color: #1f2a3e;
    }
    .header-stat .stat-val { font-size: 1.15rem; font-weight: 600; line-height: 1.2; }
    .header-stat .stat-lbl { font-size: 0.7rem; color: #6b788b; font-weight: 500; text-transform: uppercase; letter-spacing: 0.02em; }

    .filter-bar {
      padding: 1rem 2rem;
      background: #fafbfd;
      border-bottom: 1px solid #e6e9ef;
      display: flex; align-items: center; flex-wrap: wrap; gap: 0.75rem;
    }
    .filter-select {
      background: #ffffff;
      border: 1px solid #d6dce5;
      border-radius: 6px;
      padding: 0.45rem 2rem 0.45rem 0.85rem;
      font-size: 0.8125rem;
      color: #1f2a3e;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      cursor: pointer;
      transition: border-color 0.15s;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23758299' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
    }
    .filter-select:focus { outline: none; border-color: #5f7daf; }

    .payroll-table { width: 100%; border-collapse: collapse; }
    .payroll-table thead tr {
      background: #f5f7fb;
      border-top: 1px solid #e6e9ef;
      border-bottom: 1px solid #e6e9ef;
    }
    .payroll-table th {
      padding: 0.75rem 1.5rem;
      text-align: left;
      font-size: 0.68rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #5f6c80;
      white-space: nowrap;
    }
    .payroll-table tbody tr {
      border-bottom: 1px solid #edeff2;
      transition: background 0.1s;
    }
    .payroll-table tbody tr:hover { background: #f9fafc; }
    .payroll-table td {
      padding: 1rem 1.5rem;
      font-size: 0.875rem;
      color: #1f2a3e;
      white-space: nowrap;
    }
    .payroll-table td.mono { font-family: ui-monospace, 'Cascadia Code', Consolas, monospace; font-size: 0.8125rem; }

    .emp-avatar {
      width: 34px; height: 34px; border-radius: 50%;
      background: #d9dee8;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8rem; font-weight: 600; color: #2e3a4f;
      flex-shrink: 0;
    }

    .status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 4px 10px; border-radius: 30px;
      font-size: 0.72rem; font-weight: 500;
      border: 1px solid transparent;
    }
    .status-badge .dot { width: 6px; height: 6px; border-radius: 50%; }

    .status-processed { background: #e7f3e9; color: #1e6641; border-color: #c6e0cc; }
    .status-processed .dot { background: #2d7a4b; }

    .status-pending { background: #fff1dd; color: #a76100; border-color: #fadcb3; }
    .status-pending .dot { background: #b96f0e; }

    .status-failed { background: #fae9eb; color: #b13e3e; border-color: #f3cfd3; }
    .status-failed .dot { background: #b64343; }

    .status-draft { background: #f0f2f5; color: #55657b; border-color: #d5dce5; }
    .status-draft .dot { background: #73869c; }

    .amount-positive { color: #1f2a3e; font-weight: 600; }
    .amount-deduct { color: #b64343; font-weight: 500; }

    .dl-btn {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 5px 12px; border-radius: 6px;
      font-size: 0.78rem; font-weight: 500;
      color: #2f4b7c;
      border: 1px solid #cdd9e9;
      background: #ffffff;
      cursor: pointer;
      transition: background 0.1s, border-color 0.1s;
      white-space: nowrap;
    }
    .dl-btn:hover { background: #f0f4fc; border-color: #96b2d4; }

    .past-period-card {
      background: #ffffff;
      border: 1px solid #e6e9ef;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 0.875rem;
    }
    .past-period-header-btn {
      width: 100%; padding: 1rem 1.5rem;
      display: flex; align-items: center; justify-content: space-between;
      background: none; border: none; cursor: pointer;
      transition: background 0.1s;
      text-align: left;
    }
    .past-period-header-btn:hover { background: #f9fafc; }
    .past-period-body { display: none; }
    .past-period-body.open { display: block; }
    .chevron { transition: transform 0.2s; color: #95a3b3; }
    .chevron.open { transform: rotate(180deg); }

    .date-range-tag {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: 0.78rem; color: #55657b; font-family: ui-monospace, Consolas, monospace;
    }
    .date-sep { color: #b1bfcf; }

    .totals-row { background: #f5f7fb !important; }
    .totals-row td { font-weight: 600; color: #1f2a3e; border-top: 1px solid #d2d9e3; }

    .custom-scrollbar::-webkit-scrollbar { height: 5px; width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f0f2f5; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #b6c1cf; border-radius: 3px; }

    .empty-state { padding: 3rem; text-align: center; color: #95a3b3; }
    .empty-state i { font-size: 2.5rem; margin-bottom: 0.75rem; display: block; }

    @media (max-width: 768px) {
      .current-period-header { padding: 1.25rem; }
      .filter-bar { padding: 0.75rem 1rem; }
      .payroll-table th, .payroll-table td { padding: 0.75rem 1rem; }
    }
  </style>
</head>
<body>
<main layout:fragment="content">

  <!-- Breadcrumb -->
  <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center gap-2 text-sm text-slate-500">
      <a th:href="@{/payroll}" class="hover:text-primary transition-colors flex items-center gap-1">
        <span class="material-icons-round">arrow_back</span>
        Back to Dashboard
      </a>
      <span class="mx-2">/</span>
      <span class="font-medium text-slate-900">Employee Payroll</span>
    </div>
  </div>

  <!-- ===== CURRENT PERIOD ===== -->
  <div class="period-label">Current Payroll Period</div>

  <div class="current-period-card mb-8">
    <div class="current-period-header">
      <div>
        <div class="flex items-center gap-3 mb-1">
          <h2 class="text-slate-800 font-bold text-xl">June 2025 Payroll</h2>
          <span class="period-meta-pill"><span class="live-dot"></span> Active</span>
        </div>
        <div class="date-range-tag mt-1" style="color:#55657b;">
          <i class="bi bi-calendar3"></i>
          <span>01 Jun 2025</span>
          <span class="date-sep">→</span>
          <span>30 Jun 2025</span>
        </div>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <div class="header-stat">
          <div th:text="${#lists.size(paySlips)}" class="stat-val">1</div>
          <div class="stat-lbl">Employees</div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
      <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide mr-1">Filter:</span>
      <select class="filter-select" id="employeeFilter" onchange="filterEmployeePayroll()">
        <option value="">All Departments</option>
        <option value="engineering">Engineering</option>
        <option value="sales">Sales</option>
        <option value="marketing">Marketing</option>
      </select>
      <select class="filter-select" id="paygroupFilter" onchange="filterEmployeePayroll()">
        <option value="">All Paygroups</option>
        <option value="executive">Executive Level</option>
        <option value="mid">Mid Level</option>
        <option value="junior">Junior Level</option>
      </select>
      <select class="filter-select" id="gradeFilter" onchange="filterEmployeePayroll()">
        <option value="">All Grades</option>
        <option value="1">Grade 1</option>
        <option value="2">Grade 2</option>
        <option value="3">Grade 3</option>
        <option value="4">Grade 4</option>
        <option value="5">Grade 5</option>
        <option value="6">Grade 6</option>
        <option value="7">Grade 7</option>
      </select>
      <select class="filter-select" id="statusFilter" onchange="filterEmployeePayroll()">
        <option value="">All Statuses</option>
        <option value="processed">Processed</option>
        <option value="pending">Pending</option>
        <option value="draft">Draft</option>
        <option value="failed">Failed</option>
      </select>
    </div>

    <div class="overflow-x-auto custom-scrollbar">
      <table class="payroll-table">
        <thead>
        <tr>
          <th>Employee</th>
          <th>Pay Day</th>
          <th>Basic Salary</th>
          <th>Deductions</th>
          <th>Net Salary</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
        </thead>

        <tbody th:if="${not #lists.isEmpty(paySlips)}" id="currentPayrollBody">
        <tr th:each="paySlip : ${paySlips}">
          <td>
            <div class="flex items-center gap-3">
              <div class="emp-avatar"
                   th:text="${#strings.length(paySlip.employeeName) > 0 ? #strings.substring(paySlip.employeeName, 0, 2).toUpperCase() : 'NA'}">AA</div>
              <div>
                <div th:text="${paySlip.employeeName}" class="font-semibold text-slate-800 text-sm">Akinrinde Akinkunmi</div>
              </div>
            </div>
          </td>
          <td th:text="${paySlip.payDate}" class="mono">2025-06-30</td>
          <td th:text="${paySlip.grossPay}" class="mono amount-positive">₦5,000</td>
          <td>
            <span th:text="${paySlip.totalDeductions}" class="text-sm font-medium text-slate-600">5</span>
            <span class="text-xs text-slate-400">(items)</span>
          </td>
          <td th:text="${paySlip.netPay}" class="mono amount-positive">₦4,750</td>
          <td>
            <span th:class="'status-badge status-' + ${paySlip.status?.toLowerCase()}">
              <span class="dot"></span>
              <span th:text="${paySlip.status}">Pending</span>
            </span>
          </td>
          <td>
            <button class="dl-btn" th:onclick="'downloadPayslip(this)'">
              <i class="bi bi-download"></i> Payslip
            </button>
          </td>
        </tr>
        </tbody>

        <tbody th:if="${#lists.isEmpty(paySlips)}">
        <tr>
          <td colspan="7" class="empty-state">
            <i class="bi bi-inbox"></i>
            <span>No payroll records found for this period.</span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== PAST PERIODS ===== -->
  <div class="period-label" style="margin-top:2.5rem;">Past Payroll Periods</div>

  <!--
    Model: previousPeriods — List of period objects, each containing:
      - period.periodName       : e.g. "May 2025 Payroll"
      - period.periodStart      : e.g. "2025-05-01"
      - period.periodEnd        : e.g. "2025-05-31"
      - period.totalNetPay      : e.g. "₦4,750"
      - period.totalGrossPay    : e.g. "₦5,000"
      - period.status           : e.g. "Processed" / "Failed" / "Pending" / "Draft"
      - period.paySlips         : List of payslip objects (same structure as current paySlips)
  -->

  <!-- Empty state: no past periods at all -->
  <div th:if="${#lists.isEmpty(previousPeriods)}" class="past-period-card">
    <div class="empty-state">
      <i class="bi bi-clock-history"></i>
      <span>No past payroll periods found.</span>
    </div>
  </div>

  <!-- Dynamic past period accordion cards -->
  <div th:each="period, iterStat : ${previousPeriods}"
       th:if="${not #lists.isEmpty(previousPeriods)}"
       class="past-period-card">

    <!-- Accordion header button -->
    <button class="past-period-header-btn" onclick="togglePeriod(this)">

      <!-- Left: period name + date range -->
      <div class="flex items-center gap-4">
        <div class="text-left">
          <p th:text="${period.periodName}" class="font-bold text-slate-800 text-sm">May 2025 Payroll</p>
          <div class="date-range-tag mt-0.5">
            <i class="bi bi-calendar3"></i>
            <span th:text="${period.periodStart}">01 May 2025</span>
            <span class="date-sep">→</span>
            <span th:text="${period.periodEnd}">31 May 2025</span>
          </div>
        </div>
      </div>

      <!-- Right: net total + status badge + chevron -->
      <div class="flex items-center gap-4">
        <div class="text-right hidden sm:block">
          <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Net Payroll</p>
          <p th:text="${period.totalNetPay}" class="font-bold text-slate-800 font-mono text-sm">₦0</p>
        </div>
        <span th:class="'status-badge status-' + ${period.status?.toLowerCase()}">
          <span class="dot"></span>
          <span th:text="${period.status}">Processed</span>
        </span>
        <i class="bi bi-chevron-down chevron text-lg"></i>
      </div>
    </button>

    <!-- Accordion body: payslips table -->
    <div class="past-period-body">
      <div class="overflow-x-auto custom-scrollbar">
        <table class="payroll-table">
          <thead>
          <tr>
            <th>Employee</th>
            <th>Period Start</th>
            <th>Period End</th>
            <th>Pay Day</th>
            <th>Basic Salary</th>
            <th>Deductions</th>
            <th>Net Salary</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
          </thead>

          <!-- Rows when payslips exist -->
          <tbody th:if="${not #lists.isEmpty(period.paySlips)}">
          <tr th:each="paySlip : ${period.paySlips}">
            <td>
              <div class="flex items-center gap-3">
                <div class="emp-avatar"
                     th:text="${#strings.length(paySlip.employeeName) > 0 ? #strings.substring(paySlip.employeeName, 0, 2).toUpperCase() : 'NA'}">AA</div>
                <div>
                  <div th:text="${paySlip.employeeName}" class="font-semibold text-slate-800 text-sm">Employee Name</div>
                  <div th:text="${paySlip.department + ' · ' + paySlip.grade}" class="text-xs text-slate-500">Engineering · Grade 3</div>
                </div>
              </div>
            </td>
            <td th:text="${period.periodStart}" class="mono">2025-05-01</td>
            <td th:text="${period.periodEnd}" class="mono">2025-05-31</td>
            <td th:text="${paySlip.payDate}" class="mono">2025-05-30</td>
            <td th:text="${paySlip.grossPay}" class="mono amount-positive">₦5,000</td>
            <td>
              <span th:text="${paySlip.totalDeductions}" class="text-sm text-slate-600">5</span>
              <span class="text-xs text-slate-400">(items)</span>
            </td>
            <td th:text="${paySlip.netPay}" class="mono amount-positive">₦4,750</td>
            <td>
              <span th:class="'status-badge status-' + ${paySlip.status?.toLowerCase()}">
                <span class="dot"></span>
                <span th:text="${paySlip.status}">Processed</span>
              </span>
            </td>
            <td>
              <button class="dl-btn" onclick="downloadPayslip(this)">
                <i class="bi bi-download"></i> Payslip
              </button>
            </td>
          </tr>
          </tbody>

          <!-- Empty state when a period has no payslips -->
          <tbody th:if="${#lists.isEmpty(period.paySlips)}">
          <tr>
            <td colspan="9" class="empty-state" style="padding:1.5rem;">
              <i class="bi bi-inbox"></i>
              <span>No payslip records for this period.</span>
            </td>
          </tr>
          </tbody>

          <!-- Totals footer row -->
          <tfoot th:if="${not #lists.isEmpty(period.paySlips)}">
          <tr class="totals-row">
            <td colspan="4" class="text-xs uppercase tracking-widest text-slate-500">Period Totals</td>
            <td th:text="${period.totalGrossPay}" class="mono">₦5,000</td>
            <td>—</td>
            <td th:text="${period.totalNetPay}" class="mono">₦4,750</td>
            <td></td>
            <td></td>
          </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
  <!-- /th:each previousPeriods -->

  <!-- Payslip PDF template (hidden) -->
  <div id="payslip-template" style="display:none;">
    <div id="payslip-content" style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#fff; padding:2.5rem; max-width:680px; margin:0 auto; border:1px solid #e2e8f0; border-radius:12px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; border-bottom:2px solid #e2e8f0; padding-bottom:1.25rem; margin-bottom:1.5rem;">
        <div>
          <div style="font-size:1.5rem; font-weight:800; color:#1e3a5f; letter-spacing:-0.03em;">PAYSLIP</div>
          <div style="font-size:0.8rem; color:#94a3b8; margin-top:4px;">Generated on <span id="payslip-generated-date"></span></div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:700; color:#1e293b;">Your Company Name</div>
          <div style="font-size:0.8rem; color:#94a3b8;">123 Business St., City</div>
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; margin-bottom:1.5rem;">
        <div>
          <div style="font-size:0.65rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:#94a3b8; margin-bottom:4px;">Employee</div>
          <div style="font-weight:600; color:#1e293b;" id="payslip-employee-name"></div>
        </div>
        <div>
          <div style="font-size:0.65rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:#94a3b8; margin-bottom:4px;">Pay Period</div>
          <div style="font-weight:600; color:#1e293b;" id="payslip-pay-date"></div>
        </div>
        <div>
          <div style="font-size:0.65rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:#94a3b8; margin-bottom:4px;">Pay Day</div>
          <div style="font-weight:600; color:#1e293b;" id="payslip-pay-day"></div>
        </div>
      </div>
      <table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
        <thead>
        <tr style="background:#f8fafc; border-top:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0;">
          <th style="padding:0.6rem 1rem; text-align:left; font-size:0.7rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:#94a3b8;">Description</th>
          <th style="padding:0.6rem 1rem; text-align:right; font-size:0.7rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:#94a3b8;">Amount</th>
        </tr>
        </thead>
        <tbody>
        <tr style="border-bottom:1px solid #f1f5f9;">
          <td style="padding:0.85rem 1rem; color:#334155;">Basic Salary</td>
          <td style="padding:0.85rem 1rem; text-align:right; font-weight:700; font-family:ui-monospace,Consolas,monospace; color:#1e293b;" id="payslip-basic-salary"></td>
        </tr>
        </tbody>
      </table>
      <div style="display:flex; justify-content:flex-end; border-top:2px solid #e2e8f0; padding-top:1rem;">
        <div style="min-width:220px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:600; color:#64748b;">Net Pay</span>
            <span style="font-size:1.35rem; font-weight:800; color:#1e3a5f; font-family:ui-monospace,Consolas,monospace;" id="payslip-net-pay"></span>
          </div>
          <div style="font-size:0.72rem; color:#94a3b8; text-align:right; margin-top:4px;">After all deductions</div>
        </div>
      </div>
      <div style="margin-top:2rem; text-align:center; font-size:0.72rem; color:#cbd5e1; border-top:1px solid #f1f5f9; padding-top:1rem;">
        This is a computer-generated payslip. No signature required.
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    function togglePeriod(btn) {
      const body = btn.nextElementSibling;
      const chevron = btn.querySelector('.chevron');
      body.classList.toggle('open');
      chevron.classList.toggle('open');
    }

    function downloadPayslip(button) {
      const row = button.closest('tr');
      if (!row) return;
      const cells = row.cells;

      // Current period table: Employee(0), PayDay(1), BasicSalary(2), Deductions(3), NetSalary(4)
      // Past period table:    Employee(0), PeriodStart(1), PeriodEnd(2), PayDay(3), BasicSalary(4), Deductions(5), NetSalary(6)
      const isPastPeriod = cells.length >= 9;

      const employeeName = cells[0]?.querySelector('.font-semibold')?.textContent.trim() || 'N/A';
      const periodStart  = isPastPeriod ? cells[1]?.textContent.trim() : 'N/A';
      const periodEnd    = isPastPeriod ? cells[2]?.textContent.trim() : 'N/A';
      const payDay       = isPastPeriod ? cells[3]?.textContent.trim() : cells[1]?.textContent.trim();
      const basicSalary  = isPastPeriod ? cells[4]?.textContent.trim() : cells[2]?.textContent.trim();
      const netPay       = isPastPeriod ? cells[6]?.textContent.trim() : cells[4]?.textContent.trim();

      document.getElementById('payslip-employee-name').textContent = employeeName;
      document.getElementById('payslip-pay-date').textContent = isPastPeriod ? `${periodStart} → ${periodEnd}` : payDay;
      document.getElementById('payslip-pay-day').textContent = payDay;
      document.getElementById('payslip-basic-salary').textContent = basicSalary;
      document.getElementById('payslip-net-pay').textContent = netPay;
      document.getElementById('payslip-generated-date').textContent = new Date().toISOString().split('T')[0];

      const element = document.getElementById('payslip-content');
      html2pdf()
        .set({
          margin: [0.5, 0.5, 0.5, 0.5],
          filename: `payslip-${employeeName.replace(/\s+/g, '_')}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        })
        .from(element)
        .save();
    }

    function filterEmployeePayroll() {
      console.log('filter changed');
    }
  </script>
</main>
</body>
</html>