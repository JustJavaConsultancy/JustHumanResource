<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                    secondary: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                },
                fontFamily: { 'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'] },
                borderRadius: { 'xl': '1rem', '2xl': '1.5rem' }
            }
        }
    };
  </script>
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { overflow-x: hidden; }
    .badge { padding: 2px 8px; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; }
    .badge-success { background-color: #dcfce7; color: #16a34a; }
    .badge-info { background-color: #dbeafe; color: #2563eb; }
    .badge-purple { background-color: #f3e8ff; color: #9333ea; }
    .form-input { border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem; width: 100%; transition: border-color 0.2s; }
    .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
    .payroll-card { transition: all 0.2s ease; border: 1px solid #e5e7eb; }
    .payroll-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
    .dark .payroll-card { border-color: #374151; }
    .dark .payroll-card:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); }
    .action-btn { padding: 0.5rem; border-radius: 0.5rem; transition: all 0.15s ease; color: #64748b; }
    .action-btn:hover { background-color: #f1f5f9; color: #1e293b; }
    .dark .action-btn { color: #94a3b8; }
    .dark .action-btn:hover { background-color: #334155; color: #f1f5f9; }
  </style>
</head>
<body>
<main layout:fragment="content">
  <div class="mb-4 flex items-center gap-2 text-sm text-slate-500">
    <a th:href="@{/payroll}" class="hover:text-primary transition-colors flex items-center gap-1">
      <span class="material-icons-round">arrow_back</span>
      Back to Dashboard
    </a>
    <span class="mx-2">/</span>
    <span class="font-medium text-slate-900 dark:text-white">Paygroups</span>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
    <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">Paygroups</h3>
        <button onclick="openModal('createPaygroupModal')" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">
          Create Paygroup
        </button>
      </div>
    </div>

    <div class="p-4 md:p-6">
      <div class="space-y-4" id="paygroupsList">
        <!-- Show list when payGroups is not empty -->
        <th:block th:if="${not #lists.isEmpty(payGroups)}">
          <div th:each="pg : ${payGroups}"
               class="payroll-card p-4 rounded-lg"
               th:attr="data-paygroup-id=${pg.payGroup.id}, data-paygroup-name=${pg.payGroup.name}">

            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="font-bold" th:text="${pg.payGroup.name}">Paygroup Name</h4>
                <div class="flex items-center mt-1">
                  <span class="badge badge-purple" th:text="${pg.payGroup.payFrequency}">Monthly</span>
                </div>
              </div>
              <span class="badge badge-info" th:text="${#lists.size(pg.employees)} + ' Employees'">0 Employees</span>
            </div>

            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Allowances</span>
                <span class="text-green-600" th:text="${#lists.size(pg.allowances)} + ' items'">0 items</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Deductions</span>
                <span class="text-red-600" th:text="${#lists.size(pg.deductions)} + ' items'">0 items</span>
              </div>
            </div>

            <div class="flex items-center space-x-2 mt-3 pt-2 border-t border-gray-100 dark:border-gray-700">
              <button th:attr="onclick='openAllowancesModal(' + ${pg.payGroup.id} + ')'"
                      class="action-btn flex items-center text-green-600 dark:text-green-400"
                      title="Manage Allowances">
                <span class="material-icons-round text-sm mr-1">add_circle</span>
                <span class="text-xs">Allowances</span>
              </button>

              <button th:attr="onclick='openDeductionsModal(' + ${pg.payGroup.id} + ')'"
                      class="action-btn flex items-center text-red-600 dark:text-red-400"
                      title="Manage Deductions">
                <span class="material-icons-round text-sm mr-1">remove_circle</span>
                <span class="text-xs">Deductions</span>
              </button>

              <button th:attr="onclick='editPaygroup(' + ${pg.payGroup.id} + ')'"
                      class="action-btn flex items-center"
                      title="Edit Paygroup">
                <span class="material-icons-round text-sm mr-1">edit</span>
                <span class="text-xs">Edit</span>
              </button>

              <button th:attr="onclick='deletePaygroup(' + ${pg.payGroup.id} + ')'"
                      class="action-btn flex items-center text-red-600 dark:text-red-400"
                      title="Delete Paygroup">
                <span class="material-icons-round text-sm mr-1">delete</span>
                <span class="text-xs">Delete</span>
              </button>
            </div>
          </div>
        </th:block>

        <!-- Empty state when payGroups is empty -->
        <th:block th:if="${#lists.isEmpty(payGroups)}">
          <div class="empty-state p-4 text-center text-gray-500">
            No pay groups found. Click "Add Pay Group" to create one.
          </div>
        </th:block>
      </div>
    </div>
  </div>

  <!-- Create Paygroup Modal -->
  <div id="createPaygroupModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop fixed inset-0"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 custom-scrollbar">
      <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold">Create New Paygroup</h3>
            <button onclick="closeModal('createPaygroupModal')" class="text-gray-400 hover:text-gray-600">
              <span class="material-icons-round">close</span>
            </button>
          </div>
        </div>

        <div class="p-6">
          <form th:action="@{/createPayGroup}" method="post" id="createPaygroupForm" class="space-y-6" onsubmit="disableSubmitButton(this)">
            <div>
              <label class="block text-sm font-medium mb-2">Paygroup Name *</label>
              <input name="name" type="text" class="form-input" placeholder="Enter paygroup name" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Pay Frequency *</label>
              <select name="payFrequency" class="form-input" required>
                <option value="">Select frequency</option>
                <option value="BI_WEEKLY">BI_Weekly</option>
                <option value="WEEKLY">Weekly</option>
                <option value="MONTHLY">Monthly</option>
              </select>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" onclick="closeModal('createPaygroupModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Create Paygroup</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Allowances Modal -->
  <div id="manageAllowancesModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop fixed inset-0"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 custom-scrollbar">
      <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold" id="allowancesModalTitle">Manage Allowances</h3>
            <button onclick="closeModal('manageAllowancesModal')" class="text-gray-400 hover:text-gray-600">
              <span class="material-icons-round">close</span>
            </button>
          </div>
        </div>

        <div class="p-6">
          <form th:action="@{/setup/paygroup/allowances}" method="post" id="manageAllowancesForm" class="space-y-6" onsubmit="disableSubmitButton(this)">
            <input type="hidden" name="payGroupId" id="manageAllowancesPaygroupId" value="">

            <div>
              <label class="block text-sm font-medium mb-3">Select allowances to include</label>
              <div class="space-y-2 max-h-96 overflow-y-auto p-2 border border-gray-200 dark:border-gray-700 rounded-lg" id="allowanceCheckboxList">
                <th:block th:if="${allowances != null and !allowances.empty}">
                  <label th:each="allowance : ${allowances}" class="flex items-center space-x-2 p-1 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                    <input name="allowancesSending"
                           type="checkbox"
                           th:value="${allowance.id + ' ' + allowance.amount}"
                           class="rounded allowance-check">

                    <span th:text="${allowance.name}">Housing Allowance</span>
                    <span th:if="${allowance.taxable}"> (Taxable)</span>
                    <span th:if="${!allowance.taxable}"> (Non-Taxable)</span>
                    - <span th:text="${'₦' + allowance.amount}">₦1200.00</span>
                  </label>
                </th:block>
                <div th:unless="${allowances != null and !allowances.empty}" class="flex flex-col items-center justify-center py-8 text-center">
                  <span class="material-icons-round text-4xl text-gray-300 mb-2">inbox</span>
                  <p class="text-gray-500 dark:text-gray-400">No allowances available</p>
                  <p class="text-sm text-gray-400 dark:text-gray-500">Add allowances to manage them here.</p>
                </div>
              </div>
            </div>

            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" onclick="closeModal('manageAllowancesModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Save Allowances</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Deductions Modal -->
  <div id="manageDeductionsModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop fixed inset-0"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 custom-scrollbar">
      <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold" id="deductionsModalTitle">Manage Deductions</h3>
            <button onclick="closeModal('manageDeductionsModal')" class="text-gray-400 hover:text-gray-600">
              <span class="material-icons-round">close</span>
            </button>
          </div>
        </div>

        <div class="p-6">
          <form th:action="@{/setup/paygroup/deductions}" method="post" id="manageDeductionsForm" class="space-y-6" onsubmit="disableSubmitButton(this)">
            <input name="payGroupId" type="hidden" id="manageDeductionsPaygroupId" value="">

            <div>
              <label class="block text-sm font-medium mb-3">Select deductions to include</label>
              <div class="space-y-2 max-h-96 overflow-y-auto p-2 border border-gray-200 dark:border-gray-700 rounded-lg" id="deductionCheckboxList">
                <th:block th:if="${deductions != null and !deductions.empty}">
                  <label th:each="deduction : ${deductions}" class="flex items-center space-x-2 p-1 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                    <input type="checkbox" th:value="${deduction.id}" class="rounded deduction-check">
                    <span th:text="${deduction.name}">Housing Allowance</span>
                    <span th:if="${deduction.statutory}"> (Statutory)</span>
                    <span th:if="${!deduction.statutory}"> (Non-Statutory)</span>
                    - <span th:text="${'₦' + deduction.amount}">₦1200.00</span>
                  </label>
                </th:block>
                <div th:unless="${deductions != null and !deductions.empty}" class="flex flex-col items-center justify-center py-8 text-center">
                  <span class="material-icons-round text-4xl text-gray-300 mb-2">receipt</span>
                  <p class="text-gray-500 dark:text-gray-400">No deductions available</p>
                  <p class="text-sm text-gray-400 dark:text-gray-500">Add deductions to manage them here.</p>
                </div>
              </div>
            </div>

            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" onclick="closeModal('manageDeductionsModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Save Deductions</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    function disableSubmitButton(form) {
      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        submitButton.innerHTML = 'Submitting...';
      }
      return true;
    }

    // Open Allowances modal
    function openAllowancesModal(paygroupId) {
      const card = document.querySelector(`.payroll-card[data-paygroup-id="${paygroupId}"]`);
      if (!card) return;

      const paygroupName = card.getAttribute('data-paygroup-name');
      document.getElementById('allowancesModalTitle').innerText = `Allowances for ${paygroupName}`;
      document.getElementById('manageAllowancesPaygroupId').value = paygroupId;

      openModal('manageAllowancesModal');
    }

    // Save allowances
    function saveAllowances(e) {
      e.preventDefault();
      const paygroupId = document.getElementById('manageAllowancesPaygroupId').value;
      const card = document.querySelector(`.payroll-card[data-paygroup-id="${paygroupId}"]`);

      if (card) {
        const paygroupName = card.getAttribute('data-paygroup-name');
        closeModal('manageAllowancesModal');
        showToast(`Allowances updated for ${paygroupName}`, 'success');
      }
    }

    // Open Deductions modal
    function openDeductionsModal(paygroupId) {
      const card = document.querySelector(`.payroll-card[data-paygroup-id="${paygroupId}"]`);
      if (!card) return;

      const paygroupName = card.getAttribute('data-paygroup-name');
      document.getElementById('deductionsModalTitle').innerText = `Deductions for ${paygroupName}`;
      document.getElementById('manageDeductionsPaygroupId').value = paygroupId;

      openModal('manageDeductionsModal');
    }

    // Save deductions
    function saveDeductions(e) {
      e.preventDefault();
      const paygroupId = document.getElementById('manageDeductionsPaygroupId').value;
      const card = document.querySelector(`.payroll-card[data-paygroup-id="${paygroupId}"]`);

      if (card) {
        const paygroupName = card.getAttribute('data-paygroup-name');
        closeModal('manageDeductionsModal');
        showToast(`Deductions updated for ${paygroupName}`, 'success');
      }
    }

    function editPaygroup(id) {
      alert('Edit functionality would open pre-filled modal.');
    }

    function deletePaygroup(id) {
      if (confirm('Are you sure you want to delete this paygroup? This will affect all employees assigned to it.')) {
        const card = document.querySelector(`.payroll-card[data-paygroup-id="${id}"]`);
        if (card) {
          card.remove();
          showToast('Paygroup deleted successfully!', 'success');
        }
      }
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
      }`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.remove('translate-x-full'), 100);
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // DOM ready
    document.addEventListener('DOMContentLoaded', function() {
      // Form submissions

      // Close modals on backdrop click
      document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', function() {
          this.parentElement.classList.add('hidden');
          document.body.style.overflow = 'auto';
        });
      });
    });
  </script>
</main>
</body>
</html>