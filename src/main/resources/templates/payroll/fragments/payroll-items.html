<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        secondary: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: { 'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'] },
                    borderRadius: { 'xl': '1rem', '2xl': '1.5rem' }
                }
            }
        };
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { overflow-x: hidden; }
        .sidebar-item { transition: all 0.2s ease; position: relative; }
        .sidebar-item.active { background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; border-left: 3px solid #3b82f6; }
        .sidebar-item.active .material-icons-round { color: #3b82f6; }
        .sidebar-item:hover:not(.active) { background-color: rgba(59, 130, 246, 0.05); }
        .dark .sidebar-item.active { background-color: rgba(59, 130, 246, 0.2); }
        .badge { padding: 2px 8px; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; }
        .badge-success { background-color: #dcfce7; color: #16a34a; }
        .badge-warning { background-color: #fef3c7; color: #d97706; }
        .badge-error { background-color: #fee2e2; color: #dc2626; }
        .badge-info { background-color: #dbeafe; color: #2563eb; }
        .form-input { border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem; width: 100%; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .sidebar-container { position: fixed; top: 0; left: 0; height: 100vh; width: 16rem; z-index: 40; overflow-y: auto; }
        .main-content { margin-left: 16rem; width: calc(100% - 16rem); min-height: 100vh; }
        @media (max-width: 1023px) {
            .sidebar-container { transform: translateX(-100%); }
            .sidebar-container.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .payroll-card { transition: all 0.2s ease; border: 1px solid #e5e7eb; }
        .payroll-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .dark .payroll-card { border-color: #374151; }
        .dark .payroll-card:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); }
        .grade-badge { padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 500; }
        .grade-1 { background-color: #dbeafe; color: #1e40af; }
        .grade-2 { background-color: #dcfce7; color: #166534; }
        .grade-3 { background-color: #f0f9ff; color: #0c4a6e; }
        .grade-4 { background-color: #fef3c7; color: #92400e; }
        .grade-5 { background-color: #f3e8ff; color: #5b21b6; }
        .grade-6 { background-color: #fce7f3; color: #9d174d; }
        .grade-7 { background-color: #fef3c7; color: #92400e; }
        /* Conditional field visibility */
        .field-dependent { transition: all 0.2s; }
    </style>
</head>
<body>
<main layout:fragment="content">
    <!-- Back button and page header -->
    <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-2 text-sm text-slate-500">
            <a th:href="@{/payroll}" class="hover:text-primary transition-colors flex items-center gap-1">
                <span class="material-icons-round">arrow_back</span>
                Back to Dashboard
            </a>
            <span class="mx-2">/</span>
            <span class="font-medium text-slate-900 dark:text-white">Allowances & Deductions</span>
        </div>
    </div>

    <!-- Hidden data for JavaScript (populated from server) -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Convert server-side lists to JavaScript arrays for editing
        var allowances = /*[[${allowances}]]*/ [];
        var deductions = /*[[${deductions}]]*/ [];
        /*]]>*/
    </script>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Allowances Section (takes 2/3 width on large screens) -->
        <div class="lg:col-span-2 flex flex-col">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden flex-1">
                <!-- Section header -->
                <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="material-icons-round text-green-600 bg-green-100 dark:bg-green-900/30 p-2 rounded-lg">add_circle</span>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Allowances</h3>
                    </div>
                    <button onclick="openModal('addAllowanceModal')"
                            class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                        Add Allowance
                    </button>
                </div>

                <div class="p-6">
                    <!-- Allowances List (when data exists) -->
                    <div th:if="${not #lists.isEmpty(allowances)}" class="grid grid-cols-1 md:grid-cols-2 gap-4" id="allowancesList">
                        <div th:each="allowance : ${allowances}"
                             class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow">
                            <!-- Top row: name + amount -->
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 dark:text-white" th:text="${allowance.name}">Housing Allowance</h4>
                                    <div class="flex flex-wrap items-center gap-2 mt-1">
                                        <span class="text-xs text-gray-500 dark:text-gray-400" th:text="${allowance.code}">ALL-HOUSING</span>
                                        <span th:if="${allowance.taxable}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400">Taxable</span>
                                        <span th:unless="${allowance.taxable}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400">Non-taxable</span>
                                        <span th:if="${allowance.status == 'ACTIVE'}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">Active</span>
                                        <span th:if="${allowance.status == 'INACTIVE'}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400">Inactive</span>
                                        <!-- NEW: Calculation type badge -->
                                        <span th:if="${allowance.calculationType}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"
                                              th:text="${allowance.calculationType}">FIXED_AMOUNT</span>
                                        <!-- NEW: Proratable badge -->
                                        <span th:if="${allowance.proratable}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400">Proratable</span>
                                    </div>
                                    <!-- NEW: Percentage rate or formula indicator -->
                                    <div th:if="${allowance.calculationType == 'PERCENTAGE_OF_BASIC' or allowance.calculationType == 'PERCENTAGE_OF_GROSS' or allowance.calculationType == 'PERCENTAGE_OF_TAXABLE'}"
                                         class="mt-1 text-xs text-gray-600 dark:text-gray-400">
                                        Rate: <span th:text="${allowance.percentageRate} + '%'">10%</span>
                                    </div>
                                    <div th:if="${allowance.calculationType == 'FORMULA' and allowance.formulaExpression}"
                                         class="mt-1 text-xs text-gray-600 dark:text-gray-400 truncate max-w-[200px]"
                                         th:title="${allowance.formulaExpression}">
                                        Formula: <span th:text="${allowance.formulaExpression}">expression</span>
                                    </div>
                                </div>
                                <span class="text-lg font-bold text-green-600 dark:text-green-400"
                                      th:text="'+ ₦' + ${#numbers.formatDecimal(allowance.amount, 1, 2)}">+ ₦1,200.00</span>
                            </div>
                            <!-- Bottom row: ID + actions -->
                            <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                                <div class="text-xs text-gray-500 dark:text-gray-500" th:text="'ID: ' + ${allowance.id}">ID: 1</div>
                                <div class="flex space-x-3">
                                    <button th:onclick="'editAllowance(' + ${allowance.id} + ')'"
                                            class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium flex items-center">
                                        <span class="material-icons-round text-sm mr-1">edit</span> Edit
                                    </button>
                                    <button th:onclick="'toggleAllowanceStatus(' + ${allowance.id} + ')'"
                                            class="text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-300 text-sm font-medium flex items-center"
                                            th:text="${allowance.status == 'ACTIVE' ? 'Deactivate' : 'Activate'}">Deactivate</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State for Allowances -->
                    <div th:if="${#lists.isEmpty(allowances)}" class="flex flex-col items-center justify-center py-16 text-center">
                        <span class="material-icons-round text-gray-300 dark:text-gray-600 text-6xl mb-4">card_giftcard</span>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">No allowances yet</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Add your first allowance to get started.</p>
                        <button onclick="openModal('addAllowanceModal')"
                                class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
                            <span class="material-icons-round text-sm mr-1">add</span> Add Allowance
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deductions Section (takes 1/3 width on large screens) -->
        <div class="flex flex-col">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden flex-1">
                <!-- Section header -->
                <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="material-icons-round text-red-600 bg-red-100 dark:bg-red-900/30 p-2 rounded-lg">remove_circle</span>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Deductions</h3>
                    </div>
                    <button onclick="openModal('addDeductionModal')"
                            class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Add Deduction
                    </button>
                </div>

                <div class="p-6">
                    <!-- Deductions List (when data exists) -->
                    <div th:if="${not #lists.isEmpty(deductions)}" class="space-y-4" id="deductionsList">
                        <div th:each="deduction : ${deductions}"
                             class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow">
                            <!-- Top row: name + amount -->
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 dark:text-white" th:text="${deduction.name}">Health Insurance</h4>
                                    <div class="flex flex-wrap items-center gap-2 mt-1">
                                        <span class="text-xs text-gray-500 dark:text-gray-400" th:text="${deduction.code}">DED-HEALTH</span>
                                        <span th:if="${deduction.statutory}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400">Statutory</span>
                                        <span th:unless="${deduction.statutory}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400">Non-statutory</span>
                                        <span th:if="${deduction.status == 'ACTIVE'}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">Active</span>
                                        <span th:if="${deduction.status == 'INACTIVE'}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400">Inactive</span>
                                        <!-- NEW: Calculation type badge -->
                                        <span th:if="${deduction.calculationType}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"
                                              th:text="${deduction.calculationType}">FIXED_AMOUNT</span>
                                        <!-- NEW: Proratable badge -->
                                        <span th:if="${deduction.proratable}"
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400">Proratable</span>
                                    </div>
                                    <!-- NEW: Percentage rate or formula indicator -->
                                    <div th:if="${deduction.calculationType == 'PERCENTAGE_OF_BASIC' or deduction.calculationType == 'PERCENTAGE_OF_GROSS' or deduction.calculationType == 'PERCENTAGE_OF_TAXABLE'}"
                                         class="mt-1 text-xs text-gray-600 dark:text-gray-400">
                                        Rate: <span th:text="${deduction.percentageRate} + '%'">10%</span>
                                    </div>
                                    <div th:if="${deduction.calculationType == 'FORMULA' and deduction.formulaExpression}"
                                         class="mt-1 text-xs text-gray-600 dark:text-gray-400 truncate max-w-[200px]"
                                         th:title="${deduction.formulaExpression}">
                                        Formula: <span th:text="${deduction.formulaExpression}">expression</span>
                                    </div>
                                </div>
                                <span class="text-lg font-bold text-red-600 dark:text-red-400"
                                      th:text="'- ₦' + ${#numbers.formatDecimal(deduction.amount, 1, 2)}">- ₦150.00</span>
                            </div>
                            <!-- Bottom row: ID + actions -->
                            <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                                <div class="text-xs text-gray-500 dark:text-gray-500" th:text="'ID: ' + ${deduction.id}">ID: 1</div>
                                <div class="flex space-x-3">
                                    <button th:onclick="'editDeduction(' + ${deduction.id} + ')'"
                                            class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium flex items-center">
                                        <span class="material-icons-round text-sm mr-1">edit</span> Edit
                                    </button>
                                    <button th:onclick="'toggleDeductionStatus(' + ${deduction.id} + ')'"
                                            class="text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-300 text-sm font-medium flex items-center"
                                            th:text="${deduction.status == 'ACTIVE' ? 'Deactivate' : 'Activate'}">Deactivate</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State for Deductions -->
                    <div th:if="${#lists.isEmpty(deductions)}" class="flex flex-col items-center justify-center py-16 text-center">
                        <span class="material-icons-round text-gray-300 dark:text-gray-600 text-6xl mb-4">remove_circle_outline</span>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">No deductions yet</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Add your first deduction to get started.</p>
                        <button onclick="openModal('addDeductionModal')"
                                class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700">
                            <span class="material-icons-round text-sm mr-1">add</span> Add Deduction
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Add Allowance Modal (updated with new fields) -->
    <div id="addAllowanceModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Add New Allowance</h3>
                    <button onclick="closeModal('addAllowanceModal')" class="text-gray-400 hover:text-gray-600">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
                <form th:action="@{/setup/allowance}" method="post" id="addAllowanceForm" class="space-y-4" onsubmit="disableSubmitButton(this)">
                    <input type="hidden" name="id" value="" /> <!-- for edit, but add has no id -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Code * <span class="text-xs text-gray-500">(unique)</span></label>
                        <input name="code" type="text" id="addAllowanceCode" class="form-input" placeholder="e.g., ALL-HOUSING" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Name *</label>
                        <input name="name" type="text" class="form-input" placeholder="e.g., Housing Allowance" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Amount *</label>
                        <input name="amount" type="number" step="0.01" min="0" class="form-input" placeholder="0.00" required>
                    </div>
                    <!-- NEW: Calculation Type -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Calculation Type</label>
                        <select name="calculationType" class="form-input" required onchange="toggleCalculationFields(this, 'addAllowance')">
                            <option value="FIXED_AMOUNT">Fixed Amount</option>
                            <option value="PERCENTAGE_OF_BASIC">Percentage of Basic</option>
                            <option value="PERCENTAGE_OF_GROSS">Percentage of Gross</option>
                            <option value="PERCENTAGE_OF_TAXABLE">Percentage of Taxable</option>
                            <option value="FORMULA">Formula</option>
                        </select>
                    </div>
                    <!-- NEW: Percentage Rate (hidden by default) -->
                    <div id="addAllowancePercentageField" class="field-dependent hidden">
                        <label class="block text-sm font-medium mb-2">Percentage Rate (%)</label>
                        <input name="percentageRate" type="number" step="0.0001" min="0" max="100" class="form-input" placeholder="e.g., 10.5">
                    </div>
                    <!-- NEW: Formula Expression (hidden by default) -->
                    <div id="addAllowanceFormulaField" class="field-dependent hidden">
                        <label class="block text-sm font-medium mb-2">Formula Expression</label>
                        <textarea name="formulaExpression" rows="3" class="form-input" placeholder="e.g., 20% of BASIC"></textarea>
                    </div>
                    <!-- NEW: Proratable Checkbox -->
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="proratable" value="true" class="text-primary-600">
                            <span class="text-sm font-medium">Proratable (adjust for partial periods)</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="taxable" value="true" class="text-primary-600">
                            <span class="text-sm font-medium">Taxable (include in tax calculation)</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Status</label>
                        <select name="status" class="form-input" required>
                            <option value="ACTIVE">ACTIVE</option>
                            <option value="INACTIVE">INACTIVE</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('addAllowanceModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Add Allowance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Allowance Modal (similar to add but with populated data) -->
    <div id="editAllowanceModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Edit Allowance</h3>
                    <button onclick="closeModal('editAllowanceModal')" class="text-gray-400 hover:text-gray-600">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
                <form th:action="@{/setup/allowance/update}" method="post" id="editAllowanceForm" class="space-y-4" onsubmit="disableSubmitButton(this)">
                    <input type="hidden" name="id" id="editAllowanceId" value="" />
                    <div>
                        <label class="block text-sm font-medium mb-2">Code *</label>
                        <input name="code" type="text" id="editAllowanceCode" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Name *</label>
                        <input name="name" type="text" id="editAllowanceName" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Amount *</label>
                        <input name="amount" type="number" step="0.01" min="0" id="editAllowanceAmount" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Calculation Type</label>
                        <select name="calculationType" id="editAllowanceCalcType" class="form-input" required onchange="toggleCalculationFields(this, 'editAllowance')">
                            <option value="FIXED_AMOUNT">Fixed Amount</option>
                            <option value="PERCENTAGE_OF_BASIC">Percentage of Basic</option>
                            <option value="PERCENTAGE_OF_GROSS">Percentage of Gross</option>
                            <option value="PERCENTAGE_OF_TAXABLE">Percentage of Taxable</option>
                            <option value="FORMULA">Formula</option>
                        </select>
                    </div>
                    <div id="editAllowancePercentageField" class="field-dependent hidden">
                        <label class="block text-sm font-medium mb-2">Percentage Rate (%)</label>
                        <input name="percentageRate" type="number" step="0.0001" min="0" max="100" id="editAllowancePercentage" class="form-input">
                    </div>
                    <div id="editAllowanceFormulaField" class="field-dependent hidden">
                        <label class="block text-sm font-medium mb-2">Formula Expression</label>
                        <textarea name="formulaExpression" rows="3" id="editAllowanceFormula" class="form-input"></textarea>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="proratable" value="true" id="editAllowanceProratable" class="text-primary-600">
                            <span class="text-sm font-medium">Proratable</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="taxable" value="true" id="editAllowanceTaxable" class="text-primary-600">
                            <span class="text-sm font-medium">Taxable</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Status</label>
                        <select name="status" id="editAllowanceStatus" class="form-input" required>
                            <option value="ACTIVE">ACTIVE</option>
                            <option value="INACTIVE">INACTIVE</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('editAllowanceModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Update Allowance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Deduction Modal (updated) -->
    <div id="addDeductionModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Add New Deduction</h3>
                    <button onclick="closeModal('addDeductionModal')" class="text-gray-400 hover:text-gray-600">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
                <form th:action="@{/setup/deduction}" method="post" id="addDeductionForm" class="space-y-4" onsubmit="disableSubmitButton(this)">
                    <input type="hidden" name="id" value="" />
                    <div>
                        <label class="block text-sm font-medium mb-2">Code * <span class="text-xs text-gray-500">(unique)</span></label>
                        <input name="code" type="text" id="addDeductionCode" class="form-input" placeholder="e.g., DED-HEALTH" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Name *</label>
                        <input name="name" type="text" class="form-input" placeholder="e.g., Health Insurance" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Amount *</label>
                        <input name="amount" type="number" step="0.01" min="0" class="form-input" placeholder="0.00" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Calculation Type</label>
                        <select name="calculationType" class="form-input" required onchange="toggleCalculationFields(this, 'addDeduction')">
                            <option value="FIXED_AMOUNT">Fixed Amount</option>
                            <option value="PERCENTAGE_OF_BASIC">Percentage of Basic</option>
                            <option value="PERCENTAGE_OF_GROSS">Percentage of Gross</option>
                            <option value="PERCENTAGE_OF_TAXABLE">Percentage of Taxable</option>
                            <option value="FORMULA">Formula</option>
                        </select>
                    </div>
                    <div id="addDeductionPercentageField" class="field-dependent hidden">
                        <label class="block text-sm font-medium mb-2">Percentage Rate (%)</label>
                        <input name="percentageRate" type="number" step="0.0001" min="0" max="100" class="form-input" placeholder="e.g., 5.5">
                    </div>
                    <div id="addDeductionFormulaField" class="field-dependent hidden">
                        <label class="block text-sm font-medium mb-2">Formula Expression</label>
                        <textarea name="formulaExpression" rows="3" class="form-input" placeholder="e.g., 20% of BASIC"></textarea>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="proratable" value="true" class="text-primary-600">
                            <span class="text-sm font-medium">Proratable</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="statutory" value="true" class="text-primary-600">
                            <span class="text-sm font-medium">Statutory (required by law)</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Status</label>
                        <select name="status" class="form-input" required>
                            <option value="ACTIVE">ACTIVE</option>
                            <option value="INACTIVE">INACTIVE</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('addDeductionModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Add Deduction</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Deduction Modal -->
    <div id="editDeductionModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Edit Deduction</h3>
                    <button onclick="closeModal('editDeductionModal')" class="text-gray-400 hover:text-gray-600">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
                <form th:action="@{/setup/deduction/update}" method="post" id="editDeductionForm" class="space-y-4" onsubmit="disableSubmitButton(this)">
                    <input type="hidden" name="id" id="editDeductionId" value="" />
                    <div>
                        <label class="block text-sm font-medium mb-2">Code *</label>
                        <input name="code" type="text" id="editDeductionCode" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Name *</label>
                        <input name="name" type="text" id="editDeductionName" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Amount *</label>
                        <input name="amount" type="number" step="0.01" min="0" id="editDeductionAmount" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Calculation Type</label>
                        <select name="calculationType" id="editDeductionCalcType" class="form-input" required onchange="toggleCalculationFields(this, 'editDeduction')">
                            <option value="FIXED_AMOUNT">Fixed Amount</option>
                            <option value="PERCENTAGE_OF_BASIC">Percentage of Basic</option>
                            <option value="PERCENTAGE_OF_GROSS">Percentage of Gross</option>
                            <option value="PERCENTAGE_OF_TAXABLE">Percentage of Taxable</option>
                            <option value="FORMULA">Formula</option>
                        </select>
                    </div>
                    <div id="editDeductionPercentageField" class="field-dependent hidden">
                        <label class="block text-sm font-medium mb-2">Percentage Rate (%)</label>
                        <input name="percentageRate" type="number" step="0.0001" min="0" max="100" id="editDeductionPercentage" class="form-input">
                    </div>
                    <div id="editDeductionFormulaField" class="field-dependent hidden">
                        <label class="block text-sm font-medium mb-2">Formula Expression</label>
                        <textarea name="formulaExpression" rows="3" id="editDeductionFormula" class="form-input"></textarea>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="proratable" value="true" id="editDeductionProratable" class="text-primary-600">
                            <span class="text-sm font-medium">Proratable</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="statutory" value="true" id="editDeductionStatutory" class="text-primary-600">
                            <span class="text-sm font-medium">Statutory</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Status</label>
                        <select name="status" id="editDeductionStatus" class="form-input" required>
                            <option value="ACTIVE">ACTIVE</option>
                            <option value="INACTIVE">INACTIVE</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('editDeductionModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Update Deduction</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal JavaScript functions (updated) -->
    <script>
        // Open modal (existing, but also ensure fields are reset for add modals)
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            // If it's an add modal, generate code and reset conditional fields
            if (modalId === 'addAllowanceModal') {
                generateAndSetCode('addAllowanceCode', 'ALL');
                // Reset calculation type to default FIXED_AMOUNT and hide conditional fields
                const select = document.querySelector('#addAllowanceModal select[name="calculationType"]');
                if (select) {
                    select.value = 'FIXED_AMOUNT';
                    toggleCalculationFields(select, 'addAllowance');
                }
            } else if (modalId === 'addDeductionModal') {
                generateAndSetCode('addDeductionCode', 'DED');
                const select = document.querySelector('#addDeductionModal select[name="calculationType"]');
                if (select) {
                    select.value = 'FIXED_AMOUNT';
                    toggleCalculationFields(select, 'addDeduction');
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function disableSubmitButton(form) {
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            return true;
        }

        // Generate random code for add modals
        function generateAndSetCode(inputId, prefix) {
            const input = document.getElementById(inputId);
            if (input) {
                const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
                input.value = prefix + '-' + randomPart;
            }
        }

        // Toggle percentage/formula fields based on calculation type
        function toggleCalculationFields(select, prefix) {
            const value = select.value;
            const percentageField = document.getElementById(prefix + 'PercentageField');
            const formulaField = document.getElementById(prefix + 'FormulaField');

            // Hide both first
            if (percentageField) percentageField.classList.add('hidden');
            if (formulaField) formulaField.classList.add('hidden');

            // Show relevant field
            if (value.startsWith('PERCENTAGE')) {
                if (percentageField) percentageField.classList.remove('hidden');
            } else if (value === 'FORMULA') {
                if (formulaField) formulaField.classList.remove('hidden');
            }
        }

        // Edit functions: populate modal from the globally available arrays
        function editAllowance(id) {
            const allowance = allowances.find(a => a.id === id);
            if (!allowance) return;

            // Populate fields
            document.getElementById('editAllowanceId').value = allowance.id;
            document.getElementById('editAllowanceCode').value = allowance.code;
            document.getElementById('editAllowanceName').value = allowance.name;
            document.getElementById('editAllowanceAmount').value = allowance.amount;
            document.getElementById('editAllowanceCalcType').value = allowance.calculationType || 'FIXED_AMOUNT';
            document.getElementById('editAllowancePercentage').value = allowance.percentageRate || '';
            document.getElementById('editAllowanceFormula').value = allowance.formulaExpression || '';
            document.getElementById('editAllowanceProratable').checked = allowance.proratable || false;
            document.getElementById('editAllowanceTaxable').checked = allowance.taxable || false;
            document.getElementById('editAllowanceStatus').value = allowance.status || 'ACTIVE';

            // Trigger toggle to show correct conditional fields
            const select = document.getElementById('editAllowanceCalcType');
            toggleCalculationFields(select, 'editAllowance');

            // Open modal
            openModal('editAllowanceModal');
        }

        function editDeduction(id) {
            const deduction = deductions.find(d => d.id === id);
            if (!deduction) return;

            document.getElementById('editDeductionId').value = deduction.id;
            document.getElementById('editDeductionCode').value = deduction.code;
            document.getElementById('editDeductionName').value = deduction.name;
            document.getElementById('editDeductionAmount').value = deduction.amount;
            document.getElementById('editDeductionCalcType').value = deduction.calculationType || 'FIXED_AMOUNT';
            document.getElementById('editDeductionPercentage').value = deduction.percentageRate || '';
            document.getElementById('editDeductionFormula').value = deduction.formulaExpression || '';
            document.getElementById('editDeductionProratable').checked = deduction.proratable || false;
            document.getElementById('editDeductionStatutory').checked = deduction.statutory || false;
            document.getElementById('editDeductionStatus').value = deduction.status || 'ACTIVE';

            const select = document.getElementById('editDeductionCalcType');
            toggleCalculationFields(select, 'editDeduction');

            openModal('editDeductionModal');
        }

        // Dummy toggle functions for status (to be implemented)
        function toggleAllowanceStatus(id) {
            // You can implement AJAX call or form submission
            alert('Toggle allowance status for ID: ' + id);
        }

        function toggleDeductionStatus(id) {
            alert('Toggle deduction status for ID: ' + id);
        }
    </script>
</main>
</body>
</html>