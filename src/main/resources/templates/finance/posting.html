<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="layouts/financialOfficerLayout">
<head>
    <meta charset="UTF-8"/>
    <title>Journal Postings · HRPro Finance</title>

    <!-- Inter font & icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>

    <script th:inline="none">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                    }
                },
            },
        };
    </script>

    <style>
        /* Additional custom styles not covered by Tailwind */
        body {
            overflow-x: hidden;
        }

        /* Sidebar items – already in layout, but kept for reference */
        .sidebar-item {
            transition: all 0.2s ease;
            position: relative;
        }
        .sidebar-item.active {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-left: 3px solid #3b82f6;
        }
        .sidebar-item.active .material-icons-round {
            color: #3b82f6;
        }
        .sidebar-item:hover:not(.active) {
            background-color: rgba(59, 130, 246, 0.05);
        }
        .dark .sidebar-item.active {
            background-color: rgba(59, 130, 246, 0.2);
        }

        /* Stat cards */
        .stat-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Period card */
        .period-card {
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
            background-color: white;
            border-radius: 1rem;
            overflow: hidden;
        }
        .dark .period-card {
            background-color: #1f2937;
            border-color: #374151;
        }
        .period-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #2563eb;
        }
        .dark .period-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border-color: #3b82f6;
        }

        .period-card-header {
            padding: 1.25rem;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dark .period-card-header {
            border-bottom-color: #1f2937;
        }

        .period-card-body {
            padding: 0; /* remove padding so table stretches edge-to-edge */
        }

        /* Badges */
        .badge {
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
        }
        .badge-success {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .badge-warning {
            background-color: #fef3c7;
            color: #d97706;
        }
        .badge-neutral {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        .dark .badge-neutral {
            background-color: #374151;
            color: #d1d5db;
        }
        .badge-blue {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .dark .badge-blue {
            background-color: #1e3a8a;
            color: #bfdbfe;
        }
        .badge-purple {
            background-color: #ede9fe;
            color: #6d28d9;
        }
        .dark .badge-purple {
            background-color: #5b21b6;
            color: #ddd6fe;
        }

        /* Account code pill */
        .acct-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: #dbeafe;
            color: #1e40af;
            font-family: monospace;
        }
        .dark .acct-pill {
            background-color: #1e3a8a;
            color: #bfdbfe;
        }

        /* Download button in header */
        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: #2563eb;
            transition: all 0.2s;
        }
        .dark .btn-download {
            background-color: #111827;
            border-color: #374151;
            color: #60a5fa;
        }
        .btn-download:hover {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .dark .btn-download:hover {
            background-color: #3b82f6;
            color: white;
        }

        /* Table styling */
        .journal-table {
            min-width: 100%;
            border-collapse: collapse;
        }
        .journal-table th {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .journal-table th {
            background-color: #1f2937;
            color: #9ca3af;
            border-bottom-color: #374151;
        }
        .journal-table td {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            color: #111827;
            border-bottom: 1px solid #f3f4f6;
        }
        .dark .journal-table td {
            color: #f3f4f6;
            border-bottom-color: #374151;
        }
        .journal-table tbody tr:hover td {
            background-color: #f9fafb;
        }
        .dark .journal-table tbody tr:hover td {
            background-color: #2d3748;
        }
        .journal-table .num {
            font-family: monospace;
            text-align: right;
        }
        .debit-val {
            color: #2563eb;
            font-weight: 500;
        }
        .credit-val {
            color: #16a34a;
            font-weight: 500;
        }
        .dark .debit-val {
            color: #60a5fa;
        }
        .dark .credit-val {
            color: #4ade80;
        }
        .totals-row {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .dark .totals-row {
            background-color: #1f2937;
        }
    </style>
</head>
<body>
<main layout:fragment="content">

    <!-- Data island (unchanged) -->
    <script id="journal-data" type="application/json">
        [
            <th:block th:each="entry, iterStat : ${journalEntries}">
            {
                "id":            <th:block th:text="${entry.id}">0</th:block>,
                "payrollPeriodId": <th:block th:text="${entry.payrollPeriodId}">0</th:block>,
                "periodStart":   "<th:block th:text="${entry.periodStart}">-</th:block>",
            "periodEnd":     "<th:block th:text="${entry.periodEnd}">-</th:block>",
            "accountCode":   "<th:block th:text="${entry.accountCode}">-</th:block>",
            "accountName":   "<th:block th:text="${entry.accountName}">-</th:block>",
            "debitAmount":   <th:block th:text="${entry.debitAmount}">0</th:block>,
            "creditAmount":  <th:block th:text="${entry.creditAmount}">0</th:block>,
            "description":   "<th:block th:text="${entry.description}">-</th:block>",
            "exported":      <th:block th:text="${entry.exported}">false</th:block>
            }<th:block th:if="${!iterStat.last}">,</th:block>
            </th:block>
        ]
    </script>


    <!-- ========== SUMMARY STAT CARDS ========== -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-gray-500 dark:text-gray-400">Total periods</span>
                <span class="material-icons-round text-primary-500">calendar_month</span>
            </div>
            <p id="total-periods" class="text-2xl font-bold">—</p>
            <p class="text-xs text-gray-500 mt-1">Grouped by month</p>
        </div>
        <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-gray-500 dark:text-gray-400">Total entries</span>
                <span class="material-icons-round text-green-500">receipt_long</span>
            </div>
            <p id="total-entries" class="text-2xl font-bold">—</p>
            <p class="text-xs text-gray-500 mt-1">Journal lines</p>
        </div>
        <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-gray-500 dark:text-gray-400">Total debits</span>
                <span class="material-icons-round text-blue-500">arrow_upward</span>
            </div>
            <p id="total-debits" class="text-2xl font-bold">—</p>
            <p class="text-xs text-gray-500 mt-1">Sum of all periods</p>
        </div>
        <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-gray-500 dark:text-gray-400">Balanced periods</span>
                <span class="material-icons-round text-purple-500">balance</span>
            </div>
            <p id="balanced-periods" class="text-2xl font-bold">—</p>
            <p class="text-xs text-gray-500 mt-1">Debits = Credits</p>
        </div>
    </div>

    <!-- ========== DYNAMIC CONTENT MOUNT POINT ========== -->
    <div id="journal-mount">
        <!-- skeleton loader (unchanged) -->
        <div class="animate-pulse space-y-4">
            <div class="h-48 bg-white dark:bg-gray-800 rounded-xl opacity-60"></div>
            <div class="h-48 bg-white dark:bg-gray-800 rounded-xl opacity-40"></div>
        </div>
    </div>

    <!-- ========== JAVASCRIPT – GROUP, RENDER, CSV EXPORT ========== -->
    <script th:inline="none">
        (function () {
            /* --- helpers (keep same logic, only update formatting if needed) --- */
            const fmt = (n) =>
                Number(n) === 0
                    ? '—'
                    : Number(n).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const fmtRaw = (n) => Number(n).toFixed(2);

            const monthYear = (dateStr) => {
                const [y, m] = dateStr.split('-');
                const d = new Date(Number(y), Number(m) - 1, 1);
                return d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            };

            const fmtDate = (dateStr) => {
                const [y, m, d] = dateStr.split('-');
                const date = new Date(Number(y), Number(m) - 1, Number(d));
                return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            };

            const escCsv = (v) => {
                const s = String(v);
                return s.includes(',') || s.includes('"') || s.includes('\n')
                    ? '"' + s.replace(/"/g, '""') + '"'
                    : s;
            };

            /* --- parse data island --- */
            let entries = [];
            try {
                entries = JSON.parse(document.getElementById('journal-data').textContent.trim());
            } catch (e) {
                document.getElementById('journal-mount').innerHTML =
                    '<p class="text-red-500 p-4">Failed to parse journal data.</p>';
                return;
            }

            if (!entries.length) {
                document.getElementById('journal-mount').innerHTML =
                    '<div class="period-card p-10 text-center text-gray-400 dark:text-gray-500">' +
                    '<span class="material-icons-round text-4xl text-gray-300 dark:text-gray-600">inbox</span>' +
                    '<p class="mt-2 text-sm font-medium">No journal entries found.</p></div>';
                return;
            }

            /* --- group by periodStart + periodEnd --- */
            const groupMap = new Map();
            entries.forEach(e => {
                const key = e.periodStart + '|' + e.periodEnd;
                if (!groupMap.has(key)) groupMap.set(key, []);
                groupMap.get(key).push(e);
            });
            const groups = Array.from(groupMap.entries());

            /* --- update summary stats (including balanced count) --- */
            const totalDebits = entries.reduce((s, e) => s + Number(e.debitAmount), 0);
            let balancedCount = 0;
            for (let [_, rows] of groupMap) {
                const totD = rows.reduce((s, r) => s + Number(r.debitAmount), 0);
                const totC = rows.reduce((s, r) => s + Number(r.creditAmount), 0);
                if (Math.abs(totD - totC) < 0.005) balancedCount++;
            }

            document.getElementById('total-periods').textContent = groups.length;
            document.getElementById('total-entries').textContent = entries.length;
            document.getElementById('total-debits').textContent =
                '₦' + totalDebits.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('balanced-periods').textContent = balancedCount;

            /* --- CSV download function (unchanged) --- */
            window.downloadGroupCsv = function (groupKey) {
                const rows = groupMap.get(groupKey);
                if (!rows) return;
                const headers = ['ID', 'Period Start', 'Period End', 'Account Code', 'Account Name', 'Debit (₦)', 'Credit (₦)', 'Description', 'Exported'];
                const lines = [headers.join(',')];
                rows.forEach(r => {
                    lines.push([
                        r.id, r.periodStart, r.periodEnd,
                        r.accountCode, escCsv(r.accountName),
                        fmtRaw(r.debitAmount), fmtRaw(r.creditAmount),
                        escCsv(r.description), r.exported
                    ].join(','));
                });
                const totD = rows.reduce((s, r) => s + Number(r.debitAmount), 0);
                const totC = rows.reduce((s, r) => s + Number(r.creditAmount), 0);
                lines.push(['', '', '', '', 'TOTAL', fmtRaw(totD), fmtRaw(totC), '', ''].join(','));

                const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url  = URL.createObjectURL(blob);
                const a    = document.createElement('a');
                const [ps, pe] = groupKey.split('|');
                a.href     = url;
                a.download = 'journal_' + ps + '_to_' + pe + '.csv';
                a.click();
                URL.revokeObjectURL(url);
            };

            /* --- render a single period group card (new structure) --- */
            function renderGroup(key, rows, isCurrent) {
                const [ps, pe] = key.split('|');
                const totalD = rows.reduce((s, r) => s + Number(r.debitAmount), 0);
                const totalC = rows.reduce((s, r) => s + Number(r.creditAmount), 0);
                const balanced = Math.abs(totalD - totalC) < 0.005;
                const allExported = rows.every(r => r.exported);

                // Badge classes
                const periodBadgeClass = isCurrent ? 'badge-blue' : 'badge-neutral';
                const periodBadgeIcon = isCurrent ? 'radio_button_checked' : 'history';
                const periodBadgeText = isCurrent ? 'Current period' : 'Previous period';

                const balanceBadgeClass = balanced ? 'badge-success' : 'badge-warning';
                const balanceIcon = balanced ? 'balance' : 'warning';
                const balanceText = balanced ? 'Balanced' : 'Unbalanced';

                // Build table rows
                const entryRows = rows.map(r => {
                    const hasDebit  = Number(r.debitAmount) > 0;
                    const hasCredit = Number(r.creditAmount) > 0;
                    const exportedBadge = r.exported
                        ? '<span class="badge badge-success"><span class="material-icons-round" style="font-size:12px">check_circle</span> Exported</span>'
                        : '<span class="badge badge-warning"><span class="material-icons-round" style="font-size:12px">schedule</span> Pending</span>';

                    return `
                        <tr>
                            <td class="text-xs text-gray-400 dark:text-gray-500 font-mono">#${r.id}</td>
                            <td><span class="acct-pill">${r.accountCode}</span></td>
                            <td>
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200">${r.accountName}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${r.description}</p>
                            </td>
                            <td class="num ${hasDebit ? 'debit-val' : 'text-gray-400 dark:text-gray-600'}">${hasDebit ? '₦' + fmt(r.debitAmount) : '—'}</td>
                            <td class="num ${hasCredit ? 'credit-val' : 'text-gray-400 dark:text-gray-600'}">${hasCredit ? '₦' + fmt(r.creditAmount) : '—'}</td>
                            <td class="text-center">${exportedBadge}</td>
                        </tr>`;
                }).join('');

                return `
                    <div class="period-card mb-6">
                        <!-- Header -->
                        <div class="period-card-header">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900/30 rounded-lg flex items-center justify-center">
                                    <span class="material-icons-round text-primary-600 dark:text-primary-400">receipt</span>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">${monthYear(ps)}</h3>
                                        <span class="badge ${periodBadgeClass}">
                                            <span class="material-icons-round" style="font-size:12px">${periodBadgeIcon}</span>
                                            ${periodBadgeText}
                                        </span>
                                        <span class="badge ${balanceBadgeClass}">
                                            <span class="material-icons-round" style="font-size:12px">${balanceIcon}</span>
                                            ${balanceText}
                                        </span>
                                        ${allExported ? '<span class="badge badge-success"><span class="material-icons-round" style="font-size:12px">cloud_done</span> All exported</span>' : ''}
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 font-mono mt-0.5">${fmtDate(ps)} → ${fmtDate(pe)}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="hidden sm:block text-right">
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Total debits</p>
                                    <p class="text-sm font-bold text-gray-900 dark:text-white font-mono">₦${fmt(totalD)}</p>
                                </div>
                                <div class="hidden sm:block text-right">
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Total credits</p>
                                    <p class="text-sm font-bold text-gray-900 dark:text-white font-mono">₦${fmt(totalC)}</p>
                                </div>
                                <button class="btn-download" onclick="downloadGroupCsv('${key}')">
                                    <span class="material-icons-round" style="font-size:16px">download</span>
                                    CSV
                                </button>
                            </div>
                        </div>

                        <!-- Journal table -->
                        <div class="period-card-body overflow-x-auto">
                            <table class="journal-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>A/C Code</th>
                                        <th>Account / Description</th>
                                        <th class="text-right">Debit (₦)</th>
                                        <th class="text-right">Credit (₦)</th>
                                        <th class="text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${entryRows}
                                </tbody>
                                <tfoot>
                                    <tr class="totals-row">
                                        <td colspan="3" class="text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Period totals</td>
                                        <td class="num font-bold debit-val">₦${fmt(totalD)}</td>
                                        <td class="num font-bold credit-val">₦${fmt(totalC)}</td>
                                        <td class="text-center">
                                            <span class="badge ${balanced ? 'badge-success' : 'badge-warning'}">
                                                ${balanced ? '✓ Balanced' : '⚠ Check'}
                                            </span>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- Footer -->
                        <div class="px-5 py-3 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                            <span>${rows.length} entr${rows.length === 1 ? 'y' : 'ies'} · Payroll run #${rows[0].payrollPeriodId}</span>
                            <span class="font-mono">${balanced ? '∑ Debits = ∑ Credits' : '∑ Debits ≠ ∑ Credits — review'}</span>
                        </div>
                    </div>`;
            }

            /* --- render all groups --- */
            let html = '';
            // Current period (first group)
            const [currentKey, currentRows] = groups[0];
            html += renderGroup(currentKey, currentRows, true);

            // Previous periods (if any)
            if (groups.length > 1) {
                html += `
                    <div class="section-divider flex items-center gap-3 my-6">
                        <span class="material-icons-round text-gray-400 dark:text-gray-500 text-sm">history</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Previous periods</span>
                        <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
                    </div>`;

                for (let i = 1; i < groups.length; i++) {
                    const [key, rows] = groups[i];
                    html += renderGroup(key, rows, false);
                }
            }

            document.getElementById('journal-mount').innerHTML = html;
        })();
    </script>

    <!-- Sidebar & theme JS (compatible with layout) -->
    <script th:inline="none">
        // Theme toggle (works with the button we added in header)
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            const themeIcon = themeToggle.querySelector('.material-icons-round');
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
            // Initialize
            if (localStorage.getItem('theme') === 'dark' ||
                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                themeIcon.textContent = 'light_mode';
            } else {
                themeIcon.textContent = 'dark_mode';
            }
        }

        // Mobile menu (if toggle exists inside layout, we connect it)
        const menuToggle = document.getElementById('menuToggle');
        const mobileOverlay = document.getElementById('mobileOverlay');
        const sidebar = document.querySelector('.sidebar-container');
        if (menuToggle && mobileOverlay && sidebar) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                mobileOverlay.classList.toggle('hidden');
                document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : 'auto';
            });
            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                mobileOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
        }

        // Close sidebar on window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024 && sidebar) {
                sidebar.classList.remove('open');
                if (mobileOverlay) mobileOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        });
    </script>
</main>
</body>
</html>