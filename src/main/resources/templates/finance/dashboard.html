<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="layouts/financialOfficerLayout">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Â· HRPro Finance</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    primary: {
                        50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe',
                        300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6',
                        600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a',
                    },
                    secondary: {
                        50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0',
                        300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b',
                        600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a',
                    }
                },
                fontFamily: { 'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'] },
                borderRadius: { 'xl': '1rem', '2xl': '1.5rem' }
            },
        },
    };
  </script>
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { overflow-x: hidden; }

    .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }

    .badge { padding: 2px 8px; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; }
    .badge-success { background-color: #dcfce7; color: #16a34a; }
    .badge-warning { background-color: #fef3c7; color: #d97706; }
    .badge-error   { background-color: #fee2e2; color: #dc2626; }
    .badge-info    { background-color: #dbeafe; color: #2563eb; }
    .badge-neutral { background-color: #f3f4f6; color: #4b5563; }
    .dark .badge-neutral { background-color: #374151; color: #d1d5db; }

    .sidebar-item { transition: all 0.2s ease; position: relative; }
    .sidebar-item.active { background-color: rgba(59,130,246,0.1); color:#3b82f6; border-left:3px solid #3b82f6; }
    .sidebar-item.active .material-icons-round { color:#3b82f6; }
    .sidebar-item:hover:not(.active) { background-color: rgba(59,130,246,0.05); }
    .dark .sidebar-item.active { background-color: rgba(59,130,246,0.2); }

    .sidebar-container { position:fixed; top:0; left:0; height:100vh; width:16rem; z-index:40; overflow-y:auto; }
    .main-content { margin-left:16rem; width:calc(100% - 16rem); min-height:100vh; }
    @media (max-width:1023px) {
        .sidebar-container { transform:translateX(-100%); }
        .sidebar-container.open { transform:translateX(0); }
        .main-content { margin-left:0; width:100%; }
    }

    .modal-backdrop { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
  </style>
</head>
<body>
<main layout:fragment="content">

  <!-- ===== STAT CARDS ===== -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">

    <!-- Pending approvals -->
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
          <span class="material-icons-round text-blue-600 dark:text-blue-400">pending_actions</span>
        </div>
        <span th:if="${approvalRequests != null and !approvalRequests.isEmpty()}"
              class="badge badge-warning"
              th:text="${approvalRequests.size()} + ' pending'">0 pending</span>
        <span th:unless="${approvalRequests != null and !approvalRequests.isEmpty()}"
              class="badge badge-success">all clear</span>
      </div>
      <h3 class="text-2xl font-bold"
          th:text="${approvalRequests != null ? approvalRequests.size() : 0}">0</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Pending lock approvals</p>
    </div>

    <!-- Open period (from first approval request) -->
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <div class="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
          <span class="material-icons-round text-amber-600 dark:text-amber-400">lock_open</span>
        </div>
      </div>
      <h3 class="text-2xl font-bold"
          th:text="${approvalRequests != null and !approvalRequests.isEmpty()
                            and approvalRequests[0].variables['periodStart'] != null
                            ? #temporals.format(approvalRequests[0].variables['periodStart'], 'MMM yyyy')
                            : 'â€”'}">â€”</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Open period awaiting lock</p>
    </div>

    <!-- Total locked periods -->
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg">
          <span class="material-icons-round text-green-600 dark:text-green-400">archive</span>
        </div>
      </div>
      <h3 class="text-2xl font-bold"
          th:text="${completedProcesses != null ? #lists.size(completedProcesses) : 0}">0</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Total locked periods</p>
    </div>

    <!-- Last locked period -->
    <div class="stat-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
      <div class="flex items-center justify-between mb-3">
        <div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
          <span class="material-icons-round text-purple-600 dark:text-purple-400">lock</span>
        </div>
        <span th:if="${completedProcesses != null and !completedProcesses.isEmpty()}"
              class="badge badge-success">locked</span>
      </div>
      <h3 class="text-2xl font-bold"
          th:with="first=${completedProcesses != null and !completedProcesses.isEmpty() ? completedProcesses[0] : null}"
          th:text="${first != null and first.processVariables['periodStart'] != null
                            ? #temporals.format(first.processVariables['periodStart'], 'MMM yyyy')
                            : 'â€”'}">â€”</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Last locked period</p>
    </div>
  </div>


  <!-- ===== MAIN TWO-COLUMN LAYOUT ===== -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

    <!-- Left column (2/3) -->
    <div class="lg:col-span-2 space-y-6">

      <!-- â”€â”€ Pending Lock Requests â”€â”€ -->
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <span class="material-icons-round text-primary-600">lock_clock</span>
              <h3 class="text-lg font-bold">Pending lock requests</h3>
              <span th:if="${approvalRequests != null and !approvalRequests.isEmpty()}"
                    class="badge badge-warning"
                    th:text="${approvalRequests.size()} + ' pending'">0 pending</span>
            </div>
            <a th:href="@{/finance/lock-approval}"
               class="text-primary-600 hover:text-primary-700 text-sm font-medium flex items-center">
              View all <span class="material-icons-round text-sm ml-1">arrow_forward</span>
            </a>
          </div>
        </div>

        <!-- Has requests -->
        <div th:if="${approvalRequests != null and !approvalRequests.isEmpty()}"
             class="overflow-x-auto">
          <table class="w-full min-w-[560px]">
            <thead>
            <tr class="bg-gray-50 dark:bg-gray-700 text-xs font-semibold uppercase tracking-wider text-gray-600 dark:text-gray-300">
              <th class="px-4 md:px-6 py-3 text-left">Period</th>
              <th class="px-4 md:px-6 py-3 text-left">Employees</th>
              <th class="px-4 md:px-6 py-3 text-left">Net Pay (â‚¦)</th>
              <th class="px-4 md:px-6 py-3 text-left">Submitted</th>
              <th class="px-4 md:px-6 py-3 text-left">Status</th>
              <th class="px-4 md:px-6 py-3 text-left">Action</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            <tr th:each="request : ${approvalRequests}"
                th:with="vars=${request.variables}"
                class="hover:bg-gray-50 dark:hover:bg-gray-750">
              <td class="px-4 md:px-6 py-4 font-medium"
                  th:text="${vars['periodStart'] != null
                                            ? #temporals.format(vars['periodStart'], 'MMMM yyyy')
                                            : 'â€”'}">â€”</td>
              <td class="px-4 md:px-6 py-4"
                  th:text="${vars['employeeCount'] ?: 'â€”'}">â€”</td>
              <td class="px-4 md:px-6 py-4"
                  th:text="${vars['totalNet'] != null
                                            ? #numbers.formatDecimal(vars['totalNet'], 1, 'COMMA', 0, 'POINT')
                                            : 'â€”'}">â€”</td>
              <td class="px-4 md:px-6 py-4 text-gray-500 dark:text-gray-400 text-sm"
                  th:text="${#temporals.format(request.createdTime, 'dd MMM yyyy')}">â€”</td>
              <td class="px-4 md:px-6 py-4">
                <span class="badge badge-warning">pending</span>
              </td>
              <td class="px-4 md:px-6 py-4">
                <a th:href="@{/finance/lock-approval}"
                   class="text-primary-600 hover:text-primary-800 text-sm font-medium">Review</a>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- No pending requests -->
        <div th:unless="${approvalRequests != null and !approvalRequests.isEmpty()}"
             class="p-10 text-center">
          <span class="material-icons-round text-5xl text-gray-300 dark:text-gray-600 block mb-3">inbox</span>
          <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">No pending lock requests</p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">All payroll periods are up to date.</p>
        </div>
      </div>


      <!-- â”€â”€ Locked Periods (recent) â”€â”€ -->
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <span class="material-icons-round text-primary-600">archive</span>
              <h3 class="text-lg font-bold">Locked periods</h3>
              <span th:if="${completedProcesses != null}"
                    class="badge badge-info"
                    th:text="${#lists.size(completedProcesses)} + ' total'">0 total</span>
            </div>
            <a th:href="@{/finance/lockedPeriods}"
               class="text-primary-600 hover:text-primary-700 text-sm font-medium flex items-center">
              View all <span class="material-icons-round text-sm ml-1">arrow_forward</span>
            </a>
          </div>
        </div>

        <div th:if="${completedProcesses != null and !completedProcesses.isEmpty()}"
             class="overflow-x-auto">
          <table class="w-full min-w-[560px]">
            <thead>
            <tr class="bg-gray-50 dark:bg-gray-700 text-xs font-semibold uppercase tracking-wider text-gray-600 dark:text-gray-300">
              <th class="px-4 md:px-6 py-3 text-left">Period</th>
              <th class="px-4 md:px-6 py-3 text-left">Employees</th>
              <th class="px-4 md:px-6 py-3 text-right">Net Pay (â‚¦)</th>
              <th class="px-4 md:px-6 py-3 text-left">Locked on</th>
              <th class="px-4 md:px-6 py-3 text-center">Status</th>
              <th class="px-4 md:px-6 py-3 text-right">Action</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            <tr th:each="process, stat : ${completedProcesses}"
                th:if="${stat.index < 5}"
                th:with="vars=${process.processVariables}"
                class="hover:bg-gray-50 dark:hover:bg-gray-750">
              <td class="px-4 md:px-6 py-4 font-medium"
                  th:text="${vars['periodStart'] != null
                                            ? #temporals.format(vars['periodStart'], 'MMMM yyyy')
                                            : 'â€”'}">â€”</td>
              <td class="px-4 md:px-6 py-4"
                  th:text="${vars['employeeCount'] ?: 'â€”'}">â€”</td>
              <td class="px-4 md:px-6 py-4 text-right font-medium"
                  th:text="${vars['reconNet'] != null
                                            ? #numbers.formatDecimal(vars['reconNet'], 1, 'COMMA', 0, 'POINT')
                                            : 'â€”'}">â€”</td>
              <td class="px-4 md:px-6 py-4 text-gray-500 dark:text-gray-400"
                  th:text="${process.endTime != null
                                            ? #dates.format(process.endTime, 'dd MMM yyyy')
                                            : 'â€”'}">â€”</td>
              <td class="px-4 md:px-6 py-4 text-center">
                                <span class="badge badge-success inline-flex items-center gap-1">
                                    <span class="material-icons-round" style="font-size:11px">lock</span> locked
                                </span>
              </td>
              <td class="px-4 md:px-6 py-4 text-right">
                <a th:href="@{/finance/lockedPeriods}"
                   class="text-primary-600 hover:text-primary-800 text-sm font-medium">View</a>
              </td>
            </tr>
            </tbody>
          </table>
          <div class="p-3 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-500 dark:text-gray-400 flex justify-between items-center">
            <span th:text="'Showing up to 5 of ' + ${#lists.size(completedProcesses)} + ' locked period(s)'">Showing periods</span>
            <span>ðŸ”’ Total locked: <span th:text="${#lists.size(completedProcesses)}">0</span></span>
          </div>
        </div>

        <div th:unless="${completedProcesses != null and !completedProcesses.isEmpty()}"
             class="p-10 text-center">
          <span class="material-icons-round text-5xl text-gray-300 dark:text-gray-600 block mb-3">inventory_2</span>
          <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">No locked periods yet</p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Periods that have been locked will appear here.</p>
        </div>
      </div>
    </div>


    <!-- Right column (1/3) -->
    <div class="space-y-6">

      <!-- Pending request detail card -->
      <div th:if="${approvalRequests != null and !approvalRequests.isEmpty()}"
           th:with="req=${approvalRequests[0]}, vars=${approvalRequests[0].variables}"
           class="bg-white dark:bg-gray-800 rounded-xl border border-amber-200 dark:border-amber-800 p-5">
        <div class="flex items-center space-x-2 mb-4">
          <span class="material-icons-round text-amber-500">warning</span>
          <h4 class="font-semibold">Action required</h4>
        </div>
        <div class="space-y-2 text-sm mb-4">
          <div class="flex justify-between">
            <span class="text-gray-500">Period</span>
            <span class="font-medium"
                  th:text="${vars['periodStart'] != null
                                          ? #temporals.format(vars['periodStart'], 'MMMM yyyy')
                                          : 'â€”'}">â€”</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">Employees</span>
            <span class="font-medium" th:text="${vars['employeeCount'] ?: 'â€”'}">â€”</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">Gross pay</span>
            <span class="font-medium"
                  th:text="${vars['totalGross'] != null
                                          ? 'â‚¦' + #numbers.formatDecimal(vars['totalGross'], 1, 'COMMA', 2, 'POINT')
                                          : 'â€”'}">â€”</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">Deductions</span>
            <span class="font-medium"
                  th:text="${vars['totalDeductions'] != null
                                          ? 'â‚¦' + #numbers.formatDecimal(vars['totalDeductions'], 1, 'COMMA', 2, 'POINT')
                                          : 'â€”'}">â€”</span>
          </div>
          <div class="flex justify-between font-semibold pt-2 border-t border-gray-200 dark:border-gray-700">
            <span>Net pay</span>
            <span class="text-primary-600"
                  th:text="${vars['totalNet'] != null
                                          ? 'â‚¦' + #numbers.formatDecimal(vars['totalNet'], 1, 'COMMA', 2, 'POINT')
                                          : 'â€”'}">â€”</span>
          </div>
        </div>
        <p class="text-xs text-gray-400 dark:text-gray-500 mb-3"
           th:text="'Submitted ' + ${#temporals.format(req.createdTime, 'dd MMM yyyy, HH:mm')}">â€”</p>
        <a th:href="@{/finance/lock-approval}"
           class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors">
          <span class="material-icons-round text-sm">rate_review</span> Review request
        </a>
      </div>

      <!-- All clear (no pending) -->
      <div th:unless="${approvalRequests != null and !approvalRequests.isEmpty()}"
           class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
        <div class="flex items-center space-x-2 mb-3">
          <span class="material-icons-round text-green-500">check_circle</span>
          <h4 class="font-semibold">All caught up</h4>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400">No lock requests pending. Check back after HR submits the next payroll run.</p>
      </div>


      <!-- Request timeline (for first pending request) -->
      <div th:if="${approvalRequests != null and !approvalRequests.isEmpty()}"
           class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
        <div class="flex items-center space-x-2 mb-4">
          <span class="material-icons-round text-primary-600">schedule</span>
          <h4 class="font-semibold">Request timeline</h4>
        </div>
        <div class="space-y-3">
          <div class="flex items-start space-x-3">
            <div class="w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mt-0.5">
              <span class="material-icons-round text-green-600 text-xs">check</span>
            </div>
            <div>
              <p class="text-sm font-medium">HR submitted request</p>
              <p class="text-xs text-gray-500"
                 th:text="${#temporals.format(approvalRequests[0].createdTime, 'dd MMM yyyy, HH:mm')}">â€”</p>
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <div class="w-5 h-5 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mt-0.5">
              <span class="material-icons-round text-blue-600 text-xs">visibility</span>
            </div>
            <div>
              <p class="text-sm font-medium">Pending your review</p>
              <p class="text-xs text-gray-500">Action required</p>
            </div>
          </div>
          <div class="flex items-start space-x-3 opacity-40">
            <div class="w-5 h-5 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mt-0.5">
              <span class="material-icons-round text-gray-400 text-xs">lock</span>
            </div>
            <div>
              <p class="text-sm font-medium">Period locked</p>
              <p class="text-xs text-gray-500">Pending approval</p>
            </div>
          </div>
        </div>
      </div>


      <!-- Quick actions -->
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5">
        <h4 class="font-semibold mb-4">Quick actions</h4>
        <div class="grid grid-cols-2 gap-3">
          <a th:href="@{/finance/lock-approval}"
             class="p-3 border border-gray-200 dark:border-gray-700 rounded-lg text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <span class="material-icons-round text-primary-600 block">lock</span>
            <p class="text-xs mt-1">Review locks</p>
            <span th:if="${approvalRequests != null and !approvalRequests.isEmpty()}"
                  class="badge badge-warning mt-1 text-[0.6rem]"
                  th:text="${approvalRequests.size()} + ' pending'"></span>
          </a>
          <a th:href="@{/finance/bank-details}"
             class="p-3 border border-gray-200 dark:border-gray-700 rounded-lg text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <span class="material-icons-round text-green-600 block">account_balance</span>
            <p class="text-xs mt-1">Bank details</p>
          </a>
          <a th:href="@{/finance/journals}"
             class="p-3 border border-gray-200 dark:border-gray-700 rounded-lg text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <span class="material-icons-round text-purple-600 block">receipt_long</span>
            <p class="text-xs mt-1">Journals</p>
          </a>
          <a th:href="@{/finance/lockedPeriods}"
             class="p-3 border border-gray-200 dark:border-gray-700 rounded-lg text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <span class="material-icons-round text-amber-600 block">archive</span>
            <p class="text-xs mt-1">Archive</p>
            <span th:if="${completedProcesses != null}"
                  class="text-[0.65rem] text-gray-400 mt-0.5 block"
                  th:text="${#lists.size(completedProcesses)} + ' periods'">0 periods</span>
          </a>
        </div>
      </div>
    </div>
  </div>


  <script>
    const menuToggle    = document.getElementById('menuToggle');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const sidebar       = document.querySelector('.sidebar-container');

    menuToggle?.addEventListener('click', () => {
        sidebar.classList.toggle('open');
        mobileOverlay?.classList.toggle('hidden');
        document.body.style.overflow = sidebar?.classList.contains('open') ? 'hidden' : 'auto';
    });
    mobileOverlay?.addEventListener('click', () => {
        sidebar?.classList.remove('open');
        mobileOverlay.classList.add('hidden');
        document.body.style.overflow = 'auto';
    });

    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        const themeIcon = themeToggle.querySelector('.material-icons-round');
        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
        if (localStorage.getItem('theme') === 'dark' ||
            (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeIcon.textContent = 'light_mode';
        }
    }

    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', function (e) {
            if (this.getAttribute('href') === '#') e.preventDefault();
            document.querySelectorAll('.sidebar-item').forEach(n => n.classList.remove('active'));
            this.classList.add('active');
            if (window.innerWidth < 1024 && sidebar) {
                sidebar.classList.remove('open');
                mobileOverlay?.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        });
    });

    window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024 && sidebar) {
            sidebar.classList.remove('open');
            mobileOverlay?.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    });
  </script>
</main>
</body>
</html>