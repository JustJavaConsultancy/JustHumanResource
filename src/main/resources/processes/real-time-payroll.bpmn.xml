<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://javajava.tech/payroll">

    <process id="realTimePayrollProcess"
             name="Real Time Payroll Process"
             isExecutable="true">

        <startEvent id="startPayroll">
            <extensionElements>
                <flowable:eventListener
                        eventType="start"
                        delegateExpression="${auditStartListener}"/>
            </extensionElements>
        </startEvent>

        <serviceTask id="initializePayroll"
                     name="Initialize Payroll"
                     flowable:class="javajava.tech.workflow.delegate.InitializePayrollDelegate"/>

        <serviceTask id="calculateEarnings"
                     name="Calculate Earnings"
                     flowable:class="javajava.tech.workflow.delegate.CalculateEarningsDelegate"/>

        <serviceTask id="applyStatutory"
                     name="Apply PAYE & Pension"
                     flowable:class="javajava.tech.workflow.delegate.ApplyStatutoryDelegate"/>

        <exclusiveGateway id="approvalRequired"/>

        <serviceTask id="autoFinalize"
                     name="Finalize Payroll"
                     flowable:class="javajava.tech.workflow.delegate.FinalizePayrollDelegate"/>

        <callActivity id="approvalProcess"
                      calledElement="payrollApprovalProcess"/>

        <endEvent id="endPayroll"/>

        <!-- FLOWS -->
        <sequenceFlow sourceRef="startPayroll" targetRef="initializePayroll"/>
        <sequenceFlow sourceRef="initializePayroll" targetRef="calculateEarnings"/>
        <sequenceFlow sourceRef="calculateEarnings" targetRef="applyStatutory"/>
        <sequenceFlow sourceRef="applyStatutory" targetRef="approvalRequired"/>

        <sequenceFlow sourceRef="approvalRequired" targetRef="autoFinalize">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalRequired == false}
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow sourceRef="approvalRequired" targetRef="approvalProcess">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalRequired == true}
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow sourceRef="autoFinalize" targetRef="endPayroll"/>
        <sequenceFlow sourceRef="approvalProcess" targetRef="endPayroll"/>

    </process>
</definitions>
